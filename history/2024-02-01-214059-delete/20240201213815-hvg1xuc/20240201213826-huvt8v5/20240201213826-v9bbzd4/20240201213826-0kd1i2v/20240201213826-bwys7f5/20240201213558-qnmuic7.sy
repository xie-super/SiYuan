{"ID":"20240201213558-qnmuic7","Spec":"1","Type":"NodeDocument","Properties":{"id":"20240201213558-qnmuic7","title":"redis-common-blocking-problems-summary","updated":"20240201213558"},"Children":[{"ID":"20240201213559-2jyej21","Type":"NodeThematicBreak","Properties":{"id":"20240201213559-2jyej21","updated":"20240201213559"}},{"ID":"20240201213560-cge07gh","Type":"NodeParagraph","Properties":{"id":"20240201213560-cge07gh","updated":"20240201213560"},"Children":[{"Type":"NodeText","Data":"title: Redis常见阻塞原因总结"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"category: 数据库"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"tag:"}]},{"ID":"20240201213561-58k4t4a","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213561-58k4t4a","updated":"20240201213561"},"Children":[{"ID":"20240201213562-5txy6l4","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213562-5txy6l4","updated":"20240201213562"},"Children":[{"ID":"20240201213563-m3h8usu","Type":"NodeParagraph","Properties":{"id":"20240201213563-m3h8usu","updated":"20240201213563"},"Children":[{"Type":"NodeText","Data":"Redis"}]}]}]},{"ID":"20240201213564-euyj76h","Type":"NodeThematicBreak","Properties":{"id":"20240201213564-euyj76h","updated":"20240201213564"}},{"ID":"20240201213565-dzzzpvs","Type":"NodeBlockquote","Properties":{"id":"20240201213565-dzzzpvs","updated":"20240201213565"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e ","Properties":{"id":""}},{"ID":"20240201213566-a33gjwz","Type":"NodeParagraph","Properties":{"id":"20240201213566-a33gjwz","updated":"20240201213566"},"Children":[{"Type":"NodeText","Data":"本文整理完善自："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://mp.weixin.qq.com/s/0Nqfq_eQrUb12QH6eBbHXA","TextMarkTextContent":"https://mp.weixin.qq.com/s/0Nqfq_eQrUb12QH6eBbHXA"},{"Type":"NodeText","Data":" ，作者：阿 Q 说代码"}]}]},{"ID":"20240201213567-xwfvyfs","Type":"NodeParagraph","Properties":{"id":"20240201213567-xwfvyfs","updated":"20240201213567"},"Children":[{"Type":"NodeText","Data":"这篇文章会详细总结一下可能导致 Redis 阻塞的情况，这些情况也是影响 Redis 性能的关键因素，使用 Redis 的时候应该格外注意！"}]},{"ID":"20240201213568-g1zew62","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213568-g1zew62","updated":"20240201213568"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"O(n) 命令"}]},{"ID":"20240201213569-rmuuirr","Type":"NodeParagraph","Properties":{"id":"20240201213569-rmuuirr","updated":"20240201213569"},"Children":[{"Type":"NodeText","Data":"Redis 中的大部分命令都是 O(1)时间复杂度，但也有少部分 O(n) 时间复杂度的命令，例如："}]},{"ID":"20240201213570-m5d19mz","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213570-m5d19mz","updated":"20240201213570"},"Children":[{"ID":"20240201213571-qjxlkzg","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213571-qjxlkzg","updated":"20240201213571"},"Children":[{"ID":"20240201213572-14wd1kf","Type":"NodeParagraph","Properties":{"id":"20240201213572-14wd1kf","updated":"20240201213572"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"KEYS *"},{"Type":"NodeText","Data":"：会返回所有符合规则的 key。"}]}]},{"ID":"20240201213573-bwgivwi","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213573-bwgivwi","updated":"20240201213573"},"Children":[{"ID":"20240201213574-qacry4h","Type":"NodeParagraph","Properties":{"id":"20240201213574-qacry4h","updated":"20240201213574"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"HGETALL"},{"Type":"NodeText","Data":"：会返回一个 Hash 中所有的键值对。"}]}]},{"ID":"20240201213575-ltbj5rm","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213575-ltbj5rm","updated":"20240201213575"},"Children":[{"ID":"20240201213576-qpvryiw","Type":"NodeParagraph","Properties":{"id":"20240201213576-qpvryiw","updated":"20240201213576"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"LRANGE"},{"Type":"NodeText","Data":"：会返回 List 中指定范围内的元素。"}]}]},{"ID":"20240201213577-fmq0y4x","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213577-fmq0y4x","updated":"20240201213577"},"Children":[{"ID":"20240201213578-q4oa9p0","Type":"NodeParagraph","Properties":{"id":"20240201213578-q4oa9p0","updated":"20240201213578"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"SMEMBERS"},{"Type":"NodeText","Data":"：返回 Set 中的所有元素。"}]}]},{"ID":"20240201213579-hiqejil","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213579-hiqejil","updated":"20240201213579"},"Children":[{"ID":"20240201213580-ora82dn","Type":"NodeParagraph","Properties":{"id":"20240201213580-ora82dn","updated":"20240201213580"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"SINTER"},{"Type":"NodeText","Data":"/"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"SUNION"},{"Type":"NodeText","Data":"/"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"SDIFF"},{"Type":"NodeText","Data":"：计算多个 Set 的交集/并集/差集。"}]}]},{"ID":"20240201213581-msgojna","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213581-msgojna","updated":"20240201213581"},"Children":[{"ID":"20240201213582-10o16nb","Type":"NodeParagraph","Properties":{"id":"20240201213582-10o16nb","updated":"20240201213582"},"Children":[{"Type":"NodeText","Data":"……"}]}]}]},{"ID":"20240201213583-k0spq1c","Type":"NodeParagraph","Properties":{"id":"20240201213583-k0spq1c","updated":"20240201213583"},"Children":[{"Type":"NodeText","Data":"由于这些命令时间复杂度是 O(n)，有时候也会全表扫描，随着 n 的增大，执行耗时也会越长，从而导致客户端阻塞。不过， 这些命令并不是一定不能使用，但是需要明确 N 的值。另外，有遍历的需求可以使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"HSCAN"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"SSCAN"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ZSCAN"},{"Type":"NodeText","Data":" 代替。"}]},{"ID":"20240201213584-9gdsizv","Type":"NodeParagraph","Properties":{"id":"20240201213584-9gdsizv","updated":"20240201213584"},"Children":[{"Type":"NodeText","Data":"除了这些 O(n)时间复杂度的命令可能会导致阻塞之外， 还有一些时间复杂度可能在 O(N) 以上的命令，例如："}]},{"ID":"20240201213585-v4sm0lh","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213585-v4sm0lh","updated":"20240201213585"},"Children":[{"ID":"20240201213586-v7m4fny","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213586-v7m4fny","updated":"20240201213586"},"Children":[{"ID":"20240201213587-0sqk510","Type":"NodeParagraph","Properties":{"id":"20240201213587-0sqk510","updated":"20240201213587"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ZRANGE"},{"Type":"NodeText","Data":"/"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ZREVRANGE"},{"Type":"NodeText","Data":"：返回指定 Sorted Set 中指定排名范围内的所有元素。时间复杂度为 O(log(n)+m)，n 为所有元素的数量， m 为返回的元素数量，当 m 和 n 相当大时，O(n) 的时间复杂度更小。"}]}]},{"ID":"20240201213588-5cxgxf2","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213588-5cxgxf2","updated":"20240201213588"},"Children":[{"ID":"20240201213589-n5buon3","Type":"NodeParagraph","Properties":{"id":"20240201213589-n5buon3","updated":"20240201213589"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ZREMRANGEBYRANK"},{"Type":"NodeText","Data":"/"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ZREMRANGEBYSCORE"},{"Type":"NodeText","Data":"：移除 Sorted Set 中指定排名范围/指定 score 范围内的所有元素。时间复杂度为 O(log(n)+m)，n 为所有元素的数量， m 被删除元素的数量，当 m 和 n 相当大时，O(n) 的时间复杂度更小。"}]}]},{"ID":"20240201213590-0l7juem","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213590-0l7juem","updated":"20240201213590"},"Children":[{"ID":"20240201213591-kb1kh4j","Type":"NodeParagraph","Properties":{"id":"20240201213591-kb1kh4j","updated":"20240201213591"},"Children":[{"Type":"NodeText","Data":"……"}]}]}]},{"ID":"20240201213592-z420swy","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213592-z420swy","updated":"20240201213592"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"SAVE 创建 RDB 快照"}]},{"ID":"20240201213593-vym35zg","Type":"NodeParagraph","Properties":{"id":"20240201213593-vym35zg","updated":"20240201213593"},"Children":[{"Type":"NodeText","Data":"Redis 提供了两个命令来生成 RDB 快照文件："}]},{"ID":"20240201213594-sj76sqy","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213594-sj76sqy","updated":"20240201213594"},"Children":[{"ID":"20240201213595-xemg93q","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213595-xemg93q","updated":"20240201213595"},"Children":[{"ID":"20240201213596-1rhbm8d","Type":"NodeParagraph","Properties":{"id":"20240201213596-1rhbm8d","updated":"20240201213596"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"save"},{"Type":"NodeText","Data":" : 同步保存操作，会阻塞 Redis 主线程；"}]}]},{"ID":"20240201213597-tl7473l","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213597-tl7473l","updated":"20240201213597"},"Children":[{"ID":"20240201213598-ejis9yh","Type":"NodeParagraph","Properties":{"id":"20240201213598-ejis9yh","updated":"20240201213598"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"bgsave"},{"Type":"NodeText","Data":" : fork 出一个子进程，子进程执行，不会阻塞 Redis 主线程，默认选项。"}]}]}]},{"ID":"20240201213599-mcqmjdj","Type":"NodeParagraph","Properties":{"id":"20240201213599-mcqmjdj","updated":"20240201213599"},"Children":[{"Type":"NodeText","Data":"默认情况下，Redis 默认配置会使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"bgsave"},{"Type":"NodeText","Data":" 命令。如果手动使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"save"},{"Type":"NodeText","Data":" 命令生成 RDB 快照文件的话，就会阻塞主线程。"}]},{"ID":"20240201213600-bjfw0l3","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213600-bjfw0l3","updated":"20240201213600"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"AOF"}]},{"ID":"20240201213601-1c67k85","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213601-1c67k85","updated":"20240201213601"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"AOF 日志记录阻塞"}]},{"ID":"20240201213602-l7lunwq","Type":"NodeParagraph","Properties":{"id":"20240201213602-l7lunwq","updated":"20240201213602"},"Children":[{"Type":"NodeText","Data":"Redis AOF 持久化机制是在执行完命令之后再记录日志，这和关系型数据库（如 MySQL）通常都是执行命令之前记录日志（方便故障恢复）不同。"}]},{"ID":"20240201213603-whno6z8","Type":"NodeParagraph","Properties":{"id":"20240201213603-whno6z8","updated":"20240201213603"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"AOF 记录日志过程","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/redis/redis-aof-write-log-disc.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213604-25183zo","Type":"NodeParagraph","Properties":{"id":"20240201213604-25183zo","updated":"20240201213604"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"为什么是在执行完命令之后记录日志呢？"}]},{"ID":"20240201213605-c8reuw3","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213605-c8reuw3","updated":"20240201213605"},"Children":[{"ID":"20240201213606-d591ij8","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213606-d591ij8","updated":"20240201213606"},"Children":[{"ID":"20240201213607-6lj2bce","Type":"NodeParagraph","Properties":{"id":"20240201213607-6lj2bce","updated":"20240201213607"},"Children":[{"Type":"NodeText","Data":"避免额外的检查开销，AOF 记录日志不会对命令进行语法检查；"}]}]},{"ID":"20240201213608-rwyh0b0","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213608-rwyh0b0","updated":"20240201213608"},"Children":[{"ID":"20240201213609-itrukkf","Type":"NodeParagraph","Properties":{"id":"20240201213609-itrukkf","updated":"20240201213609"},"Children":[{"Type":"NodeText","Data":"在命令执行完之后再记录，不会阻塞当前的命令执行。"}]}]}]},{"ID":"20240201213610-n09od5d","Type":"NodeParagraph","Properties":{"id":"20240201213610-n09od5d","updated":"20240201213610"},"Children":[{"Type":"NodeText","Data":"这样也带来了风险（我在前面介绍 AOF 持久化的时候也提到过）："}]},{"ID":"20240201213611-e7af464","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213611-e7af464","updated":"20240201213611"},"Children":[{"ID":"20240201213612-ho0xxsy","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213612-ho0xxsy","updated":"20240201213612"},"Children":[{"ID":"20240201213613-vrf9q9g","Type":"NodeParagraph","Properties":{"id":"20240201213613-vrf9q9g","updated":"20240201213613"},"Children":[{"Type":"NodeText","Data":"如果刚执行完命令 Redis 就宕机会导致对应的修改丢失；"}]}]},{"ID":"20240201213614-cbdwl77","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213614-cbdwl77","updated":"20240201213614"},"Children":[{"ID":"20240201213615-7uxrev8","Type":"NodeParagraph","Properties":{"id":"20240201213615-7uxrev8","updated":"20240201213615"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"可能会阻塞后续其他命令的执行（AOF 记录日志是在 Redis 主线程中进行的）"},{"Type":"NodeText","Data":"。"}]}]}]},{"ID":"20240201213616-2lbs6cl","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213616-2lbs6cl","updated":"20240201213616"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"AOF 刷盘阻塞"}]},{"ID":"20240201213617-9zpvcci","Type":"NodeParagraph","Properties":{"id":"20240201213617-9zpvcci","updated":"20240201213617"},"Children":[{"Type":"NodeText","Data":"开启 AOF 持久化后每执行一条会更改 Redis 中的数据的命令，Redis 就会将该命令写入到 AOF 缓冲区 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"server.aof_buf"},{"Type":"NodeText","Data":" 中，然后再根据 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"appendfsync"},{"Type":"NodeText","Data":" 配置来决定何时将其同步到硬盘中的 AOF 文件。"}]},{"ID":"20240201213618-0bzlpap","Type":"NodeParagraph","Properties":{"id":"20240201213618-0bzlpap","updated":"20240201213618"},"Children":[{"Type":"NodeText","Data":"在 Redis 的配置文件中存在三种不同的 AOF 持久化方式（ "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":"策略），它们分别是："}]},{"ID":"20240201213619-sutmokc","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213619-sutmokc","updated":"20240201213619"},"Children":[{"ID":"20240201213620-tzwb4l9","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213620-tzwb4l9","updated":"20240201213620"},"Children":[{"ID":"20240201213621-u0irndj","Type":"NodeParagraph","Properties":{"id":"20240201213621-u0irndj","updated":"20240201213621"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"appendfsync always"},{"Type":"NodeText","Data":"：主线程调用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"write"},{"Type":"NodeText","Data":" 执行写操作后，后台线程（ "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"aof_fsync"},{"Type":"NodeText","Data":" 线程）立即会调用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":" 函数同步 AOF 文件（刷盘），"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":" 完成后线程返回，这样会严重降低 Redis 的性能（"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"write"},{"Type":"NodeText","Data":" + "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":"）。"}]}]},{"ID":"20240201213622-23zz00h","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213622-23zz00h","updated":"20240201213622"},"Children":[{"ID":"20240201213623-j9k62v5","Type":"NodeParagraph","Properties":{"id":"20240201213623-j9k62v5","updated":"20240201213623"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"appendfsync everysec"},{"Type":"NodeText","Data":"：主线程调用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"write"},{"Type":"NodeText","Data":" 执行写操作后立即返回，由后台线程（ "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"aof_fsync"},{"Type":"NodeText","Data":" 线程）每秒钟调用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":" 函数（系统调用）同步一次 AOF 文件（"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"write"},{"Type":"NodeText","Data":"+"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":"，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":"间隔为 1 秒）"}]}]},{"ID":"20240201213624-egbi83l","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213624-egbi83l","updated":"20240201213624"},"Children":[{"ID":"20240201213625-pjowrck","Type":"NodeParagraph","Properties":{"id":"20240201213625-pjowrck","updated":"20240201213625"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"appendfsync no"},{"Type":"NodeText","Data":"：主线程调用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"write"},{"Type":"NodeText","Data":" 执行写操作后立即返回，让操作系统决定何时进行同步，Linux 下一般为 30 秒一次（"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"write"},{"Type":"NodeText","Data":"但不"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":"，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":" 的时机由操作系统决定）。"}]}]}]},{"ID":"20240201213626-zaq3vms","Type":"NodeParagraph","Properties":{"id":"20240201213626-zaq3vms","updated":"20240201213626"},"Children":[{"Type":"NodeText","Data":"当后台线程（ "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"aof_fsync"},{"Type":"NodeText","Data":" 线程）调用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":" 函数同步 AOF 文件时，需要等待，直到写入完成。当磁盘压力太大的时候，会导致 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":" 操作发生阻塞，主线程调用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"write"},{"Type":"NodeText","Data":" 函数时也会被阻塞。"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"fsync"},{"Type":"NodeText","Data":" 完成后，主线程执行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"write"},{"Type":"NodeText","Data":" 才能成功返回。"}]},{"ID":"20240201213627-zaievf4","Type":"NodeParagraph","Properties":{"id":"20240201213627-zaievf4","updated":"20240201213627"},"Children":[{"Type":"NodeText","Data":"关于 AOF 工作流程的详细介绍可以查看："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"./redis-persistence.md","TextMarkTextContent":"Redis 持久化机制详解"},{"Type":"NodeText","Data":"，有助于理解 AOF 刷盘阻塞。"}]},{"ID":"20240201213628-yrpif14","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213628-yrpif14","updated":"20240201213628"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"AOF 重写阻塞"}]},{"ID":"20240201213629-15uvopn","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213629-15uvopn","updated":"20240201213629"},"Children":[{"ID":"20240201213630-iu8ghge","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213630-iu8ghge","updated":"20240201213630"},"Children":[{"ID":"20240201213631-cl9824q","Type":"NodeParagraph","Properties":{"id":"20240201213631-cl9824q","updated":"20240201213631"},"Children":[{"Type":"NodeText","Data":"fork 出一条子线程来将文件重写，在执行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"BGREWRITEAOF"},{"Type":"NodeText","Data":" 命令时，Redis 服务器会维护一个 AOF 重写缓冲区，该缓冲区会在子线程创建新 AOF 文件期间，记录服务器执行的所有写命令。"}]}]},{"ID":"20240201213632-m9vtcy9","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213632-m9vtcy9","updated":"20240201213632"},"Children":[{"ID":"20240201213633-nz278lb","Type":"NodeParagraph","Properties":{"id":"20240201213633-nz278lb","updated":"20240201213633"},"Children":[{"Type":"NodeText","Data":"当子线程完成创建新 AOF 文件的工作之后，服务器会将重写缓冲区中的所有内容追加到新 AOF 文件的末尾，使得新的 AOF 文件保存的数据库状态与现有的数据库状态一致。"}]}]},{"ID":"20240201213634-nazcudt","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213634-nazcudt","updated":"20240201213634"},"Children":[{"ID":"20240201213635-jp7qfx3","Type":"NodeParagraph","Properties":{"id":"20240201213635-jp7qfx3","updated":"20240201213635"},"Children":[{"Type":"NodeText","Data":"最后，服务器用新的 AOF 文件替换旧的 AOF 文件，以此来完成 AOF 文件重写操作。"}]}]}]},{"ID":"20240201213636-bvd2kau","Type":"NodeParagraph","Properties":{"id":"20240201213636-bvd2kau","updated":"20240201213636"},"Children":[{"Type":"NodeText","Data":"阻塞就是出现在第 2 步的过程中，将缓冲区中新数据写到新文件的过程中会产生"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"阻塞"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213637-8ouf8ox","Type":"NodeParagraph","Properties":{"id":"20240201213637-8ouf8ox","updated":"20240201213637"},"Children":[{"Type":"NodeText","Data":"相关阅读："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://cloud.tencent.com/developer/article/1633077","TextMarkTextContent":"Redis AOF 重写阻塞问题分析"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213638-l1zjo6z","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213638-l1zjo6z","updated":"20240201213638"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"大 Key"}]},{"ID":"20240201213639-rqned88","Type":"NodeParagraph","Properties":{"id":"20240201213639-rqned88","updated":"20240201213639"},"Children":[{"Type":"NodeText","Data":"如果一个 key 对应的 value 所占用的内存比较大，那这个 key 就可以看作是 bigkey。具体多大才算大呢？有一个不是特别精确的参考标准："}]},{"ID":"20240201213640-5hbos86","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213640-5hbos86","updated":"20240201213640"},"Children":[{"ID":"20240201213641-61iiipm","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213641-61iiipm","updated":"20240201213641"},"Children":[{"ID":"20240201213642-k2bb0zl","Type":"NodeParagraph","Properties":{"id":"20240201213642-k2bb0zl","updated":"20240201213642"},"Children":[{"Type":"NodeText","Data":"string 类型的 value 超过 1MB"}]}]},{"ID":"20240201213643-oor507n","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213643-oor507n","updated":"20240201213643"},"Children":[{"ID":"20240201213644-ctt9hdw","Type":"NodeParagraph","Properties":{"id":"20240201213644-ctt9hdw","updated":"20240201213644"},"Children":[{"Type":"NodeText","Data":"复合类型（列表、哈希、集合、有序集合等）的 value 包含的元素超过 5000 个（对于复合类型的 value 来说，不一定包含的元素越多，占用的内存就越多）。"}]}]}]},{"ID":"20240201213645-56x3wby","Type":"NodeParagraph","Properties":{"id":"20240201213645-56x3wby","updated":"20240201213645"},"Children":[{"Type":"NodeText","Data":"大 key 造成的阻塞问题如下："}]},{"ID":"20240201213646-bp9a3u1","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213646-bp9a3u1","updated":"20240201213646"},"Children":[{"ID":"20240201213647-b2c3n7e","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213647-b2c3n7e","updated":"20240201213647"},"Children":[{"ID":"20240201213648-t4qokve","Type":"NodeParagraph","Properties":{"id":"20240201213648-t4qokve","updated":"20240201213648"},"Children":[{"Type":"NodeText","Data":"客户端超时阻塞：由于 Redis 执行命令是单线程处理，然后在操作大 key 时会比较耗时，那么就会阻塞 Redis，从客户端这一视角看，就是很久很久都没有响应。"}]}]},{"ID":"20240201213649-romz8ym","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213649-romz8ym","updated":"20240201213649"},"Children":[{"ID":"20240201213650-lmbd5b5","Type":"NodeParagraph","Properties":{"id":"20240201213650-lmbd5b5","updated":"20240201213650"},"Children":[{"Type":"NodeText","Data":"引发网络阻塞：每次获取大 key 产生的网络流量较大，如果一个 key 的大小是 1 MB，每秒访问量为 1000，那么每秒会产生 1000MB 的流量，这对于普通千兆网卡的服务器来说是灾难性的。"}]}]},{"ID":"20240201213651-lyda5vo","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213651-lyda5vo","updated":"20240201213651"},"Children":[{"ID":"20240201213652-kxvb9qp","Type":"NodeParagraph","Properties":{"id":"20240201213652-kxvb9qp","updated":"20240201213652"},"Children":[{"Type":"NodeText","Data":"阻塞工作线程：如果使用 del 删除大 key 时，会阻塞工作线程，这样就没办法处理后续的命令。"}]}]}]},{"ID":"20240201213653-5y3zqv9","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213653-5y3zqv9","updated":"20240201213653"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"查找大 key"}]},{"ID":"20240201213654-tv1wwh0","Type":"NodeParagraph","Properties":{"id":"20240201213654-tv1wwh0","updated":"20240201213654"},"Children":[{"Type":"NodeText","Data":"当我们在使用 Redis 自带的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"--bigkeys"},{"Type":"NodeText","Data":" 参数查找大 key 时，最好选择在从节点上执行该命令，因为主节点上执行时，会"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"阻塞"},{"Type":"NodeText","Data":"主节点。"}]},{"ID":"20240201213655-8qdpeue","Type":"NodeList","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213655-8qdpeue","updated":"20240201213655"},"Children":[{"ID":"20240201213656-tjytt5u","Type":"NodeListItem","Data":"-","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213656-tjytt5u","updated":"20240201213656"},"Children":[{"ID":"20240201213657-42exe7z","Type":"NodeParagraph","Properties":{"id":"20240201213657-42exe7z","updated":"20240201213657"},"Children":[{"Type":"NodeText","Data":"我们还可以使用 SCAN 命令来查找大 key；"}]}]},{"ID":"20240201213658-wlkrurn","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213658-wlkrurn","updated":"20240201213658"},"Children":[{"ID":"20240201213659-g3nm9mb","Type":"NodeParagraph","Properties":{"id":"20240201213659-g3nm9mb","updated":"20240201213659"},"Children":[{"Type":"NodeText","Data":"通过分析 RDB 文件来找出 big key，这种方案的前提是 Redis 采用的是 RDB 持久化。网上有现成的工具："}]}]},{"ID":"20240201213660-084db9z","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213660-084db9z","updated":"20240201213660"},"Children":[{"ID":"20240201213661-kkotorh","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213661-kkotorh","updated":"20240201213661"},"Children":[{"ID":"20240201213662-ljg3ub0","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213662-ljg3ub0","updated":"20240201213662"},"Children":[{"ID":"20240201213663-zef7u8d","Type":"NodeParagraph","Properties":{"id":"20240201213663-zef7u8d","updated":"20240201213663"},"Children":[{"Type":"NodeText","Data":"redis-rdb-tools：Python 语言写的用来分析 Redis 的 RDB 快照文件用的工具"}]}]},{"ID":"20240201213664-6pt7utv","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213664-6pt7utv","updated":"20240201213664"},"Children":[{"ID":"20240201213665-eb5j19h","Type":"NodeParagraph","Properties":{"id":"20240201213665-eb5j19h","updated":"20240201213665"},"Children":[{"Type":"NodeText","Data":"rdb_bigkeys：Go 语言写的用来分析 Redis 的 RDB 快照文件用的工具，性能更好。"}]}]}]}]}]},{"ID":"20240201213666-ge8m692","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213666-ge8m692","updated":"20240201213666"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"删除大 key"}]},{"ID":"20240201213667-y5ymsd2","Type":"NodeParagraph","Properties":{"id":"20240201213667-y5ymsd2","updated":"20240201213667"},"Children":[{"Type":"NodeText","Data":"删除操作的本质是要释放键值对占用的内存空间。"}]},{"ID":"20240201213668-njj95xe","Type":"NodeParagraph","Properties":{"id":"20240201213668-njj95xe","updated":"20240201213668"},"Children":[{"Type":"NodeText","Data":"释放内存只是第一步，为了更加高效地管理内存空间，在应用程序释放内存时，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"操作系统需要把释放掉的内存块插入一个空闲内存块的链表"},{"Type":"NodeText","Data":"，以便后续进行管理和再分配。这个过程本身需要一定时间，而且会"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"阻塞"},{"Type":"NodeText","Data":"当前释放内存的应用程序。"}]},{"ID":"20240201213669-wl49zqk","Type":"NodeParagraph","Properties":{"id":"20240201213669-wl49zqk","updated":"20240201213669"},"Children":[{"Type":"NodeText","Data":"所以，如果一下子释放了大量内存，空闲内存块链表操作时间就会增加，相应地就会造成 Redis 主线程的阻塞，如果主线程发生了阻塞，其他所有请求可能都会超时，超时越来越多，会造成 Redis 连接耗尽，产生各种异常。"}]},{"ID":"20240201213670-bh505kd","Type":"NodeParagraph","Properties":{"id":"20240201213670-bh505kd","updated":"20240201213670"},"Children":[{"Type":"NodeText","Data":"删除大 key 时建议采用分批次删除和异步删除的方式进行。"}]},{"ID":"20240201213671-573idjk","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213671-573idjk","updated":"20240201213671"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"清空数据库"}]},{"ID":"20240201213672-6csiw6o","Type":"NodeParagraph","Properties":{"id":"20240201213672-6csiw6o","updated":"20240201213672"},"Children":[{"Type":"NodeText","Data":"清空数据库和上面 bigkey 删除也是同样道理，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"flushdb"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"flushall"},{"Type":"NodeText","Data":" 也涉及到删除和释放所有的键值对，也是 Redis 的阻塞点。"}]},{"ID":"20240201213673-f5lqz4c","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213673-f5lqz4c","updated":"20240201213673"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"集群扩容"}]},{"ID":"20240201213674-0fiil85","Type":"NodeParagraph","Properties":{"id":"20240201213674-0fiil85","updated":"20240201213674"},"Children":[{"Type":"NodeText","Data":"Redis 集群可以进行节点的动态扩容缩容，这一过程目前还处于半自动状态，需要人工介入。"}]},{"ID":"20240201213675-fh0ntop","Type":"NodeParagraph","Properties":{"id":"20240201213675-fh0ntop","updated":"20240201213675"},"Children":[{"Type":"NodeText","Data":"在扩缩容的时候，需要进行数据迁移。而 Redis 为了保证迁移的一致性，迁移所有操作都是同步操作。"}]},{"ID":"20240201213676-99pshv9","Type":"NodeParagraph","Properties":{"id":"20240201213676-99pshv9","updated":"20240201213676"},"Children":[{"Type":"NodeText","Data":"执行迁移时，两端的 Redis 均会进入时长不等的阻塞状态，对于小 Key，该时间可以忽略不计，但如果一旦 Key 的内存使用过大，严重的时候会触发集群内的故障转移，造成不必要的切换。"}]},{"ID":"20240201213677-jrk4hh0","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213677-jrk4hh0","updated":"20240201213677"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"Swap（内存交换）"}]},{"ID":"20240201213678-ygupmd2","Type":"NodeParagraph","Properties":{"id":"20240201213678-ygupmd2","updated":"20240201213678"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"什么是 Swap？"},{"Type":"NodeText","Data":" Swap 直译过来是交换的意思，Linux 中的 Swap 常被称为内存交换或者交换分区。类似于 Windows 中的虚拟内存，就是当内存不足的时候，把一部分硬盘空间虚拟成内存使用，从而解决内存容量不足的情况。因此，Swap 分区的作用就是牺牲硬盘，增加内存，解决 VPS 内存不够用或者爆满的问题。"}]},{"ID":"20240201213679-x89awtv","Type":"NodeParagraph","Properties":{"id":"20240201213679-x89awtv","updated":"20240201213679"},"Children":[{"Type":"NodeText","Data":"Swap 对于 Redis 来说是非常致命的，Redis 保证高性能的一个重要前提是所有的数据在内存中。如果操作系统把 Redis 使用的部分内存换出硬盘，由于内存与硬盘的读写速度差几个数量级，会导致发生交换后的 Redis 性能急剧下降。"}]},{"ID":"20240201213680-jbu75ow","Type":"NodeParagraph","Properties":{"id":"20240201213680-jbu75ow","updated":"20240201213680"},"Children":[{"Type":"NodeText","Data":"识别 Redis 发生 Swap 的检查方法如下："}]},{"ID":"20240201213681-hzu7o35","Type":"NodeParagraph","Properties":{"id":"20240201213681-hzu7o35","updated":"20240201213681"},"Children":[{"Type":"NodeText","Data":"1、查询 Redis 进程号"}]},{"ID":"20240201213682-ha6yge5","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"YmFzaA==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213682-ha6yge5","updated":"20240201213682"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YmFzaA==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"reids-cli -p 6383 info server | grep process_id\nprocess_id: 4476\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213683-zum80c8","Type":"NodeParagraph","Properties":{"id":"20240201213683-zum80c8","updated":"20240201213683"},"Children":[{"Type":"NodeText","Data":"2、根据进程号查询内存交换信息"}]},{"ID":"20240201213684-jhadng7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"YmFzaA==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213684-jhadng7","updated":"20240201213684"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YmFzaA==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"cat /proc/4476/smaps | grep Swap\nSwap: 0kB\nSwap: 0kB\nSwap: 4kB\nSwap: 0kB\nSwap: 0kB\n.....\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213685-jo8fb7j","Type":"NodeParagraph","Properties":{"id":"20240201213685-jo8fb7j","updated":"20240201213685"},"Children":[{"Type":"NodeText","Data":"如果交换量都是 0KB 或者个别的是 4KB，则正常。"}]},{"ID":"20240201213686-re2nxo4","Type":"NodeParagraph","Properties":{"id":"20240201213686-re2nxo4","updated":"20240201213686"},"Children":[{"Type":"NodeText","Data":"预防内存交换的方法："}]},{"ID":"20240201213687-f6hfu3h","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213687-f6hfu3h","updated":"20240201213687"},"Children":[{"ID":"20240201213688-omxdk9j","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213688-omxdk9j","updated":"20240201213688"},"Children":[{"ID":"20240201213689-c6ozlds","Type":"NodeParagraph","Properties":{"id":"20240201213689-c6ozlds","updated":"20240201213689"},"Children":[{"Type":"NodeText","Data":"保证机器充足的可用内存"}]}]},{"ID":"20240201213690-zsa0jnz","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213690-zsa0jnz","updated":"20240201213690"},"Children":[{"ID":"20240201213691-cv5h3so","Type":"NodeParagraph","Properties":{"id":"20240201213691-cv5h3so","updated":"20240201213691"},"Children":[{"Type":"NodeText","Data":"确保所有 Redis 实例设置最大可用内存(maxmemory)，防止极端情况 Redis 内存不可控的增长"}]}]},{"ID":"20240201213692-22420el","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213692-22420el","updated":"20240201213692"},"Children":[{"ID":"20240201213693-tmq6ber","Type":"NodeParagraph","Properties":{"id":"20240201213693-tmq6ber","updated":"20240201213693"},"Children":[{"Type":"NodeText","Data":"降低系统使用 swap 优先级，如"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"echo 10 \u0026gt; /proc/sys/vm/swappiness"}]}]}]},{"ID":"20240201213694-hyf7yr1","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213694-hyf7yr1","updated":"20240201213694"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"CPU 竞争"}]},{"ID":"20240201213695-y74ujee","Type":"NodeParagraph","Properties":{"id":"20240201213695-y74ujee","updated":"20240201213695"},"Children":[{"Type":"NodeText","Data":"Redis 是典型的 CPU 密集型应用，不建议和其他多核 CPU 密集型服务部署在一起。当其他进程过度消耗 CPU 时，将严重影响 Redis 的吞吐量。"}]},{"ID":"20240201213696-124n00p","Type":"NodeParagraph","Properties":{"id":"20240201213696-124n00p","updated":"20240201213696"},"Children":[{"Type":"NodeText","Data":"可以通过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"reids-cli --stat"},{"Type":"NodeText","Data":"获取当前 Redis 使用情况。通过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"top"},{"Type":"NodeText","Data":"命令获取进程对 CPU 的利用率等信息 通过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"info commandstats"},{"Type":"NodeText","Data":"统计信息分析出命令不合理开销时间，查看是否是因为高算法复杂度或者过度的内存优化问题。"}]},{"ID":"20240201213697-w0omdvk","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213697-w0omdvk","updated":"20240201213697"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"网络问题"}]},{"ID":"20240201213698-woyj4aq","Type":"NodeParagraph","Properties":{"id":"20240201213698-woyj4aq","updated":"20240201213698"},"Children":[{"Type":"NodeText","Data":"连接拒绝、网络延迟，网卡软中断等网络问题也可能会导致 Redis 阻塞。"}]},{"ID":"20240201213699-rcrv0vh","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213699-rcrv0vh","updated":"20240201213699"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"参考"}]},{"ID":"20240201213700-q0k9vtj","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213700-q0k9vtj","updated":"20240201213700"},"Children":[{"ID":"20240201213701-5mr18pk","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213701-5mr18pk","updated":"20240201213701"},"Children":[{"ID":"20240201213702-3vjss1o","Type":"NodeParagraph","Properties":{"id":"20240201213702-3vjss1o","updated":"20240201213702"},"Children":[{"Type":"NodeText","Data":"Redis 阻塞的 6 大类场景分析与总结："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://mp.weixin.qq.com/s/eaZCEtTjTuEmXfUubVHjew","TextMarkTextContent":"https://mp.weixin.qq.com/s/eaZCEtTjTuEmXfUubVHjew"}]}]},{"ID":"20240201213703-o8p969k","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213703-o8p969k","updated":"20240201213703"},"Children":[{"ID":"20240201213704-td71a0y","Type":"NodeParagraph","Properties":{"id":"20240201213704-td71a0y","updated":"20240201213704"},"Children":[{"Type":"NodeText","Data":"Redis 开发与运维笔记-Redis 的噩梦-阻塞："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://mp.weixin.qq.com/s/TDbpz9oLH6ifVv6ewqgSgA","TextMarkTextContent":"https://mp.weixin.qq.com/s/TDbpz9oLH6ifVv6ewqgSgA"}]}]}]},{"ID":"20240201213705-lpn32sm","Type":"NodeHTMLBlock","Data":"\u003cdiv\u003e\n\u003c!-- @include: @article-footer.snippet.md --\u003e\n\u003c/div\u003e","HtmlBlockType":2,"Properties":{"id":"20240201213705-lpn32sm","updated":"20240201213705"}}]}