{"ID":"20240201213447-9d0w42x","Spec":"1","Type":"NodeDocument","Properties":{"id":"20240201213447-9d0w42x","title":"mongodb-questions-02","updated":"20240201213447"},"Children":[{"ID":"20240201213448-sw6qku9","Type":"NodeThematicBreak","Properties":{"id":"20240201213448-sw6qku9","updated":"20240201213448"}},{"ID":"20240201213449-43n5bjn","Type":"NodeParagraph","Properties":{"id":"20240201213449-43n5bjn","updated":"20240201213449"},"Children":[{"Type":"NodeText","Data":"title: MongoDB常见面试题总结（下）"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"category: 数据库"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"tag:"}]},{"ID":"20240201213450-tu1ipsu","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213450-tu1ipsu","updated":"20240201213450"},"Children":[{"ID":"20240201213451-16z5vso","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213451-16z5vso","updated":"20240201213451"},"Children":[{"ID":"20240201213452-jzgyki5","Type":"NodeParagraph","Properties":{"id":"20240201213452-jzgyki5","updated":"20240201213452"},"Children":[{"Type":"NodeText","Data":"NoSQL"}]}]},{"ID":"20240201213453-n42qxyr","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213453-n42qxyr","updated":"20240201213453"},"Children":[{"ID":"20240201213454-9xmansf","Type":"NodeParagraph","Properties":{"id":"20240201213454-9xmansf","updated":"20240201213454"},"Children":[{"Type":"NodeText","Data":"MongoDB"}]}]}]},{"ID":"20240201213455-p37ia6t","Type":"NodeThematicBreak","Properties":{"id":"20240201213455-p37ia6t","updated":"20240201213455"}},{"ID":"20240201213456-22idcg0","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213456-22idcg0","updated":"20240201213456"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"MongoDB 索引"}]},{"ID":"20240201213457-ulcq86w","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213457-ulcq86w","updated":"20240201213457"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"MongoDB 索引有什么用?"}]},{"ID":"20240201213458-c2xc3lt","Type":"NodeParagraph","Properties":{"id":"20240201213458-c2xc3lt","updated":"20240201213458"},"Children":[{"Type":"NodeText","Data":"和关系型数据库类似，MongoDB 中也有索引。索引的目的主要是用来提高查询效率，如果没有索引的话，MongoDB 必须执行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"集合扫描"},{"Type":"NodeText","Data":" ，即扫描集合中的每个文档，以选择与查询语句匹配的文档。如果查询存在合适的索引，MongoDB 可以使用该索引来限制它必须检查的文档数量。并且，MongoDB 可以使用索引中的排序返回排序后的结果。"}]},{"ID":"20240201213459-fx7cgbk","Type":"NodeParagraph","Properties":{"id":"20240201213459-fx7cgbk","updated":"20240201213459"},"Children":[{"Type":"NodeText","Data":"虽然索引可以显著缩短查询时间，但是使用索引、维护索引是有代价的。在执行写入操作时，除了要更新文档之外，还必须更新索引，这必然会影响写入的性能。因此，当有大量写操作而读操作少时，或者不考虑读操作的性能时，都不推荐建立索引。"}]},{"ID":"20240201213460-qkbs1x9","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213460-qkbs1x9","updated":"20240201213460"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"MongoDB 支持哪些类型的索引？"}]},{"ID":"20240201213461-194c5yx","Type":"NodeParagraph","Properties":{"id":"20240201213461-194c5yx","updated":"20240201213461"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"MongoDB 支持多种类型的索引，包括单字段索引、复合索引、多键索引、哈希索引、文本索引、 地理位置索引等，每种类型的索引有不同的使用场合。"}]},{"ID":"20240201213462-681dc58","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213462-681dc58","updated":"20240201213462"},"Children":[{"ID":"20240201213463-2d01629","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213463-2d01629","updated":"20240201213463"},"Children":[{"ID":"20240201213464-k9vyc5t","Type":"NodeParagraph","Properties":{"id":"20240201213464-k9vyc5t","updated":"20240201213464"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"单字段索引："},{"Type":"NodeText","Data":" 建立在单个字段上的索引，索引创建的排序顺序无所谓，MongoDB 可以头/尾开始遍历。"}]}]},{"ID":"20240201213465-crykr2p","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213465-crykr2p","updated":"20240201213465"},"Children":[{"ID":"20240201213466-s0kjawb","Type":"NodeParagraph","Properties":{"id":"20240201213466-s0kjawb","updated":"20240201213466"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"复合索引："},{"Type":"NodeText","Data":" 建立在多个字段上的索引，也可以称之为组合索引、联合索引。"}]}]},{"ID":"20240201213467-ioyou0r","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213467-ioyou0r","updated":"20240201213467"},"Children":[{"ID":"20240201213468-odaoi82","Type":"NodeParagraph","Properties":{"id":"20240201213468-odaoi82","updated":"20240201213468"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"多键索引"},{"Type":"NodeText","Data":"：MongoDB 的一个字段可能是数组，在对这种字段创建索引时，就是多键索引。MongoDB 会为数组的每个值创建索引。就是说你可以按照数组里面的值做条件来查询，这个时候依然会走索引。"}]}]},{"ID":"20240201213469-y5an9sd","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213469-y5an9sd","updated":"20240201213469"},"Children":[{"ID":"20240201213470-d7v0yq6","Type":"NodeParagraph","Properties":{"id":"20240201213470-d7v0yq6","updated":"20240201213470"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"哈希索引"},{"Type":"NodeText","Data":"：按数据的哈希值索引，用在哈希分片集群上。"}]}]},{"ID":"20240201213471-se5q011","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213471-se5q011","updated":"20240201213471"},"Children":[{"ID":"20240201213472-hug8ft6","Type":"NodeParagraph","Properties":{"id":"20240201213472-hug8ft6","updated":"20240201213472"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"文本索引："},{"Type":"NodeText","Data":" 支持对字符串内容的文本搜索查询。文本索引可以包含任何值为字符串或字符串元素数组的字段。一个集合只能有一个文本搜索索引，但该索引可以覆盖多个字段。MongoDB 虽然支持全文索引，但是性能低下，暂时不建议使用。"}]}]},{"ID":"20240201213473-k9rvlfu","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213473-k9rvlfu","updated":"20240201213473"},"Children":[{"ID":"20240201213474-j089vyt","Type":"NodeParagraph","Properties":{"id":"20240201213474-j089vyt","updated":"20240201213474"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"地理位置索引："},{"Type":"NodeText","Data":" 基于经纬度的索引，适合 2D 和 3D 的位置查询。"}]}]},{"ID":"20240201213475-db4crp8","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213475-db4crp8","updated":"20240201213475"},"Children":[{"ID":"20240201213476-cg2ohvu","Type":"NodeParagraph","Properties":{"id":"20240201213476-cg2ohvu","updated":"20240201213476"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"唯一索引"},{"Type":"NodeText","Data":"：确保索引字段不会存储重复值。如果集合已经存在了违反索引的唯一约束的文档，则后台创建唯一索引会失败。"}]}]},{"ID":"20240201213477-1rbqybh","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213477-1rbqybh","updated":"20240201213477"},"Children":[{"ID":"20240201213478-633ydt5","Type":"NodeParagraph","Properties":{"id":"20240201213478-633ydt5","updated":"20240201213478"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"TTL 索引"},{"Type":"NodeText","Data":"：TTL 索引提供了一个过期机制，允许为每一个文档设置一个过期时间，当一个文档达到预设的过期时间之后就会被删除。"}]}]},{"ID":"20240201213479-bw3b7bx","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213479-bw3b7bx","updated":"20240201213479"},"Children":[{"ID":"20240201213480-1jxl40g","Type":"NodeParagraph","Properties":{"id":"20240201213480-1jxl40g","updated":"20240201213480"},"Children":[{"Type":"NodeText","Data":"……"}]}]}]},{"ID":"20240201213481-8o04998","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213481-8o04998","updated":"20240201213481"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"复合索引中字段的顺序有影响吗？"}]},{"ID":"20240201213482-8r4o58y","Type":"NodeParagraph","Properties":{"id":"20240201213482-8r4o58y","updated":"20240201213482"},"Children":[{"Type":"NodeText","Data":"复合索引中字段的顺序非常重要，例如下图中的复合索引由"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"{userid:1, score:-1}"},{"Type":"NodeText","Data":"组成，则该复合索引首先按照"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"userid"},{"Type":"NodeText","Data":"升序排序；然后再每个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"userid"},{"Type":"NodeText","Data":"的值内，再按照"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"score"},{"Type":"NodeText","Data":"降序排序。"}]},{"ID":"20240201213483-cgdg81g","Type":"NodeParagraph","Properties":{"id":"20240201213483-cgdg81g","updated":"20240201213483"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"复合索引","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/mongodb/mongodb-composite-index.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213484-y7yceka","Type":"NodeParagraph","Properties":{"id":"20240201213484-y7yceka","updated":"20240201213484"},"Children":[{"Type":"NodeText","Data":"在复合索引中，按照何种方式排序，决定了该索引在查询中是否能被应用到。"}]},{"ID":"20240201213485-s5macmi","Type":"NodeParagraph","Properties":{"id":"20240201213485-s5macmi","updated":"20240201213485"},"Children":[{"Type":"NodeText","Data":"走复合索引的排序："}]},{"ID":"20240201213486-z8f663z","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"c3Fs","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213486-z8f663z","updated":"20240201213486"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c3Fs","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"db.s2.find().sort({\"userid\": 1, \"score\": -1})\ndb.s2.find().sort({\"userid\": -1, \"score\": 1})\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213487-nn8kyzc","Type":"NodeParagraph","Properties":{"id":"20240201213487-nn8kyzc","updated":"20240201213487"},"Children":[{"Type":"NodeText","Data":"不走复合索引的排序："}]},{"ID":"20240201213488-0235tux","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"c3Fs","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213488-0235tux","updated":"20240201213488"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c3Fs","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"db.s2.find().sort({\"userid\": 1, \"score\": 1})\ndb.s2.find().sort({\"userid\": -1, \"score\": -1})\ndb.s2.find().sort({\"score\": 1, \"userid\": -1})\ndb.s2.find().sort({\"score\": 1, \"userid\": 1})\ndb.s2.find().sort({\"score\": -1, \"userid\": -1})\ndb.s2.find().sort({\"score\": -1, \"userid\": 1})\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213489-4hxej4t","Type":"NodeParagraph","Properties":{"id":"20240201213489-4hxej4t","updated":"20240201213489"},"Children":[{"Type":"NodeText","Data":"我们可以通过 explain 进行分析："}]},{"ID":"20240201213490-32ct9il","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"c3Fs","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213490-32ct9il","updated":"20240201213490"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c3Fs","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"db.s2.find().sort({\"score\": -1, \"userid\": 1}).explain()\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213491-dx1v923","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213491-dx1v923","updated":"20240201213491"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"复合索引遵循左前缀原则吗？"}]},{"ID":"20240201213492-99pzarb","Type":"NodeParagraph","Properties":{"id":"20240201213492-99pzarb","updated":"20240201213492"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"MongoDB 的复合索引遵循左前缀原则"},{"Type":"NodeText","Data":"：拥有多个键的索引，可以同时得到所有这些键的前缀组成的索引，但不包括除左前缀之外的其他子集。比如说，有一个类似 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"{a: 1, b: 1, c: 1, ..., z: 1}"},{"Type":"NodeText","Data":" 这样的索引，那么实际上也等于有了 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"{a: 1}"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"{a: 1, b: 1}"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"{a: 1, b: 1, c: 1}"},{"Type":"NodeText","Data":" 等一系列索引，但是不会有 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"{b: 1}"},{"Type":"NodeText","Data":" 这样的非左前缀的索引。"}]},{"ID":"20240201213493-g3qwq1p","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213493-g3qwq1p","updated":"20240201213493"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"什么是 TTL 索引？"}]},{"ID":"20240201213494-czkhw0p","Type":"NodeParagraph","Properties":{"id":"20240201213494-czkhw0p","updated":"20240201213494"},"Children":[{"Type":"NodeText","Data":"TTL 索引提供了一个过期机制，允许为每一个文档设置一个过期时间 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"expireAfterSeconds"},{"Type":"NodeText","Data":" ，当一个文档达到预设的过期时间之后就会被删除。TTL 索引除了有 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"expireAfterSeconds"},{"Type":"NodeText","Data":" 属性外，和普通索引一样。"}]},{"ID":"20240201213495-r1diboi","Type":"NodeParagraph","Properties":{"id":"20240201213495-r1diboi","updated":"20240201213495"},"Children":[{"Type":"NodeText","Data":"数据过期对于某些类型的信息很有用，比如机器生成的事件数据、日志和会话信息，这些信息只需要在数据库中保存有限的时间。"}]},{"ID":"20240201213496-34c1u38","Type":"NodeParagraph","Properties":{"id":"20240201213496-34c1u38","updated":"20240201213496"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"TTL 索引运行原理"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213497-kqo4834","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213497-kqo4834","updated":"20240201213497"},"Children":[{"ID":"20240201213498-cztxrr6","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213498-cztxrr6","updated":"20240201213498"},"Children":[{"ID":"20240201213499-n7w1yfl","Type":"NodeParagraph","Properties":{"id":"20240201213499-n7w1yfl","updated":"20240201213499"},"Children":[{"Type":"NodeText","Data":"MongoDB 会开启一个后台线程读取该 TTL 索引的值来判断文档是否过期，但不会保证已过期的数据会立马被删除，因后台线程每 60 秒触发一次删除任务，且如果删除的数据量较大，会存在上一次的删除未完成，而下一次的任务已经开启的情况，导致过期的数据也会出现超过了数据保留时间 60 秒以上的现象。"}]}]},{"ID":"20240201213500-x1n0liz","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213500-x1n0liz","updated":"20240201213500"},"Children":[{"ID":"20240201213501-6m182zb","Type":"NodeParagraph","Properties":{"id":"20240201213501-6m182zb","updated":"20240201213501"},"Children":[{"Type":"NodeText","Data":"对于副本集而言，TTL 索引的后台进程只会在 Primary 节点开启，在从节点会始终处于空闲状态，从节点的数据删除是由主库删除后产生的 oplog 来做同步。"}]}]}]},{"ID":"20240201213502-xzs9e0t","Type":"NodeParagraph","Properties":{"id":"20240201213502-xzs9e0t","updated":"20240201213502"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"TTL 索引限制"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213503-vn2hdeb","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213503-vn2hdeb","updated":"20240201213503"},"Children":[{"ID":"20240201213504-2tzik4k","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213504-2tzik4k","updated":"20240201213504"},"Children":[{"ID":"20240201213505-yw7beek","Type":"NodeParagraph","Properties":{"id":"20240201213505-yw7beek","updated":"20240201213505"},"Children":[{"Type":"NodeText","Data":"TTL 索引是单字段索引。复合索引不支持 TTL"}]}]},{"ID":"20240201213506-rl7yq9b","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213506-rl7yq9b","updated":"20240201213506"},"Children":[{"ID":"20240201213507-u548slg","Type":"NodeParagraph","Properties":{"id":"20240201213507-u548slg","updated":"20240201213507"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"_id"},{"Type":"NodeText","Data":"字段不支持 TTL 索引。"}]}]},{"ID":"20240201213508-smgqmy3","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213508-smgqmy3","updated":"20240201213508"},"Children":[{"ID":"20240201213509-ozbif56","Type":"NodeParagraph","Properties":{"id":"20240201213509-ozbif56","updated":"20240201213509"},"Children":[{"Type":"NodeText","Data":"无法在上限集合(Capped Collection)上创建 TTL 索引，因为 MongoDB 无法从上限集合中删除文档。"}]}]},{"ID":"20240201213510-p718gh9","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213510-p718gh9","updated":"20240201213510"},"Children":[{"ID":"20240201213511-suo1mck","Type":"NodeParagraph","Properties":{"id":"20240201213511-suo1mck","updated":"20240201213511"},"Children":[{"Type":"NodeText","Data":"如果某个字段已经存在非 TTL 索引，那么在该字段上无法再创建 TTL 索引。"}]}]}]},{"ID":"20240201213512-fmtfokk","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213512-fmtfokk","updated":"20240201213512"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"什么是覆盖索引查询？"}]},{"ID":"20240201213513-ffbieua","Type":"NodeParagraph","Properties":{"id":"20240201213513-ffbieua","updated":"20240201213513"},"Children":[{"Type":"NodeText","Data":"根据官方文档介绍，覆盖查询是以下的查询："}]},{"ID":"20240201213514-vxqjzfm","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213514-vxqjzfm","updated":"20240201213514"},"Children":[{"ID":"20240201213515-pimffmu","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213515-pimffmu","updated":"20240201213515"},"Children":[{"ID":"20240201213516-wsovoq2","Type":"NodeParagraph","Properties":{"id":"20240201213516-wsovoq2","updated":"20240201213516"},"Children":[{"Type":"NodeText","Data":"所有的查询字段是索引的一部分。"}]}]},{"ID":"20240201213517-a4wqimh","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213517-a4wqimh","updated":"20240201213517"},"Children":[{"ID":"20240201213518-a7u85m9","Type":"NodeParagraph","Properties":{"id":"20240201213518-a7u85m9","updated":"20240201213518"},"Children":[{"Type":"NodeText","Data":"结果中返回的所有字段都在同一索引中。"}]}]},{"ID":"20240201213519-x0g84ff","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213519-x0g84ff","updated":"20240201213519"},"Children":[{"ID":"20240201213520-41kmrl9","Type":"NodeParagraph","Properties":{"id":"20240201213520-41kmrl9","updated":"20240201213520"},"Children":[{"Type":"NodeText","Data":"查询中没有字段等于"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"。"}]}]}]},{"ID":"20240201213521-3b1sp22","Type":"NodeParagraph","Properties":{"id":"20240201213521-3b1sp22","updated":"20240201213521"},"Children":[{"Type":"NodeText","Data":"由于所有出现在查询中的字段是索引的一部分， MongoDB 无需在整个数据文档中检索匹配查询条件和返回使用相同索引的查询结果。因为索引存在于内存中，从索引中获取数据比通过扫描文档读取数据要快得多。"}]},{"ID":"20240201213522-49o2vuk","Type":"NodeParagraph","Properties":{"id":"20240201213522-49o2vuk","updated":"20240201213522"},"Children":[{"Type":"NodeText","Data":"举个例子：我们有如下 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"users"},{"Type":"NodeText","Data":" 集合:"}]},{"ID":"20240201213523-itkqqzh","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"anNvbg==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213523-itkqqzh","updated":"20240201213523"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"anNvbg==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"{\n   \"_id\": ObjectId(\"53402597d852426020000002\"),\n   \"contact\": \"987654321\",\n   \"dob\": \"01-01-1991\",\n   \"gender\": \"M\",\n   \"name\": \"Tom Benzamin\",\n   \"user_name\": \"tombenzamin\"\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213524-pjc8h38","Type":"NodeParagraph","Properties":{"id":"20240201213524-pjc8h38","updated":"20240201213524"},"Children":[{"Type":"NodeText","Data":"我们在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"users"},{"Type":"NodeText","Data":" 集合中创建联合索引，字段为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"gender"},{"Type":"NodeText","Data":" 和 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"user_name"},{"Type":"NodeText","Data":" :"}]},{"ID":"20240201213525-wevc6nu","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"c3Fs","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213525-wevc6nu","updated":"20240201213525"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c3Fs","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"db.users.ensureIndex({gender:1,user_name:1})\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213526-fcsopmd","Type":"NodeParagraph","Properties":{"id":"20240201213526-fcsopmd","updated":"20240201213526"},"Children":[{"Type":"NodeText","Data":"现在，该索引会覆盖以下查询："}]},{"ID":"20240201213527-1lanla4","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"c3Fs","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213527-1lanla4","updated":"20240201213527"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c3Fs","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"db.users.find({gender:\"M\"},{user_name:1,_id:0})\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213528-zw4t7ar","Type":"NodeParagraph","Properties":{"id":"20240201213528-zw4t7ar","updated":"20240201213528"},"Children":[{"Type":"NodeText","Data":"为了让指定的索引覆盖查询，必须显式地指定 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"_id: 0"},{"Type":"NodeText","Data":" 来从结果中排除 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"_id"},{"Type":"NodeText","Data":" 字段，因为索引不包括 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"_id"},{"Type":"NodeText","Data":" 字段。"}]},{"ID":"20240201213529-1hc39t5","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213529-1hc39t5","updated":"20240201213529"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"MongoDB 高可用"}]},{"ID":"20240201213530-lxof0k1","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213530-lxof0k1","updated":"20240201213530"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"复制集群"}]},{"ID":"20240201213531-khkz6ag","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213531-khkz6ag","updated":"20240201213531"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"什么是复制集群？"}]},{"ID":"20240201213532-vbpb9pu","Type":"NodeParagraph","Properties":{"id":"20240201213532-vbpb9pu","updated":"20240201213532"},"Children":[{"Type":"NodeText","Data":"MongoDB 的复制集群又称为副本集群，是一组维护相同数据集合的 mongod 进程。"}]},{"ID":"20240201213533-jp2sx0t","Type":"NodeParagraph","Properties":{"id":"20240201213533-jp2sx0t","updated":"20240201213533"},"Children":[{"Type":"NodeText","Data":"客户端连接到整个 Mongodb 复制集群，主节点机负责整个复制集群的写，从节点可以进行读操作，但默认还是主节点负责整个复制集群的读。主节点发生故障时，自动从从节点中选举出一个新的主节点，确保集群的正常使用，这对于客户端来说是无感知的。"}]},{"ID":"20240201213534-yo7renk","Type":"NodeParagraph","Properties":{"id":"20240201213534-yo7renk","updated":"20240201213534"},"Children":[{"Type":"NodeText","Data":"通常来说，一个复制集群包含 1 个主节点（Primary），多个从节点（Secondary）以及零个或 1 个仲裁节点（Arbiter）。"}]},{"ID":"20240201213535-00329e2","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213535-00329e2","updated":"20240201213535"},"Children":[{"ID":"20240201213536-xlqd234","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213536-xlqd234","updated":"20240201213536"},"Children":[{"ID":"20240201213537-3oofbyj","Type":"NodeParagraph","Properties":{"id":"20240201213537-3oofbyj","updated":"20240201213537"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"主节点"},{"Type":"NodeText","Data":"：整个集群的写操作入口，接收所有的写操作，并将集合所有的变化记录到操作日志中，即 oplog。主节点挂掉之后会自动选出新的主节点。"}]}]},{"ID":"20240201213538-t2i0c4q","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213538-t2i0c4q","updated":"20240201213538"},"Children":[{"ID":"20240201213539-j6ypxwa","Type":"NodeParagraph","Properties":{"id":"20240201213539-j6ypxwa","updated":"20240201213539"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"从节点"},{"Type":"NodeText","Data":"：从主节点同步数据，在主节点挂掉之后选举新节点。不过，从节点可以配置成 0 优先级，阻止它在选举中成为主节点。"}]}]},{"ID":"20240201213540-y2pxzyz","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213540-y2pxzyz","updated":"20240201213540"},"Children":[{"ID":"20240201213541-pflszvn","Type":"NodeParagraph","Properties":{"id":"20240201213541-pflszvn","updated":"20240201213541"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"仲裁节点"},{"Type":"NodeText","Data":"：这个是为了节约资源或者多机房容灾用，只负责主节点选举时投票不存数据，保证能有节点获得多数赞成票。"}]}]}]},{"ID":"20240201213542-sv3uc6j","Type":"NodeParagraph","Properties":{"id":"20240201213542-sv3uc6j","updated":"20240201213542"},"Children":[{"Type":"NodeText","Data":"下图是一个典型的三成员副本集群："}]},{"ID":"20240201213543-bx15q5v","Type":"NodeParagraph","Properties":{"id":"20240201213543-bx15q5v","updated":"20240201213543"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/mongodb/replica-set-read-write-operations-primary.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213544-1c670xt","Type":"NodeParagraph","Properties":{"id":"20240201213544-1c670xt","updated":"20240201213544"},"Children":[{"Type":"NodeText","Data":"主节点与备节点之间是通过 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"oplog（操作日志）"},{"Type":"NodeText","Data":" 来同步数据的。oplog 是 local 库下的一个特殊的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"上限集合(Capped Collection)"},{"Type":"NodeText","Data":" ，用来保存写操作所产生的增量日志，类似于 MySQL 中 的 Binlog。"}]},{"ID":"20240201213545-vogapee","Type":"NodeBlockquote","Properties":{"id":"20240201213545-vogapee","updated":"20240201213545"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e ","Properties":{"id":""}},{"ID":"20240201213546-78aqi17","Type":"NodeParagraph","Properties":{"id":"20240201213546-78aqi17","updated":"20240201213546"},"Children":[{"Type":"NodeText","Data":"上限集合类似于定长的循环队列，数据顺序追加到集合的尾部，当集合空间达到上限时，它会覆盖集合中最旧的文档。上限集合的数据将会被顺序写入到磁盘的固定空间内，所以，I/O 速度非常快，如果不建立索引，性能更好。"}]}]},{"ID":"20240201213547-ul7t2p2","Type":"NodeParagraph","Properties":{"id":"20240201213547-ul7t2p2","updated":"20240201213547"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/mongodb/replica-set-primary-with-two-secondaries.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213548-zh7n3h4","Type":"NodeParagraph","Properties":{"id":"20240201213548-zh7n3h4","updated":"20240201213548"},"Children":[{"Type":"NodeText","Data":"当主节点上的一个写操作完成后，会向 oplog 集合写入一条对应的日志，而从节点则通过这个 oplog 不断拉取到新的日志，在本地进行回放以达到数据同步的目的。"}]},{"ID":"20240201213549-wakkfac","Type":"NodeParagraph","Properties":{"id":"20240201213549-wakkfac","updated":"20240201213549"},"Children":[{"Type":"NodeText","Data":"副本集最多有一个主节点。 如果当前主节点不可用，一个选举会抉择出新的主节点。MongoDB 的节点选举规则能够保证在 Primary 挂掉之后选取的新节点一定是集群中数据最全的一个。"}]},{"ID":"20240201213550-z1ktm2k","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213550-z1ktm2k","updated":"20240201213550"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"为什么要用复制集群？"}]},{"ID":"20240201213551-0awb7n1","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213551-0awb7n1","updated":"20240201213551"},"Children":[{"ID":"20240201213552-jpsbucg","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213552-jpsbucg","updated":"20240201213552"},"Children":[{"ID":"20240201213553-5n751n1","Type":"NodeParagraph","Properties":{"id":"20240201213553-5n751n1","updated":"20240201213553"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"实现 failover"},{"Type":"NodeText","Data":"：提供自动故障恢复的功能，主节点发生故障时，自动从从节点中选举出一个新的主节点，确保集群的正常使用，这对于客户端来说是无感知的。"}]}]},{"ID":"20240201213554-tx6lx1d","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213554-tx6lx1d","updated":"20240201213554"},"Children":[{"ID":"20240201213555-wmxtwey","Type":"NodeParagraph","Properties":{"id":"20240201213555-wmxtwey","updated":"20240201213555"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"实现读写分离"},{"Type":"NodeText","Data":"：我们可以设置从节点上可以读取数据，主节点负责写入数据，这样的话就实现了读写分离，减轻了主节点读写压力过大的问题。MongoDB 4.0 之前版本如果主库压力不大,不建议读写分离，因为写会阻塞读，除非业务对响应时间不是非常关注以及读取历史数据接受一定时间延迟。"}]}]}]},{"ID":"20240201213556-ahvol6e","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213556-ahvol6e","updated":"20240201213556"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"分片集群"}]},{"ID":"20240201213557-weioikd","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213557-weioikd","updated":"20240201213557"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"什么是分片集群？"}]},{"ID":"20240201213558-9w6zw2f","Type":"NodeParagraph","Properties":{"id":"20240201213558-9w6zw2f","updated":"20240201213558"},"Children":[{"Type":"NodeText","Data":"分片集群是 MongoDB 的分布式版本，相较副本集，分片集群数据被均衡的分布在不同分片中， 不仅大幅提升了整个集群的数据容量上限，也将读写的压力分散到不同分片，以解决副本集性能瓶颈的难题。"}]},{"ID":"20240201213559-rgp5oc8","Type":"NodeParagraph","Properties":{"id":"20240201213559-rgp5oc8","updated":"20240201213559"},"Children":[{"Type":"NodeText","Data":"MongoDB 的分片集群由如下三个部分组成（下图来源于"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://www.mongodb.com/docs/manual/sharding/","TextMarkTextContent":"官方文档对分片集群的介绍"},{"Type":"NodeText","Data":"）："}]},{"ID":"20240201213560-1ddeabt","Type":"NodeParagraph","Properties":{"id":"20240201213560-1ddeabt","updated":"20240201213560"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/mongodb/sharded-cluster-production-architecture.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213561-j99rfx1","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213561-j99rfx1","updated":"20240201213561"},"Children":[{"ID":"20240201213562-swh542o","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213562-swh542o","updated":"20240201213562"},"Children":[{"ID":"20240201213563-iekaha6","Type":"NodeParagraph","Properties":{"id":"20240201213563-iekaha6","updated":"20240201213563"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Config Servers"},{"Type":"NodeText","Data":"：配置服务器，本质上是一个 MongoDB 的副本集，负责存储集群的各种元数据和配置，如分片地址、Chunks 等"}]}]},{"ID":"20240201213564-yvjdukn","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213564-yvjdukn","updated":"20240201213564"},"Children":[{"ID":"20240201213565-ohvoko0","Type":"NodeParagraph","Properties":{"id":"20240201213565-ohvoko0","updated":"20240201213565"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Mongos"},{"Type":"NodeText","Data":"：路由服务，不存具体数据，从 Config 获取集群配置讲请求转发到特定的分片，并且整合分片结果返回给客户端。"}]}]},{"ID":"20240201213566-b3n4o2d","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213566-b3n4o2d","updated":"20240201213566"},"Children":[{"ID":"20240201213567-m7yjuo5","Type":"NodeParagraph","Properties":{"id":"20240201213567-m7yjuo5","updated":"20240201213567"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Shard"},{"Type":"NodeText","Data":"：每个分片是整体数据的一部分子集，从 MongoDB3.6 版本开始，每个 Shard 必须部署为副本集（replica set）架构"}]}]}]},{"ID":"20240201213568-rsc2o72","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213568-rsc2o72","updated":"20240201213568"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"为什么要用分片集群？"}]},{"ID":"20240201213569-frjup2n","Type":"NodeParagraph","Properties":{"id":"20240201213569-frjup2n","updated":"20240201213569"},"Children":[{"Type":"NodeText","Data":"随着系统数据量以及吞吐量的增长，常见的解决办法有两种：垂直扩展和水平扩展。"}]},{"ID":"20240201213570-4ni6dyd","Type":"NodeParagraph","Properties":{"id":"20240201213570-4ni6dyd","updated":"20240201213570"},"Children":[{"Type":"NodeText","Data":"垂直扩展通过增加单个服务器的能力来实现，比如磁盘空间、内存容量、CPU 数量等；水平扩展则通过将数据存储到多个服务器上来实现，根据需要添加额外的服务器以增加容量。"}]},{"ID":"20240201213571-zua2a7q","Type":"NodeParagraph","Properties":{"id":"20240201213571-zua2a7q","updated":"20240201213571"},"Children":[{"Type":"NodeText","Data":"类似于 Redis Cluster，MongoDB 也可以通过分片实现 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"水平扩展"},{"Type":"NodeText","Data":" 。水平扩展这种方式更灵活，可以满足更大数据量的存储需求，支持更高吞吐量。并且，水平扩展所需的整体成本更低，仅仅需要相对较低配置的单机服务器即可，代价是增加了部署的基础设施和维护的复杂性。"}]},{"ID":"20240201213572-b64k6p8","Type":"NodeParagraph","Properties":{"id":"20240201213572-b64k6p8","updated":"20240201213572"},"Children":[{"Type":"NodeText","Data":"也就是说当你遇到如下问题时，可以使用分片集群解决："}]},{"ID":"20240201213573-kkkl30e","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213573-kkkl30e","updated":"20240201213573"},"Children":[{"ID":"20240201213574-zbsrs5u","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213574-zbsrs5u","updated":"20240201213574"},"Children":[{"ID":"20240201213575-rx9dpdc","Type":"NodeParagraph","Properties":{"id":"20240201213575-rx9dpdc","updated":"20240201213575"},"Children":[{"Type":"NodeText","Data":"存储容量受单机限制，即磁盘资源遭遇瓶颈。"}]}]},{"ID":"20240201213576-q9yqb7s","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213576-q9yqb7s","updated":"20240201213576"},"Children":[{"ID":"20240201213577-c2h838e","Type":"NodeParagraph","Properties":{"id":"20240201213577-c2h838e","updated":"20240201213577"},"Children":[{"Type":"NodeText","Data":"读写能力受单机限制，可能是 CPU、内存或者网卡等资源遭遇瓶颈，导致读写能力无法扩展。"}]}]}]},{"ID":"20240201213578-b7dxqbp","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213578-b7dxqbp","updated":"20240201213578"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"什么是分片键？"}]},{"ID":"20240201213579-urqe1l9","Type":"NodeParagraph","Properties":{"id":"20240201213579-urqe1l9","updated":"20240201213579"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"分片键（Shard Key）"},{"Type":"NodeText","Data":" 是数据分区的前提， 从而实现数据分发到不同服务器上，减轻服务器的负担。也就是说，分片键决定了集合内的文档如何在集群的多个分片间的分布状况。"}]},{"ID":"20240201213580-m11zexd","Type":"NodeParagraph","Properties":{"id":"20240201213580-m11zexd","updated":"20240201213580"},"Children":[{"Type":"NodeText","Data":"分片键就是文档里面的一个字段，但是这个字段不是普通的字段，有一定的要求："}]},{"ID":"20240201213581-jj5ks4b","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213581-jj5ks4b","updated":"20240201213581"},"Children":[{"ID":"20240201213582-em2jfz5","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213582-em2jfz5","updated":"20240201213582"},"Children":[{"ID":"20240201213583-kk7hf79","Type":"NodeParagraph","Properties":{"id":"20240201213583-kk7hf79","updated":"20240201213583"},"Children":[{"Type":"NodeText","Data":"它必须在所有文档中都出现。"}]}]},{"ID":"20240201213584-9if3zgk","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213584-9if3zgk","updated":"20240201213584"},"Children":[{"ID":"20240201213585-7br7vv4","Type":"NodeParagraph","Properties":{"id":"20240201213585-7br7vv4","updated":"20240201213585"},"Children":[{"Type":"NodeText","Data":"它必须是集合的一个索引，可以是单索引或复合索引的前缀索引，不能是多索引、文本索引或地理空间位置索引。"}]}]},{"ID":"20240201213586-gswydt9","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213586-gswydt9","updated":"20240201213586"},"Children":[{"ID":"20240201213587-d7yw9dw","Type":"NodeParagraph","Properties":{"id":"20240201213587-d7yw9dw","updated":"20240201213587"},"Children":[{"Type":"NodeText","Data":"MongoDB 4.2 之前的版本，文档的分片键字段值不可变。MongoDB 4.2 版本开始，除非分片键字段是不可变的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"_id"},{"Type":"NodeText","Data":" 字段，否则您可以更新文档的分片键值。MongoDB 5.0 版本开始，实现了实时重新分片（live resharding），可以实现分片键的完全重新选择。"}]}]},{"ID":"20240201213588-o9t9xdh","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213588-o9t9xdh","updated":"20240201213588"},"Children":[{"ID":"20240201213589-hh5z5nd","Type":"NodeParagraph","Properties":{"id":"20240201213589-hh5z5nd","updated":"20240201213589"},"Children":[{"Type":"NodeText","Data":"它的大小不能超过 512 字节。"}]}]}]},{"ID":"20240201213590-tyffpvl","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213590-tyffpvl","updated":"20240201213590"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"如何选择分片键？"}]},{"ID":"20240201213591-pejmk13","Type":"NodeParagraph","Properties":{"id":"20240201213591-pejmk13","updated":"20240201213591"},"Children":[{"Type":"NodeText","Data":"选择合适的片键对 sharding 效率影响很大，主要基于如下四个因素（摘自"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://cloud.tencent.com/document/product/240/44611","TextMarkTextContent":"分片集群使用注意事项 - - 腾讯云文档"},{"Type":"NodeText","Data":"）："}]},{"ID":"20240201213592-j4bprkd","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213592-j4bprkd","updated":"20240201213592"},"Children":[{"ID":"20240201213593-rl2ke19","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213593-rl2ke19","updated":"20240201213593"},"Children":[{"ID":"20240201213594-7lw53xq","Type":"NodeParagraph","Properties":{"id":"20240201213594-7lw53xq","updated":"20240201213594"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"取值基数"},{"Type":"NodeText","Data":" 取值基数建议尽可能大，如果用小基数的片键，因为备选值有限，那么块的总数量就有限，随着数据增多，块的大小会越来越大，导致水平扩展时移动块会非常困难。 例如：选择年龄做一个基数，范围最多只有 100 个，随着数据量增多，同一个值分布过多时，导致 chunck 的增长超出 chuncksize 的范围，引起 jumbo chunk，从而无法迁移，导致数据分布不均匀，性能瓶颈。"}]}]},{"ID":"20240201213595-hdotf14","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213595-hdotf14","updated":"20240201213595"},"Children":[{"ID":"20240201213596-d3o0ezq","Type":"NodeParagraph","Properties":{"id":"20240201213596-d3o0ezq","updated":"20240201213596"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"取值分布"},{"Type":"NodeText","Data":" 取值分布建议尽量均匀，分布不均匀的片键会造成某些块的数据量非常大，同样有上面数据分布不均匀，性能瓶颈的问题。"}]}]},{"ID":"20240201213597-hbtnvlg","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213597-hbtnvlg","updated":"20240201213597"},"Children":[{"ID":"20240201213598-6o27zhk","Type":"NodeParagraph","Properties":{"id":"20240201213598-6o27zhk","updated":"20240201213598"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"查询带分片"},{"Type":"NodeText","Data":" 查询时建议带上分片，使用分片键进行条件查询时，mongos 可以直接定位到具体分片，否则 mongos 需要将查询分发到所有分片，再等待响应返回。"}]}]},{"ID":"20240201213599-kirokxy","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213599-kirokxy","updated":"20240201213599"},"Children":[{"ID":"20240201213600-khucgj5","Type":"NodeParagraph","Properties":{"id":"20240201213600-khucgj5","updated":"20240201213600"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"避免单调递增或递减"},{"Type":"NodeText","Data":" 单调递增的 sharding key，数据文件挪动小，但写入会集中，导致最后一篇的数据量持续增大，不断发生迁移，递减同理。"}]}]}]},{"ID":"20240201213601-pl7ahxw","Type":"NodeParagraph","Properties":{"id":"20240201213601-pl7ahxw","updated":"20240201213601"},"Children":[{"Type":"NodeText","Data":"综上，在选择片键时要考虑以上 4 个条件，尽可能满足更多的条件，才能降低 MoveChunks 对性能的影响，从而获得最优的性能体验。"}]},{"ID":"20240201213602-u0p21do","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213602-u0p21do","updated":"20240201213602"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"分片策略有哪些？"}]},{"ID":"20240201213603-dgyu3lh","Type":"NodeParagraph","Properties":{"id":"20240201213603-dgyu3lh","updated":"20240201213603"},"Children":[{"Type":"NodeText","Data":"MongoDB 支持两种分片算法来满足不同的查询需求（摘自"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://help.aliyun.com/document_detail/64561.html?spm=a2c4g.11186623.0.0.3121565eQhUGGB#h2--shard-key-3","TextMarkTextContent":"MongoDB 分片集群介绍 - 阿里云文档"},{"Type":"NodeText","Data":"）："}]},{"ID":"20240201213604-adj0r5e","Type":"NodeParagraph","Properties":{"id":"20240201213604-adj0r5e","updated":"20240201213604"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"1、基于范围的分片"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213605-v2jhn5j","Type":"NodeParagraph","Properties":{"id":"20240201213605-v2jhn5j","updated":"20240201213605"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/mongodb/example-of-scope-based-sharding.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213606-9mt5fjd","Type":"NodeParagraph","Properties":{"id":"20240201213606-9mt5fjd","updated":"20240201213606"},"Children":[{"Type":"NodeText","Data":"MongoDB 按照分片键（Shard Key）的值的范围将数据拆分为不同的块（Chunk），每个块包含了一段范围内的数据。当分片键的基数大、频率低且值非单调变更时，范围分片更高效。"}]},{"ID":"20240201213607-h49uoh3","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213607-h49uoh3","updated":"20240201213607"},"Children":[{"ID":"20240201213608-nqz2icn","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213608-nqz2icn","updated":"20240201213608"},"Children":[{"ID":"20240201213609-igkq4nx","Type":"NodeParagraph","Properties":{"id":"20240201213609-igkq4nx","updated":"20240201213609"},"Children":[{"Type":"NodeText","Data":"优点：Mongos 可以快速定位请求需要的数据，并将请求转发到相应的 Shard 节点中。"}]}]},{"ID":"20240201213610-qaqshnf","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213610-qaqshnf","updated":"20240201213610"},"Children":[{"ID":"20240201213611-e4su5cd","Type":"NodeParagraph","Properties":{"id":"20240201213611-e4su5cd","updated":"20240201213611"},"Children":[{"Type":"NodeText","Data":"缺点：可能导致数据在 Shard 节点上分布不均衡，容易造成读写热点，且不具备写分散性。"}]}]},{"ID":"20240201213612-53hynmh","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213612-53hynmh","updated":"20240201213612"},"Children":[{"ID":"20240201213613-x57kcdm","Type":"NodeParagraph","Properties":{"id":"20240201213613-x57kcdm","updated":"20240201213613"},"Children":[{"Type":"NodeText","Data":"适用场景：分片键的值不是单调递增或单调递减、分片键的值基数大且重复的频率低、需要范围查询等业务场景。"}]}]}]},{"ID":"20240201213614-7a0ez2e","Type":"NodeParagraph","Properties":{"id":"20240201213614-7a0ez2e","updated":"20240201213614"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"2、基于 Hash 值的分片"}]},{"ID":"20240201213615-0scqsyz","Type":"NodeParagraph","Properties":{"id":"20240201213615-0scqsyz","updated":"20240201213615"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/mongodb/example-of-hash-based-sharding.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213616-ecx7zji","Type":"NodeParagraph","Properties":{"id":"20240201213616-ecx7zji","updated":"20240201213616"},"Children":[{"Type":"NodeText","Data":"MongoDB 计算单个字段的哈希值作为索引值，并以哈希值的范围将数据拆分为不同的块（Chunk）。"}]},{"ID":"20240201213617-pcjoy1w","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213617-pcjoy1w","updated":"20240201213617"},"Children":[{"ID":"20240201213618-4w3ennr","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213618-4w3ennr","updated":"20240201213618"},"Children":[{"ID":"20240201213619-hj1fzm8","Type":"NodeParagraph","Properties":{"id":"20240201213619-hj1fzm8","updated":"20240201213619"},"Children":[{"Type":"NodeText","Data":"优点：可以将数据更加均衡地分布在各 Shard 节点中，具备写分散性。"}]}]},{"ID":"20240201213620-chtbss5","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213620-chtbss5","updated":"20240201213620"},"Children":[{"ID":"20240201213621-c37xpqw","Type":"NodeParagraph","Properties":{"id":"20240201213621-c37xpqw","updated":"20240201213621"},"Children":[{"Type":"NodeText","Data":"缺点：不适合进行范围查询，进行范围查询时，需要将读请求分发到所有的 Shard 节点。"}]}]},{"ID":"20240201213622-dc6l7b1","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213622-dc6l7b1","updated":"20240201213622"},"Children":[{"ID":"20240201213623-p18caqz","Type":"NodeParagraph","Properties":{"id":"20240201213623-p18caqz","updated":"20240201213623"},"Children":[{"Type":"NodeText","Data":"适用场景：分片键的值存在单调递增或递减、片键的值基数大且重复的频率低、需要写入的数据随机分发、数据读取随机性较大等业务场景。"}]}]}]},{"ID":"20240201213624-mh9c5vd","Type":"NodeParagraph","Properties":{"id":"20240201213624-mh9c5vd","updated":"20240201213624"},"Children":[{"Type":"NodeText","Data":"除了上述两种分片策略，您还可以配置 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"复合片键"},{"Type":"NodeText","Data":" ，例如由一个低基数的键和一个单调递增的键组成。"}]},{"ID":"20240201213625-4ie9u25","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213625-4ie9u25","updated":"20240201213625"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"分片数据如何存储？"}]},{"ID":"20240201213626-h2ly9i4","Type":"NodeParagraph","Properties":{"id":"20240201213626-h2ly9i4","updated":"20240201213626"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Chunk（块）"},{"Type":"NodeText","Data":" 是 MongoDB 分片集群的一个核心概念，其本质上就是由一组 Document 组成的逻辑数据单元。每个 Chunk 包含一定范围片键的数据，互不相交且并集为全部数据，即离散数学中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"划分"},{"Type":"NodeText","Data":"的概念。"}]},{"ID":"20240201213627-jxjem9n","Type":"NodeParagraph","Properties":{"id":"20240201213627-jxjem9n","updated":"20240201213627"},"Children":[{"Type":"NodeText","Data":"分片集群不会记录每条数据在哪个分片上，而是记录 Chunk 在哪个分片上一级这个 Chunk 包含哪些数据。"}]},{"ID":"20240201213628-9zalzmy","Type":"NodeParagraph","Properties":{"id":"20240201213628-9zalzmy","updated":"20240201213628"},"Children":[{"Type":"NodeText","Data":"默认情况下，一个 Chunk 的最大值默认为 64MB（可调整，取值范围为 1~1024 MB。如无特殊需求，建议保持默认值），进行数据插入、更新、删除时，如果此时 Mongos 感知到了目标 Chunk 的大小或者其中的数据量超过上限，则会触发 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Chunk 分裂"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213629-2iirewo","Type":"NodeParagraph","Properties":{"id":"20240201213629-2iirewo","updated":"20240201213629"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"Chunk 分裂","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/mongodb/chunk-splitting-shard-a.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213630-ga0hl8l","Type":"NodeParagraph","Properties":{"id":"20240201213630-ga0hl8l","updated":"20240201213630"},"Children":[{"Type":"NodeText","Data":"数据的增长会让 Chunk 分裂得越来越多。这个时候，各个分片上的 Chunk 数量可能会不平衡。Mongos 中的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"均衡器(Balancer)"},{"Type":"NodeText","Data":" 组件就会执行自动平衡，尝试使各个 Shard 上 Chunk 的数量保持均衡，这个过程就是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"再平衡（Rebalance）"},{"Type":"NodeText","Data":"。默认情况下，数据库和集合的 Rebalance 是开启的。"}]},{"ID":"20240201213631-w2icb67","Type":"NodeParagraph","Properties":{"id":"20240201213631-w2icb67","updated":"20240201213631"},"Children":[{"Type":"NodeText","Data":"如下图所示，随着数据插入，导致 Chunk 分裂，让 AB 两个分片有 3 个 Chunk，C 分片只有一个，这个时候就会把 B 分配的迁移一个到 C 分片实现集群数据均衡。"}]},{"ID":"20240201213632-ymypjfo","Type":"NodeParagraph","Properties":{"id":"20240201213632-ymypjfo","updated":"20240201213632"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"Chunk 迁移","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/github/javaguide/database/mongodb/mongo-reblance-three-shards.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213633-725dgx1","Type":"NodeBlockquote","Properties":{"id":"20240201213633-725dgx1","updated":"20240201213633"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e ","Properties":{"id":""}},{"ID":"20240201213634-vcgpnrb","Type":"NodeParagraph","Properties":{"id":"20240201213634-vcgpnrb","updated":"20240201213634"},"Children":[{"Type":"NodeText","Data":"Balancer 是 MongoDB 的一个运行在 Config Server 的 Primary 节点上(自 MongoDB 3.4 版本起)的后台进程，它监控每个分片上 Chunk 数量，并在某个分片上 Chunk 数量达到阈值进行迁移。"}]}]},{"ID":"20240201213635-ahy8omr","Type":"NodeParagraph","Properties":{"id":"20240201213635-ahy8omr","updated":"20240201213635"},"Children":[{"Type":"NodeText","Data":"Chunk 只会分裂，不会合并，即使 chunkSize 的值变大。"}]},{"ID":"20240201213636-sle3da7","Type":"NodeParagraph","Properties":{"id":"20240201213636-sle3da7","updated":"20240201213636"},"Children":[{"Type":"NodeText","Data":"Rebalance 操作是比较耗费系统资源的，我们可以通过在业务低峰期执行、预分片或者设置 Rebalance 时间窗等方式来减少其对 MongoDB 正常使用所带来的影响。"}]},{"ID":"20240201213637-xnuzpo1","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213637-xnuzpo1","updated":"20240201213637"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"Chunk 迁移原理是什么？"}]},{"ID":"20240201213638-6z5hsnu","Type":"NodeParagraph","Properties":{"id":"20240201213638-6z5hsnu","updated":"20240201213638"},"Children":[{"Type":"NodeText","Data":"关于 Chunk 迁移原理的详细介绍，推荐阅读 MongoDB 中文社区的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://mongoing.com/archives/77479","TextMarkTextContent":"一文读懂 MongoDB chunk 迁移"},{"Type":"NodeText","Data":"这篇文章。"}]},{"ID":"20240201213639-jjuemui","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213639-jjuemui","updated":"20240201213639"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"学习资料推荐"}]},{"ID":"20240201213640-mhe49gj","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213640-mhe49gj","updated":"20240201213640"},"Children":[{"ID":"20240201213641-6bt95f1","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213641-6bt95f1","updated":"20240201213641"},"Children":[{"ID":"20240201213642-ggker24","Type":"NodeParagraph","Properties":{"id":"20240201213642-ggker24","updated":"20240201213642"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://docs.mongoing.com/","TextMarkTextContent":"MongoDB 中文手册|官方文档中文版"},{"Type":"NodeText","Data":"（推荐）：基于 4.2 版本，不断与官方最新版保持同步。"}]}]},{"ID":"20240201213643-c8bdc7y","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213643-c8bdc7y","updated":"20240201213643"},"Children":[{"ID":"20240201213644-4wrr65m","Type":"NodeParagraph","Properties":{"id":"20240201213644-4wrr65m","updated":"20240201213644"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://mongoing.com/archives/docs/mongodb%e5%88%9d%e5%ad%a6%e8%80%85%e6%95%99%e7%a8%8b/mongodb%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e6%95%b0%e6%8d%ae%e5%ba%93%e5%92%8c%e9%9b%86%e5%90%88","TextMarkTextContent":"MongoDB 初学者教程——7 天学习 MongoDB"},{"Type":"NodeText","Data":"：快速入门。"}]}]},{"ID":"20240201213645-mcfyl1z","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213645-mcfyl1z","updated":"20240201213645"},"Children":[{"ID":"20240201213646-x0owm8m","Type":"NodeParagraph","Properties":{"id":"20240201213646-x0owm8m","updated":"20240201213646"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://www.cnblogs.com/dxflqm/p/16643981.html","TextMarkTextContent":"SpringBoot 整合 MongoDB 实战 - 2022"},{"Type":"NodeText","Data":"：很不错的一篇 MongoDB 入门文章，主要围绕 MongoDB 的 Java 客户端使用进行基本的增删改查操作介绍。"}]}]}]},{"ID":"20240201213647-quzkhlm","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213647-quzkhlm","updated":"20240201213647"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"参考"}]},{"ID":"20240201213648-xd6uvmz","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213648-xd6uvmz","updated":"20240201213648"},"Children":[{"ID":"20240201213649-eml0cv0","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213649-eml0cv0","updated":"20240201213649"},"Children":[{"ID":"20240201213650-okzvhhy","Type":"NodeParagraph","Properties":{"id":"20240201213650-okzvhhy","updated":"20240201213650"},"Children":[{"Type":"NodeText","Data":"MongoDB 官方文档（主要参考资料，以官方文档为准）："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://www.mongodb.com/docs/manual/","TextMarkTextContent":"https://www.mongodb.com/docs/manual/"}]}]},{"ID":"20240201213651-vn1p104","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213651-vn1p104","updated":"20240201213651"},"Children":[{"ID":"20240201213652-zjyyieg","Type":"NodeParagraph","Properties":{"id":"20240201213652-zjyyieg","updated":"20240201213652"},"Children":[{"Type":"NodeText","Data":"《MongoDB 权威指南》"}]}]},{"ID":"20240201213653-15u62vs","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213653-15u62vs","updated":"20240201213653"},"Children":[{"ID":"20240201213654-piw53vy","Type":"NodeParagraph","Properties":{"id":"20240201213654-piw53vy","updated":"20240201213654"},"Children":[{"Type":"NodeText","Data":"Indexes - MongoDB 官方文档："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://www.mongodb.com/docs/manual/indexes/","TextMarkTextContent":"https://www.mongodb.com/docs/manual/indexes/"}]}]},{"ID":"20240201213655-wlcl750","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213655-wlcl750","updated":"20240201213655"},"Children":[{"ID":"20240201213656-ydzgcv9","Type":"NodeParagraph","Properties":{"id":"20240201213656-ydzgcv9","updated":"20240201213656"},"Children":[{"Type":"NodeText","Data":"MongoDB - 索引知识 - 程序员翔仔 - 2022："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://fatedeity.cn/posts/database/mongodb-index-knowledge.html","TextMarkTextContent":"https://fatedeity.cn/posts/database/mongodb-index-knowledge.html"}]}]},{"ID":"20240201213657-st6jrdr","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213657-st6jrdr","updated":"20240201213657"},"Children":[{"ID":"20240201213658-icidvo4","Type":"NodeParagraph","Properties":{"id":"20240201213658-icidvo4","updated":"20240201213658"},"Children":[{"Type":"NodeText","Data":"MongoDB - 索引: "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://www.cnblogs.com/Neeo/articles/14325130.html","TextMarkTextContent":"https://www.cnblogs.com/Neeo/articles/14325130.html"}]}]},{"ID":"20240201213659-nrq7q2w","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213659-nrq7q2w","updated":"20240201213659"},"Children":[{"ID":"20240201213660-neg4tvx","Type":"NodeParagraph","Properties":{"id":"20240201213660-neg4tvx","updated":"20240201213660"},"Children":[{"Type":"NodeText","Data":"Sharding - MongoDB 官方文档："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://www.mongodb.com/docs/manual/sharding/","TextMarkTextContent":"https://www.mongodb.com/docs/manual/sharding/"}]}]},{"ID":"20240201213661-b95g88o","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213661-b95g88o","updated":"20240201213661"},"Children":[{"ID":"20240201213662-45nfdne","Type":"NodeParagraph","Properties":{"id":"20240201213662-45nfdne","updated":"20240201213662"},"Children":[{"Type":"NodeText","Data":"MongoDB 分片集群介绍 - 阿里云文档："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://help.aliyun.com/document_detail/64561.html","TextMarkTextContent":"https://help.aliyun.com/document_detail/64561.html"}]}]},{"ID":"20240201213663-ayap4xm","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213663-ayap4xm","updated":"20240201213663"},"Children":[{"ID":"20240201213664-ch77f43","Type":"NodeParagraph","Properties":{"id":"20240201213664-ch77f43","updated":"20240201213664"},"Children":[{"Type":"NodeText","Data":"分片集群使用注意事项 - - 腾讯云文档："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://cloud.tencent.com/document/product/240/44611","TextMarkTextContent":"https://cloud.tencent.com/document/product/240/44611"}]}]}]},{"ID":"20240201213665-16h0p22","Type":"NodeHTMLBlock","Data":"\u003cdiv\u003e\n\u003c!-- @include: @article-footer.snippet.md --\u003e\n\u003c/div\u003e","HtmlBlockType":2,"Properties":{"id":"20240201213665-16h0p22","updated":"20240201213665"}}]}