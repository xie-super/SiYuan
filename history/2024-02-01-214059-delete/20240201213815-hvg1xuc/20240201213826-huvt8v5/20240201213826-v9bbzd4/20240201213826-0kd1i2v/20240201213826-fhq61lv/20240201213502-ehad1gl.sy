{"ID":"20240201213502-ehad1gl","Spec":"1","Type":"NodeDocument","Properties":{"id":"20240201213502-ehad1gl","title":"innodb-implementation-of-mvcc","updated":"20240201213502"},"Children":[{"ID":"20240201213503-4raswww","Type":"NodeThematicBreak","Properties":{"id":"20240201213503-4raswww","updated":"20240201213503"}},{"ID":"20240201213504-5tz33kz","Type":"NodeParagraph","Properties":{"id":"20240201213504-5tz33kz","updated":"20240201213504"},"Children":[{"Type":"NodeText","Data":"title: InnoDB存储引擎对MVCC的实现"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"category: 数据库"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"tag:"}]},{"ID":"20240201213505-lwo4lf7","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213505-lwo4lf7","updated":"20240201213505"},"Children":[{"ID":"20240201213506-v7ttp4s","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213506-v7ttp4s","updated":"20240201213506"},"Children":[{"ID":"20240201213507-tnvcris","Type":"NodeParagraph","Properties":{"id":"20240201213507-tnvcris","updated":"20240201213507"},"Children":[{"Type":"NodeText","Data":"MySQL"}]}]}]},{"ID":"20240201213508-2ys9flf","Type":"NodeThematicBreak","Properties":{"id":"20240201213508-2ys9flf","updated":"20240201213508"}},{"ID":"20240201213509-dggxdek","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213509-dggxdek","updated":"20240201213509"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"多版本并发控制 (Multi-Version Concurrency Control)"}]},{"ID":"20240201213510-gc9jpb9","Type":"NodeParagraph","Properties":{"id":"20240201213510-gc9jpb9","updated":"20240201213510"},"Children":[{"Type":"NodeText","Data":"MVCC 是一种并发控制机制，用于在多个并发事务同时读写数据库时保持数据的一致性和隔离性。它是通过在每个数据行上维护多个版本的数据来实现的。当一个事务要对数据库中的数据进行修改时，MVCC 会为该事务创建一个数据快照，而不是直接修改实际的数据行。"}]},{"ID":"20240201213511-rowyyo5","Type":"NodeParagraph","Properties":{"id":"20240201213511-rowyyo5","updated":"20240201213511"},"Children":[{"Type":"NodeText","Data":"1、读操作（SELECT）："}]},{"ID":"20240201213512-mn9nndg","Type":"NodeParagraph","Properties":{"id":"20240201213512-mn9nndg","updated":"20240201213512"},"Children":[{"Type":"NodeText","Data":"当一个事务执行读操作时，它会使用快照读取。快照读取是基于事务开始时数据库中的状态创建的，因此事务不会读取其他事务尚未提交的修改。具体工作情况如下："}]},{"ID":"20240201213513-pylafy5","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213513-pylafy5","updated":"20240201213513"},"Children":[{"ID":"20240201213514-twphmpa","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213514-twphmpa","updated":"20240201213514"},"Children":[{"ID":"20240201213515-tyc0r87","Type":"NodeParagraph","Properties":{"id":"20240201213515-tyc0r87","updated":"20240201213515"},"Children":[{"Type":"NodeText","Data":"对于读取操作，事务会查找符合条件的数据行，并选择符合其事务开始时间的数据版本进行读取。"}]}]},{"ID":"20240201213516-1drpae7","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213516-1drpae7","updated":"20240201213516"},"Children":[{"ID":"20240201213517-5j71ui5","Type":"NodeParagraph","Properties":{"id":"20240201213517-5j71ui5","updated":"20240201213517"},"Children":[{"Type":"NodeText","Data":"如果某个数据行有多个版本，事务会选择不晚于其开始时间的最新版本，确保事务只读取在它开始之前已经存在的数据。"}]}]},{"ID":"20240201213518-k0v9tt8","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213518-k0v9tt8","updated":"20240201213518"},"Children":[{"ID":"20240201213519-dtghc5g","Type":"NodeParagraph","Properties":{"id":"20240201213519-dtghc5g","updated":"20240201213519"},"Children":[{"Type":"NodeText","Data":"事务读取的是快照数据，因此其他并发事务对数据行的修改不会影响当前事务的读取操作。"}]}]}]},{"ID":"20240201213520-3r9n0ml","Type":"NodeParagraph","Properties":{"id":"20240201213520-3r9n0ml","updated":"20240201213520"},"Children":[{"Type":"NodeText","Data":"2、写操作（INSERT、UPDATE、DELETE）："}]},{"ID":"20240201213521-8y7ts6l","Type":"NodeParagraph","Properties":{"id":"20240201213521-8y7ts6l","updated":"20240201213521"},"Children":[{"Type":"NodeText","Data":"当一个事务执行写操作时，它会生成一个新的数据版本，并将修改后的数据写入数据库。具体工作情况如下："}]},{"ID":"20240201213522-9h2r0ct","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213522-9h2r0ct","updated":"20240201213522"},"Children":[{"ID":"20240201213523-2k4aexa","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213523-2k4aexa","updated":"20240201213523"},"Children":[{"ID":"20240201213524-tkutfmw","Type":"NodeParagraph","Properties":{"id":"20240201213524-tkutfmw","updated":"20240201213524"},"Children":[{"Type":"NodeText","Data":"对于写操作，事务会为要修改的数据行创建一个新的版本，并将修改后的数据写入新版本。"}]}]},{"ID":"20240201213525-92xvoyr","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213525-92xvoyr","updated":"20240201213525"},"Children":[{"ID":"20240201213526-ieixiy0","Type":"NodeParagraph","Properties":{"id":"20240201213526-ieixiy0","updated":"20240201213526"},"Children":[{"Type":"NodeText","Data":"新版本的数据会带有当前事务的版本号，以便其他事务能够正确读取相应版本的数据。"}]}]},{"ID":"20240201213527-7azn9y8","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213527-7azn9y8","updated":"20240201213527"},"Children":[{"ID":"20240201213528-njd6h6t","Type":"NodeParagraph","Properties":{"id":"20240201213528-njd6h6t","updated":"20240201213528"},"Children":[{"Type":"NodeText","Data":"原始版本的数据仍然存在，供其他事务使用快照读取，这保证了其他事务不受当前事务的写操作影响。"}]}]}]},{"ID":"20240201213529-meu3xyn","Type":"NodeParagraph","Properties":{"id":"20240201213529-meu3xyn","updated":"20240201213529"},"Children":[{"Type":"NodeText","Data":"3、事务提交和回滚："}]},{"ID":"20240201213530-4bj12ro","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213530-4bj12ro","updated":"20240201213530"},"Children":[{"ID":"20240201213531-vzyq2qu","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213531-vzyq2qu","updated":"20240201213531"},"Children":[{"ID":"20240201213532-7udh84t","Type":"NodeParagraph","Properties":{"id":"20240201213532-7udh84t","updated":"20240201213532"},"Children":[{"Type":"NodeText","Data":"当一个事务提交时，它所做的修改将成为数据库的最新版本，并且对其他事务可见。"}]}]},{"ID":"20240201213533-aj1os05","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213533-aj1os05","updated":"20240201213533"},"Children":[{"ID":"20240201213534-2przxqa","Type":"NodeParagraph","Properties":{"id":"20240201213534-2przxqa","updated":"20240201213534"},"Children":[{"Type":"NodeText","Data":"当一个事务回滚时，它所做的修改将被撤销，对其他事务不可见。"}]}]}]},{"ID":"20240201213535-7ttqvaj","Type":"NodeParagraph","Properties":{"id":"20240201213535-7ttqvaj","updated":"20240201213535"},"Children":[{"Type":"NodeText","Data":"4、版本的回收："}]},{"ID":"20240201213536-8csc9pz","Type":"NodeParagraph","Properties":{"id":"20240201213536-8csc9pz","updated":"20240201213536"},"Children":[{"Type":"NodeText","Data":"为了防止数据库中的版本无限增长，MVCC 会定期进行版本的回收。回收机制会删除已经不再需要的旧版本数据，从而释放空间。"}]},{"ID":"20240201213537-w8qcizk","Type":"NodeParagraph","Properties":{"id":"20240201213537-w8qcizk","updated":"20240201213537"},"Children":[{"Type":"NodeText","Data":"MVCC 通过创建数据的多个版本和使用快照读取来实现并发控制。读操作使用旧版本数据的快照，写操作创建新版本，并确保原始版本仍然可用。这样，不同的事务可以在一定程度上并发执行，而不会相互干扰，从而提高了数据库的并发性能和数据一致性。"}]},{"ID":"20240201213538-3jp7nhj","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213538-3jp7nhj","updated":"20240201213538"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"一致性非锁定读和锁定读"}]},{"ID":"20240201213539-8owsxhb","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213539-8owsxhb","updated":"20240201213539"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"一致性非锁定读"}]},{"ID":"20240201213540-d4k4wly","Type":"NodeParagraph","Properties":{"id":"20240201213540-d4k4wly","updated":"20240201213540"},"Children":[{"Type":"NodeText","Data":"对于 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a strong","TextMarkAHref":"https://dev.mysql.com/doc/refman/5.7/en/innodb-consistent-read.html","TextMarkTextContent":"一致性非锁定读（Consistent Nonlocking Reads）"},{"Type":"NodeText","Data":"的实现，通常做法是加一个版本号或者时间戳字段，在更新数据的同时版本号 + 1 或者更新时间戳。查询时，将当前可见的版本号与对应记录的版本号进行比对，如果记录的版本小于可见版本，则表示该记录可见"}]},{"ID":"20240201213541-iih6yca","Type":"NodeParagraph","Properties":{"id":"20240201213541-iih6yca","updated":"20240201213541"},"Children":[{"Type":"NodeText","Data":"在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 存储引擎中，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html","TextMarkTextContent":"多版本控制 (multi versioning)"},{"Type":"NodeText","Data":" 就是对非锁定读的实现。如果读取的行正在执行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DELETE"},{"Type":"NodeText","Data":" 或 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"UPDATE"},{"Type":"NodeText","Data":" 操作，这时读取操作不会去等待行上锁的释放。相反地，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 存储引擎会去读取行的一个快照数据，对于这种读取历史数据的方式，我们叫它快照读 (snapshot read)"}]},{"ID":"20240201213542-06u7ao9","Type":"NodeParagraph","Properties":{"id":"20240201213542-06u7ao9","updated":"20240201213542"},"Children":[{"Type":"NodeText","Data":"在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Repeatable Read"},{"Type":"NodeText","Data":" 和 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read Committed"},{"Type":"NodeText","Data":" 两个隔离级别下，如果是执行普通的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select"},{"Type":"NodeText","Data":" 语句（不包括 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select ... lock in share mode"},{"Type":"NodeText","Data":" ,"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select ... for update"},{"Type":"NodeText","Data":"）则会使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"一致性非锁定读（MVCC）"},{"Type":"NodeText","Data":"。并且在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Repeatable Read"},{"Type":"NodeText","Data":" 下 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MVCC"},{"Type":"NodeText","Data":" 实现了可重复读和防止部分幻读"}]},{"ID":"20240201213543-5zpv0n2","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213543-5zpv0n2","updated":"20240201213543"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"锁定读"}]},{"ID":"20240201213544-dqyfh9n","Type":"NodeParagraph","Properties":{"id":"20240201213544-dqyfh9n","updated":"20240201213544"},"Children":[{"Type":"NodeText","Data":"如果执行的是下列语句，就是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a strong","TextMarkAHref":"https://dev.mysql.com/doc/refman/5.7/en/innodb-locking-reads.html","TextMarkTextContent":"锁定读（Locking Reads）"}]},{"ID":"20240201213545-bcqlg5w","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213545-bcqlg5w","updated":"20240201213545"},"Children":[{"ID":"20240201213546-52bp7sr","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213546-52bp7sr","updated":"20240201213546"},"Children":[{"ID":"20240201213547-xw91k13","Type":"NodeParagraph","Properties":{"id":"20240201213547-xw91k13","updated":"20240201213547"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select ... lock in share mode"}]}]},{"ID":"20240201213548-9zsd3v4","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213548-9zsd3v4","updated":"20240201213548"},"Children":[{"ID":"20240201213549-b8qb8vv","Type":"NodeParagraph","Properties":{"id":"20240201213549-b8qb8vv","updated":"20240201213549"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select ... for update"}]}]},{"ID":"20240201213550-cky48qh","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213550-cky48qh","updated":"20240201213550"},"Children":[{"ID":"20240201213551-yt3gq4n","Type":"NodeParagraph","Properties":{"id":"20240201213551-yt3gq4n","updated":"20240201213551"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"update"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"delete"},{"Type":"NodeText","Data":" 操作"}]}]}]},{"ID":"20240201213552-jsakncx","Type":"NodeParagraph","Properties":{"id":"20240201213552-jsakncx","updated":"20240201213552"},"Children":[{"Type":"NodeText","Data":"在锁定读下，读取的是数据的最新版本，这种读也被称为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"当前读（current read）"},{"Type":"NodeText","Data":"。锁定读会对读取到的记录加锁："}]},{"ID":"20240201213553-cnwnnn9","Type":"NodeList","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213553-cnwnnn9","updated":"20240201213553"},"Children":[{"ID":"20240201213554-z3aq0pu","Type":"NodeListItem","Data":"-","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213554-z3aq0pu","updated":"20240201213554"},"Children":[{"ID":"20240201213555-9ptxmnq","Type":"NodeParagraph","Properties":{"id":"20240201213555-9ptxmnq","updated":"20240201213555"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select ... lock in share mode"},{"Type":"NodeText","Data":"：对记录加 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"S"},{"Type":"NodeText","Data":" 锁，其它事务也可以加"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"S"},{"Type":"NodeText","Data":"锁，如果加 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"x"},{"Type":"NodeText","Data":" 锁则会被阻塞"}]}]},{"ID":"20240201213556-7dyb0t7","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213556-7dyb0t7","updated":"20240201213556"},"Children":[{"ID":"20240201213557-mon331q","Type":"NodeParagraph","Properties":{"id":"20240201213557-mon331q","updated":"20240201213557"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select ... for update"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"update"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"delete"},{"Type":"NodeText","Data":"：对记录加 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"X"},{"Type":"NodeText","Data":" 锁，且其它事务不能加任何锁"}]}]}]},{"ID":"20240201213558-1s5f2h8","Type":"NodeParagraph","Properties":{"id":"20240201213558-1s5f2h8","updated":"20240201213558"},"Children":[{"Type":"NodeText","Data":"在一致性非锁定读下，即使读取的记录已被其它事务加上 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"X"},{"Type":"NodeText","Data":" 锁，这时记录也是可以被读取的，即读取的快照数据。上面说了，在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Repeatable Read"},{"Type":"NodeText","Data":" 下 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MVCC"},{"Type":"NodeText","Data":" 防止了部分幻读，这边的 “部分” 是指在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"一致性非锁定读"},{"Type":"NodeText","Data":" 情况下，只能读取到第一次查询之前所插入的数据（根据 Read View 判断数据可见性，Read View 在第一次查询时生成）。但是！如果是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"当前读"},{"Type":"NodeText","Data":" ，每次读取的都是最新数据，这时如果两次查询中间有其它事务插入数据，就会产生幻读。所以， "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"InnoDB"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" 在实现"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"Repeatable Read"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" 时，如果执行的是当前读，则会对读取的记录使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"Next-key Lock"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" ，来防止其它事务在间隙间插入数据"}]},{"ID":"20240201213559-7r4zuf1","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213559-7r4zuf1","updated":"20240201213559"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"InnoDB 对 MVCC 的实现"}]},{"ID":"20240201213560-9u5dys8","Type":"NodeParagraph","Properties":{"id":"20240201213560-9u5dys8","updated":"20240201213560"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MVCC"},{"Type":"NodeText","Data":" 的实现依赖于："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"隐藏字段、Read View、undo log"},{"Type":"NodeText","Data":"。在内部实现中，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 通过数据行的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 和 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 来判断数据的可见性，如不可见，则通过数据行的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_ROLL_PTR"},{"Type":"NodeText","Data":" 找到 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 中的历史版本。每个事务读到的数据版本可能是不一样的，在同一个事务中，用户只能看到该事务创建 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 之前已经提交的修改和该事务本身做的修改"}]},{"ID":"20240201213561-9528mfv","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213561-9528mfv","updated":"20240201213561"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"隐藏字段"}]},{"ID":"20240201213562-wk2lhta","Type":"NodeParagraph","Properties":{"id":"20240201213562-wk2lhta","updated":"20240201213562"},"Children":[{"Type":"NodeText","Data":"在内部，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 存储引擎为每行数据添加了三个 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html","TextMarkTextContent":"隐藏字段"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213563-t9hxj0m","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213563-t9hxj0m","updated":"20240201213563"},"Children":[{"ID":"20240201213564-37ui4y3","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213564-37ui4y3","updated":"20240201213564"},"Children":[{"ID":"20240201213565-xb6ejxw","Type":"NodeParagraph","Properties":{"id":"20240201213565-xb6ejxw","updated":"20240201213565"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID（6字节）"},{"Type":"NodeText","Data":"：表示最后一次插入或更新该行的事务 id。此外，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"delete"},{"Type":"NodeText","Data":" 操作在内部被视为更新，只不过会在记录头 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Record header"},{"Type":"NodeText","Data":" 中的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"deleted_flag"},{"Type":"NodeText","Data":" 字段将其标记为已删除"}]}]},{"ID":"20240201213566-1x1vcg6","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213566-1x1vcg6","updated":"20240201213566"},"Children":[{"ID":"20240201213567-sl45453","Type":"NodeParagraph","Properties":{"id":"20240201213567-sl45453","updated":"20240201213567"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_ROLL_PTR（7字节）"},{"Type":"NodeText","Data":" 回滚指针，指向该行的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 。如果该行未被更新，则为空"}]}]},{"ID":"20240201213568-w1qwhqh","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213568-w1qwhqh","updated":"20240201213568"},"Children":[{"ID":"20240201213569-qo1isva","Type":"NodeParagraph","Properties":{"id":"20240201213569-qo1isva","updated":"20240201213569"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_ROW_ID（6字节）"},{"Type":"NodeText","Data":"：如果没有设置主键且该表没有唯一非空索引时，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 会使用该 id 来生成聚簇索引"}]}]}]},{"ID":"20240201213570-h4e0rlb","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213570-h4e0rlb","updated":"20240201213570"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"ReadView"}]},{"ID":"20240201213571-du1ja9p","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Yw==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213571-du1ja9p","updated":"20240201213571"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"class ReadView {\n  /* ... */\nprivate:\n  trx_id_t m_low_limit_id;      /* 大于等于这个 ID 的事务均不可见 */\n\n  trx_id_t m_up_limit_id;       /* 小于这个 ID 的事务均可见 */\n\n  trx_id_t m_creator_trx_id;    /* 创建该 Read View 的事务ID */\n\n  trx_id_t m_low_limit_no;      /* 事务 Number, 小于该 Number 的 Undo Logs 均可以被 Purge */\n\n  ids_t m_ids;                  /* 创建 Read View 时的活跃事务列表 */\n\n  m_closed;                     /* 标记 Read View 是否 close */\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213572-83v0ino","Type":"NodeParagraph","Properties":{"id":"20240201213572-83v0ino","updated":"20240201213572"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a code","TextMarkAHref":"https://github.com/facebook/mysql-8.0/blob/8.0/storage/innobase/include/read0types.h#L298","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 主要是用来做可见性判断，里面保存了 “当前对本事务不可见的其他活跃事务”"}]},{"ID":"20240201213573-qfaajid","Type":"NodeParagraph","Properties":{"id":"20240201213573-qfaajid","updated":"20240201213573"},"Children":[{"Type":"NodeText","Data":"主要有以下字段："}]},{"ID":"20240201213574-pt9shgu","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213574-pt9shgu","updated":"20240201213574"},"Children":[{"ID":"20240201213575-wji3e4q","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213575-wji3e4q","updated":"20240201213575"},"Children":[{"ID":"20240201213576-6zi1h71","Type":"NodeParagraph","Properties":{"id":"20240201213576-6zi1h71","updated":"20240201213576"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_low_limit_id"},{"Type":"NodeText","Data":"：目前出现过的最大的事务 ID+1，即下一个将被分配的事务 ID。大于等于这个 ID 的数据版本均不可见"}]}]},{"ID":"20240201213577-2zpyxe1","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213577-2zpyxe1","updated":"20240201213577"},"Children":[{"ID":"20240201213578-hjh1j1o","Type":"NodeParagraph","Properties":{"id":"20240201213578-hjh1j1o","updated":"20240201213578"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_up_limit_id"},{"Type":"NodeText","Data":"：活跃事务列表 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":" 中最小的事务 ID，如果 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":" 为空，则 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_up_limit_id"},{"Type":"NodeText","Data":" 为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_low_limit_id"},{"Type":"NodeText","Data":"。小于这个 ID 的数据版本均可见"}]}]},{"ID":"20240201213579-yq9qi7e","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213579-yq9qi7e","updated":"20240201213579"},"Children":[{"ID":"20240201213580-39rht3d","Type":"NodeParagraph","Properties":{"id":"20240201213580-39rht3d","updated":"20240201213580"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":"："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 创建时其他未提交的活跃事务 ID 列表。创建 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":"时，将当前未提交事务 ID 记录下来，后续即使它们修改了记录行的值，对于当前事务也是不可见的。"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":" 不包括当前事务自己和已提交的事务（正在内存中）"}]}]},{"ID":"20240201213581-0ktsj7t","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213581-0ktsj7t","updated":"20240201213581"},"Children":[{"ID":"20240201213582-0v35xtf","Type":"NodeParagraph","Properties":{"id":"20240201213582-0v35xtf","updated":"20240201213582"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_creator_trx_id"},{"Type":"NodeText","Data":"：创建该 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 的事务 ID"}]}]}]},{"ID":"20240201213583-9l69suu","Type":"NodeParagraph","Properties":{"id":"20240201213583-9l69suu","updated":"20240201213583"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"事务可见性示意图"},{"Type":"NodeText","Data":"（"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://leviathan.vip/2019/03/20/InnoDB%E7%9A%84%E4%BA%8B%E5%8A%A1%E5%88%86%E6%9E%90-MVCC/#MVCC-1","TextMarkTextContent":"图源"},{"Type":"NodeText","Data":"）："}]},{"ID":"20240201213584-gi3cfix","Type":"NodeParagraph","Properties":{"id":"20240201213584-gi3cfix","updated":"20240201213584"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"trans_visible","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/trans_visible-20240201213826-2btpt13.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213585-1ndvjy8","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213585-1ndvjy8","updated":"20240201213585"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"undo-log"}]},{"ID":"20240201213586-lecwq3i","Type":"NodeParagraph","Properties":{"id":"20240201213586-lecwq3i","updated":"20240201213586"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 主要有两个作用："}]},{"ID":"20240201213587-drxg99y","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213587-drxg99y","updated":"20240201213587"},"Children":[{"ID":"20240201213588-cx28efi","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213588-cx28efi","updated":"20240201213588"},"Children":[{"ID":"20240201213589-to5ak1e","Type":"NodeParagraph","Properties":{"id":"20240201213589-to5ak1e","updated":"20240201213589"},"Children":[{"Type":"NodeText","Data":"当事务回滚时用于将数据恢复到修改前的样子"}]}]},{"ID":"20240201213590-zsp3cz6","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213590-zsp3cz6","updated":"20240201213590"},"Children":[{"ID":"20240201213591-o14uso0","Type":"NodeParagraph","Properties":{"id":"20240201213591-o14uso0","updated":"20240201213591"},"Children":[{"Type":"NodeText","Data":"另一个作用是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MVCC"},{"Type":"NodeText","Data":" ，当读取记录时，若该记录被其他事务占用或当前版本对该事务不可见，则可以通过 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 读取之前的版本数据，以此实现非锁定读"}]}]}]},{"ID":"20240201213592-qio8ko7","Type":"NodeParagraph","Properties":{"id":"20240201213592-qio8ko7","updated":"20240201213592"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"InnoDB"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" 存储引擎中 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"undo log"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" 分为两种："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"insert undo log"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" 和 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"update undo log"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"："}]},{"ID":"20240201213593-ynqljo7","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213593-ynqljo7","updated":"20240201213593"},"Children":[{"ID":"20240201213594-a8r64wf","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213594-a8r64wf","updated":"20240201213594"},"Children":[{"ID":"20240201213595-6d435du","Type":"NodeParagraph","Properties":{"id":"20240201213595-6d435du","updated":"20240201213595"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"insert undo log"},{"Type":"NodeText","Data":"：指在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert"},{"Type":"NodeText","Data":" 操作中产生的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":"。因为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert"},{"Type":"NodeText","Data":" 操作的记录只对事务本身可见，对其他事务不可见，故该 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 可以在事务提交后直接删除。不需要进行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"purge"},{"Type":"NodeText","Data":" 操作"}]}]}]},{"ID":"20240201213596-8cqoe88","Type":"NodeParagraph","Properties":{"id":"20240201213596-8cqoe88","updated":"20240201213596"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"insert"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" 时的数据初始状态："}]},{"ID":"20240201213597-g21ghf2","Type":"NodeParagraph","Properties":{"id":"20240201213597-g21ghf2","updated":"20240201213597"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/317e91e1-1ee1-42ad-9412-9098d5c6a9ad-20240201213826-rb24eiw.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213598-9w8t6ru","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213598-9w8t6ru","updated":"20240201213598"},"Children":[{"ID":"20240201213599-9oihk7d","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213599-9oihk7d","updated":"20240201213599"},"Children":[{"ID":"20240201213600-0mndxyx","Type":"NodeParagraph","Properties":{"id":"20240201213600-0mndxyx","updated":"20240201213600"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"update undo log"},{"Type":"NodeText","Data":"："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"update"},{"Type":"NodeText","Data":" 或 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"delete"},{"Type":"NodeText","Data":" 操作中产生的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":"。该 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":"可能需要提供 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MVCC"},{"Type":"NodeText","Data":" 机制，因此不能在事务提交时就进行删除。提交时放入 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 链表，等待 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"purge线程"},{"Type":"NodeText","Data":" 进行最后的删除"}]}]}]},{"ID":"20240201213601-rsfhxte","Type":"NodeParagraph","Properties":{"id":"20240201213601-rsfhxte","updated":"20240201213601"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"数据第一次被修改时："}]},{"ID":"20240201213602-bfzbw85","Type":"NodeParagraph","Properties":{"id":"20240201213602-bfzbw85","updated":"20240201213602"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/c52ff79f-10e6-46cb-b5d4-3c9cbcc1934a-20240201213826-dmuwiwf.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213603-l2bni9c","Type":"NodeParagraph","Properties":{"id":"20240201213603-l2bni9c","updated":"20240201213603"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"数据第二次被修改时："}]},{"ID":"20240201213604-a2qmeo3","Type":"NodeParagraph","Properties":{"id":"20240201213604-a2qmeo3","updated":"20240201213604"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/6a276e7a-b0da-4c7b-bdf7-c0c7b7b3b31c-20240201213826-waflk55.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213605-3c1vqz6","Type":"NodeParagraph","Properties":{"id":"20240201213605-3c1vqz6","updated":"20240201213605"},"Children":[{"Type":"NodeText","Data":"不同事务或者相同事务的对同一记录行的修改，会使该记录行的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 成为一条链表，链首就是最新的记录，链尾就是最早的旧记录。"}]},{"ID":"20240201213606-ytmgrz0","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213606-ytmgrz0","updated":"20240201213606"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"数据可见性算法"}]},{"ID":"20240201213607-bugps46","Type":"NodeParagraph","Properties":{"id":"20240201213607-bugps46","updated":"20240201213607"},"Children":[{"Type":"NodeText","Data":"在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 存储引擎中，创建一个新事务后，执行每个 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select"},{"Type":"NodeText","Data":" 语句前，都会创建一个快照（Read View），"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"快照中保存了当前数据库系统中正处于活跃（没有 commit）的事务的 ID 号"},{"Type":"NodeText","Data":"。其实简单的说保存的是系统中当前不应该被本事务看到的其他事务 ID 列表（即 m_ids）。当用户在这个事务中要读取某个记录行的时候，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 会将该记录行的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 与 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 中的一些变量及当前事务 ID 进行比较，判断是否满足可见性条件"}]},{"ID":"20240201213608-n8kv3vx","Type":"NodeParagraph","Properties":{"id":"20240201213608-n8kv3vx","updated":"20240201213608"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://github.com/facebook/mysql-8.0/blob/8.0/storage/innobase/include/read0types.h#L161","TextMarkTextContent":"具体的比较算法"},{"Type":"NodeText","Data":"如下("},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://leviathan.vip/2019/03/20/InnoDB%E7%9A%84%E4%BA%8B%E5%8A%A1%E5%88%86%E6%9E%90-MVCC/#MVCC-1","TextMarkTextContent":"图源"},{"Type":"NodeText","Data":")："}]},{"ID":"20240201213609-q1ljat1","Type":"NodeParagraph","Properties":{"id":"20240201213609-q1ljat1","updated":"20240201213609"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/8778836b-34a8-480b-b8c7-654fe207a8c2-20240201213826-kdt8sej.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213610-nblma80","Type":"NodeList","ListData":{"Typ":1,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213610-nblma80","updated":"20240201213610"},"Children":[{"ID":"20240201213611-s2hsk2h","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213611-s2hsk2h","updated":"20240201213611"},"Children":[{"ID":"20240201213612-e04f16y","Type":"NodeParagraph","Properties":{"id":"20240201213612-e04f16y","updated":"20240201213612"},"Children":[{"Type":"NodeText","Data":"如果记录 DB_TRX_ID \u003c m_up_limit_id，那么表明最新修改该行的事务（DB_TRX_ID）在当前事务创建快照之前就提交了，所以该记录行的值对当前事务是可见的"}]}]},{"ID":"20240201213613-ywxh7da","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213613-ywxh7da","updated":"20240201213613"},"Children":[{"ID":"20240201213614-mxyrthg","Type":"NodeParagraph","Properties":{"id":"20240201213614-mxyrthg","updated":"20240201213614"},"Children":[{"Type":"NodeText","Data":"如果 DB_TRX_ID \u003e= m_low_limit_id，那么表明最新修改该行的事务（DB_TRX_ID）在当前事务创建快照之后才修改该行，所以该记录行的值对当前事务不可见。跳到步骤 5"}]}]},{"ID":"20240201213615-abqd0k5","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213615-abqd0k5","updated":"20240201213615"},"Children":[{"ID":"20240201213616-n8c2b82","Type":"NodeParagraph","Properties":{"id":"20240201213616-n8c2b82","updated":"20240201213616"},"Children":[{"Type":"NodeText","Data":"m_ids 为空，则表明在当前事务创建快照之前，修改该行的事务就已经提交了，所以该记录行的值对当前事务是可见的"}]}]},{"ID":"20240201213617-6q9zemd","Type":"NodeListItem","Data":"4","ListData":{"Typ":1,"Tight":true,"Start":4,"Delimiter":46,"Padding":3,"Marker":"NA==","Num":4},"Properties":{"id":"20240201213617-6q9zemd","updated":"20240201213617"},"Children":[{"ID":"20240201213618-3m1njlf","Type":"NodeParagraph","Properties":{"id":"20240201213618-3m1njlf","updated":"20240201213618"},"Children":[{"Type":"NodeText","Data":"如果 m_up_limit_id \u003c= DB_TRX_ID \u003c m_low_limit_id，表明最新修改该行的事务（DB_TRX_ID）在当前事务创建快照的时候可能处于“活动状态”或者“已提交状态”；所以就要对活跃事务列表 m_ids 进行查找（源码中是用的二分查找，因为是有序的）"}]},{"ID":"20240201213619-7h6bdk3","Type":"NodeList","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213619-7h6bdk3","updated":"20240201213619"},"Children":[{"ID":"20240201213620-szrivfo","Type":"NodeListItem","Data":"-","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213620-szrivfo","updated":"20240201213620"},"Children":[{"ID":"20240201213621-x0rme7y","Type":"NodeParagraph","Properties":{"id":"20240201213621-x0rme7y","updated":"20240201213621"},"Children":[{"Type":"NodeText","Data":"如果在活跃事务列表 m_ids 中能找到 DB_TRX_ID，表明：① 在当前事务创建快照前，该记录行的值被事务 ID 为 DB_TRX_ID 的事务修改了，但没有提交；或者 ② 在当前事务创建快照后，该记录行的值被事务 ID 为 DB_TRX_ID 的事务修改了。这些情况下，这个记录行的值对当前事务都是不可见的。跳到步骤 5"}]}]},{"ID":"20240201213622-s18pi9d","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213622-s18pi9d","updated":"20240201213622"},"Children":[{"ID":"20240201213623-z0jsllv","Type":"NodeParagraph","Properties":{"id":"20240201213623-z0jsllv","updated":"20240201213623"},"Children":[{"Type":"NodeText","Data":"在活跃事务列表中找不到，则表明“id 为 trx_id 的事务”在修改“该记录行的值”后，在“当前事务”创建快照前就已经提交了，所以记录行对当前事务可见"}]}]}]}]},{"ID":"20240201213624-y6m097i","Type":"NodeListItem","Data":"5","ListData":{"Typ":1,"Tight":true,"Start":5,"Delimiter":46,"Padding":3,"Marker":"NQ==","Num":5},"Properties":{"id":"20240201213624-y6m097i","updated":"20240201213624"},"Children":[{"ID":"20240201213625-1b5j01d","Type":"NodeParagraph","Properties":{"id":"20240201213625-1b5j01d","updated":"20240201213625"},"Children":[{"Type":"NodeText","Data":"在该记录行的 DB_ROLL_PTR 指针所指向的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 取出快照记录，用快照记录的 DB_TRX_ID 跳到步骤 1 重新开始判断，直到找到满足的快照版本或返回空"}]}]}]},{"ID":"20240201213626-fal4ads","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213626-fal4ads","updated":"20240201213626"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"RC 和 RR 隔离级别下 MVCC 的差异"}]},{"ID":"20240201213627-285z2nq","Type":"NodeParagraph","Properties":{"id":"20240201213627-285z2nq","updated":"20240201213627"},"Children":[{"Type":"NodeText","Data":"在事务隔离级别 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"RC"},{"Type":"NodeText","Data":" 和 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"RR"},{"Type":"NodeText","Data":" （InnoDB 存储引擎的默认事务隔离级别）下，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 存储引擎使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MVCC"},{"Type":"NodeText","Data":"（非锁定一致性读），但它们生成 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 的时机却不同"}]},{"ID":"20240201213628-01ttkrb","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213628-01ttkrb","updated":"20240201213628"},"Children":[{"ID":"20240201213629-kppxbbb","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213629-kppxbbb","updated":"20240201213629"},"Children":[{"ID":"20240201213630-3naolsh","Type":"NodeParagraph","Properties":{"id":"20240201213630-3naolsh","updated":"20240201213630"},"Children":[{"Type":"NodeText","Data":"在 RC 隔离级别下的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"每次select"},{"Type":"NodeText","Data":" 查询前都生成一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" (m_ids 列表)"}]}]},{"ID":"20240201213631-v3w7ep9","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213631-v3w7ep9","updated":"20240201213631"},"Children":[{"ID":"20240201213632-eycwljg","Type":"NodeParagraph","Properties":{"id":"20240201213632-eycwljg","updated":"20240201213632"},"Children":[{"Type":"NodeText","Data":"在 RR 隔离级别下只在事务开始后 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"第一次select"},{"Type":"NodeText","Data":" 数据前生成一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":"（m_ids 列表）"}]}]}]},{"ID":"20240201213633-r3451jh","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213633-r3451jh","updated":"20240201213633"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"MVCC 解决不可重复读问题"}]},{"ID":"20240201213634-m4vvfdz","Type":"NodeParagraph","Properties":{"id":"20240201213634-m4vvfdz","updated":"20240201213634"},"Children":[{"Type":"NodeText","Data":"虽然 RC 和 RR 都通过 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MVCC"},{"Type":"NodeText","Data":" 来读取快照数据，但由于 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"生成 Read View 时机不同"},{"Type":"NodeText","Data":"，从而在 RR 级别下实现可重复读"}]},{"ID":"20240201213635-qfzp8pn","Type":"NodeParagraph","Properties":{"id":"20240201213635-qfzp8pn","updated":"20240201213635"},"Children":[{"Type":"NodeText","Data":"举个例子："}]},{"ID":"20240201213636-dk02jxd","Type":"NodeParagraph","Properties":{"id":"20240201213636-dk02jxd","updated":"20240201213636"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/6fb2b9a1-5f14-4dec-a797-e4cf388ed413-20240201213826-cuo68kr.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213637-dr7atgt","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213637-dr7atgt","updated":"20240201213637"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"在 RC 下 ReadView 生成情况"}]},{"ID":"20240201213638-2bebyhc","Type":"NodeParagraph","Properties":{"id":"20240201213638-2bebyhc","updated":"20240201213638"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"1. 假设时间线来到 T4 ，那么此时数据行 id = 1 的版本链为："}]},{"ID":"20240201213639-0w1gl1b","Type":"NodeParagraph","Properties":{"id":"20240201213639-0w1gl1b","updated":"20240201213639"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/a3fd1ec6-8f37-42fa-b090-7446d488fd04-20240201213826-06p413k.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213640-el8axy7","Type":"NodeParagraph","Properties":{"id":"20240201213640-el8axy7","updated":"20240201213640"},"Children":[{"Type":"NodeText","Data":"由于 RC 级别下每次查询都会生成"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" ，并且事务 101、102 并未提交，此时 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"103"},{"Type":"NodeText","Data":" 事务生成的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 中活跃的事务 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"m_ids"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" 为：[101,102]"},{"Type":"NodeText","Data":" ，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_low_limit_id"},{"Type":"NodeText","Data":"为：104，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_up_limit_id"},{"Type":"NodeText","Data":"为：101，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_creator_trx_id"},{"Type":"NodeText","Data":" 为：103"}]},{"ID":"20240201213641-cw56gnk","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213641-cw56gnk","updated":"20240201213641"},"Children":[{"ID":"20240201213642-kq3gznw","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213642-kq3gznw","updated":"20240201213642"},"Children":[{"ID":"20240201213643-zkwmshh","Type":"NodeParagraph","Properties":{"id":"20240201213643-zkwmshh","updated":"20240201213643"},"Children":[{"Type":"NodeText","Data":"此时最新记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 为 101，m_up_limit_id \u003c= 101 \u003c m_low_limit_id，所以要在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":" 列表中查找，发现 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 存在列表中，那么这个记录不可见"}]}]},{"ID":"20240201213644-gmunn6o","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213644-gmunn6o","updated":"20240201213644"},"Children":[{"ID":"20240201213645-tev3qcy","Type":"NodeParagraph","Properties":{"id":"20240201213645-tev3qcy","updated":"20240201213645"},"Children":[{"Type":"NodeText","Data":"根据 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_ROLL_PTR"},{"Type":"NodeText","Data":" 找到 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 中的上一版本记录，上一条记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 还是 101，不可见"}]}]},{"ID":"20240201213646-6khuk47","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213646-6khuk47","updated":"20240201213646"},"Children":[{"ID":"20240201213647-yc9eiat","Type":"NodeParagraph","Properties":{"id":"20240201213647-yc9eiat","updated":"20240201213647"},"Children":[{"Type":"NodeText","Data":"继续找上一条 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":"为 1，满足 1 \u003c m_up_limit_id，可见，所以事务 103 查询到数据为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"name = 菜花"}]}]}]},{"ID":"20240201213648-igxobwb","Type":"NodeParagraph","Properties":{"id":"20240201213648-igxobwb","updated":"20240201213648"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"2. 时间线来到 T6 ，数据的版本链为："}]},{"ID":"20240201213649-wnsmqrf","Type":"NodeParagraph","Properties":{"id":"20240201213649-wnsmqrf","updated":"20240201213649"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/528559e9-dae8-4d14-b78d-a5b657c88391-20240201213826-ugz0n0t.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213650-g66jwvu","Type":"NodeParagraph","Properties":{"id":"20240201213650-g66jwvu","updated":"20240201213650"},"Children":[{"Type":"NodeText","Data":"因为在 RC 级别下，重新生成 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":"，这时事务 101 已经提交，102 并未提交，所以此时 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 中活跃的事务 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"m_ids"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"：[102]"},{"Type":"NodeText","Data":" ，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_low_limit_id"},{"Type":"NodeText","Data":"为：104，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_up_limit_id"},{"Type":"NodeText","Data":"为：102，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_creator_trx_id"},{"Type":"NodeText","Data":"为：103"}]},{"ID":"20240201213651-epf3v90","Type":"NodeList","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213651-epf3v90","updated":"20240201213651"},"Children":[{"ID":"20240201213652-a16lakd","Type":"NodeListItem","Data":"-","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213652-a16lakd","updated":"20240201213652"},"Children":[{"ID":"20240201213653-uygepfs","Type":"NodeParagraph","Properties":{"id":"20240201213653-uygepfs","updated":"20240201213653"},"Children":[{"Type":"NodeText","Data":"此时最新记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 为 102，m_up_limit_id \u003c= 102 \u003c m_low_limit_id，所以要在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":" 列表中查找，发现 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 存在列表中，那么这个记录不可见"}]}]},{"ID":"20240201213654-5m1pu7d","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213654-5m1pu7d","updated":"20240201213654"},"Children":[{"ID":"20240201213655-jbjjyoh","Type":"NodeParagraph","Properties":{"id":"20240201213655-jbjjyoh","updated":"20240201213655"},"Children":[{"Type":"NodeText","Data":"根据 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_ROLL_PTR"},{"Type":"NodeText","Data":" 找到 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 中的上一版本记录，上一条记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 为 101，满足 101 \u003c m_up_limit_id，记录可见，所以在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"T6"},{"Type":"NodeText","Data":" 时间点查询到数据为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"name = 李四"},{"Type":"NodeText","Data":"，与时间 T4 查询到的结果不一致，不可重复读！"}]}]}]},{"ID":"20240201213656-yf8lean","Type":"NodeParagraph","Properties":{"id":"20240201213656-yf8lean","updated":"20240201213656"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"3. 时间线来到 T9 ，数据的版本链为："}]},{"ID":"20240201213657-ntyek50","Type":"NodeParagraph","Properties":{"id":"20240201213657-ntyek50","updated":"20240201213657"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/6f82703c-36a1-4458-90fe-d7f4edbac71a-20240201213826-nu6fw0l.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213658-y66r8ix","Type":"NodeParagraph","Properties":{"id":"20240201213658-y66r8ix","updated":"20240201213658"},"Children":[{"Type":"NodeText","Data":"重新生成 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":"， 这时事务 101 和 102 都已经提交，所以 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":" 为空，则 m_up_limit_id = m_low_limit_id = 104，最新版本事务 ID 为 102，满足 102 \u003c m_low_limit_id，可见，查询结果为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"name = 赵六"}]},{"ID":"20240201213659-tqzbawu","Type":"NodeBlockquote","Properties":{"id":"20240201213659-tqzbawu","updated":"20240201213659"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e ","Properties":{"id":""}},{"ID":"20240201213660-dh0aynx","Type":"NodeParagraph","Properties":{"id":"20240201213660-dh0aynx","updated":"20240201213660"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"总结："},{"Type":"NodeText","Data":" "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"在 RC 隔离级别下，事务在每次查询开始时都会生成并设置新的 Read View，所以导致不可重复读"}]}]},{"ID":"20240201213661-r0fbibm","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213661-r0fbibm","updated":"20240201213661"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"在 RR 下 ReadView 生成情况"}]},{"ID":"20240201213662-ouo22i0","Type":"NodeParagraph","Properties":{"id":"20240201213662-ouo22i0","updated":"20240201213662"},"Children":[{"Type":"NodeText","Data":"在可重复读级别下，只会在事务开始后第一次读取数据时生成一个 Read View（m_ids 列表）"}]},{"ID":"20240201213663-nday00n","Type":"NodeParagraph","Properties":{"id":"20240201213663-nday00n","updated":"20240201213663"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"1. 在 T4 情况下的版本链为："}]},{"ID":"20240201213664-ggtorom","Type":"NodeParagraph","Properties":{"id":"20240201213664-ggtorom","updated":"20240201213664"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/0e906b95-c916-4f30-beda-9cb3e49746bf-20240201213826-fbysw5g.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213665-mhav5hp","Type":"NodeParagraph","Properties":{"id":"20240201213665-mhav5hp","updated":"20240201213665"},"Children":[{"Type":"NodeText","Data":"在当前执行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"select"},{"Type":"NodeText","Data":" 语句时生成一个 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":"，此时 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"m_ids"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"：[101,102]"},{"Type":"NodeText","Data":" ，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_low_limit_id"},{"Type":"NodeText","Data":"为：104，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_up_limit_id"},{"Type":"NodeText","Data":"为：101，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_creator_trx_id"},{"Type":"NodeText","Data":" 为：103"}]},{"ID":"20240201213666-ioux7hp","Type":"NodeParagraph","Properties":{"id":"20240201213666-ioux7hp","updated":"20240201213666"},"Children":[{"Type":"NodeText","Data":"此时和 RC 级别下一样："}]},{"ID":"20240201213667-iot3oyl","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213667-iot3oyl","updated":"20240201213667"},"Children":[{"ID":"20240201213668-j7fvbhd","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213668-j7fvbhd","updated":"20240201213668"},"Children":[{"ID":"20240201213669-djy7qrs","Type":"NodeParagraph","Properties":{"id":"20240201213669-djy7qrs","updated":"20240201213669"},"Children":[{"Type":"NodeText","Data":"最新记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 为 101，m_up_limit_id \u003c= 101 \u003c m_low_limit_id，所以要在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":" 列表中查找，发现 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 存在列表中，那么这个记录不可见"}]}]},{"ID":"20240201213670-7je8fwy","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213670-7je8fwy","updated":"20240201213670"},"Children":[{"ID":"20240201213671-o1i58rt","Type":"NodeParagraph","Properties":{"id":"20240201213671-o1i58rt","updated":"20240201213671"},"Children":[{"Type":"NodeText","Data":"根据 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_ROLL_PTR"},{"Type":"NodeText","Data":" 找到 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 中的上一版本记录，上一条记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 还是 101，不可见"}]}]},{"ID":"20240201213672-vottgb1","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213672-vottgb1","updated":"20240201213672"},"Children":[{"ID":"20240201213673-o7co4gh","Type":"NodeParagraph","Properties":{"id":"20240201213673-o7co4gh","updated":"20240201213673"},"Children":[{"Type":"NodeText","Data":"继续找上一条 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":"为 1，满足 1 \u003c m_up_limit_id，可见，所以事务 103 查询到数据为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"name = 菜花"}]}]}]},{"ID":"20240201213674-u2f5d7r","Type":"NodeParagraph","Properties":{"id":"20240201213674-u2f5d7r","updated":"20240201213674"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"2. 时间点 T6 情况下："}]},{"ID":"20240201213675-5y4nrg8","Type":"NodeParagraph","Properties":{"id":"20240201213675-5y4nrg8","updated":"20240201213675"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/79ed6142-7664-4e0b-9023-cf546586aa39-20240201213826-bpd2fdf.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213676-88x1y5c","Type":"NodeParagraph","Properties":{"id":"20240201213676-88x1y5c","updated":"20240201213676"},"Children":[{"Type":"NodeText","Data":"在 RR 级别下只会生成一次"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":"，所以此时依然沿用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"m_ids"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"：[101,102]"},{"Type":"NodeText","Data":" ，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_low_limit_id"},{"Type":"NodeText","Data":"为：104，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_up_limit_id"},{"Type":"NodeText","Data":"为：101，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_creator_trx_id"},{"Type":"NodeText","Data":" 为：103"}]},{"ID":"20240201213677-i4hhav4","Type":"NodeList","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213677-i4hhav4","updated":"20240201213677"},"Children":[{"ID":"20240201213678-ax0ubyz","Type":"NodeListItem","Data":"-","ListData":{"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213678-ax0ubyz","updated":"20240201213678"},"Children":[{"ID":"20240201213679-tzzoumk","Type":"NodeParagraph","Properties":{"id":"20240201213679-tzzoumk","updated":"20240201213679"},"Children":[{"Type":"NodeText","Data":"最新记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 为 102，m_up_limit_id \u003c= 102 \u003c m_low_limit_id，所以要在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"m_ids"},{"Type":"NodeText","Data":" 列表中查找，发现 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 存在列表中，那么这个记录不可见"}]}]},{"ID":"20240201213680-8nuleoy","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213680-8nuleoy","updated":"20240201213680"},"Children":[{"ID":"20240201213681-h2y2kj0","Type":"NodeParagraph","Properties":{"id":"20240201213681-h2y2kj0","updated":"20240201213681"},"Children":[{"Type":"NodeText","Data":"根据 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_ROLL_PTR"},{"Type":"NodeText","Data":" 找到 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 中的上一版本记录，上一条记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 为 101，不可见"}]}]},{"ID":"20240201213682-ad8qsfk","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213682-ad8qsfk","updated":"20240201213682"},"Children":[{"ID":"20240201213683-wge1mdw","Type":"NodeParagraph","Properties":{"id":"20240201213683-wge1mdw","updated":"20240201213683"},"Children":[{"Type":"NodeText","Data":"继续根据 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_ROLL_PTR"},{"Type":"NodeText","Data":" 找到 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"undo log"},{"Type":"NodeText","Data":" 中的上一版本记录，上一条记录的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":" 还是 101，不可见"}]}]},{"ID":"20240201213684-1l29jrk","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213684-1l29jrk","updated":"20240201213684"},"Children":[{"ID":"20240201213685-l4ec431","Type":"NodeParagraph","Properties":{"id":"20240201213685-l4ec431","updated":"20240201213685"},"Children":[{"Type":"NodeText","Data":"继续找上一条 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"DB_TRX_ID"},{"Type":"NodeText","Data":"为 1，满足 1 \u003c m_up_limit_id，可见，所以事务 103 查询到数据为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"name = 菜花"}]}]}]},{"ID":"20240201213686-7jkc21l","Type":"NodeParagraph","Properties":{"id":"20240201213686-7jkc21l","updated":"20240201213686"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"3. 时间点 T9 情况下："}]},{"ID":"20240201213687-ckkdfe9","Type":"NodeParagraph","Properties":{"id":"20240201213687-ckkdfe9","updated":"20240201213687"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/cbbedbc5-0e3c-4711-aafd-7f3d68a4ed4e-20240201213826-84bz660.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213688-hag5vt0","Type":"NodeParagraph","Properties":{"id":"20240201213688-hag5vt0","updated":"20240201213688"},"Children":[{"Type":"NodeText","Data":"此时情况跟 T6 完全一样，由于已经生成了 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":"，此时依然沿用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"m_ids"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"：[101,102]"},{"Type":"NodeText","Data":" ，所以查询结果依然是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"name = 菜花"}]},{"ID":"20240201213689-l8tyrn3","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213689-l8tyrn3","updated":"20240201213689"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"MVCC➕Next-key-Lock 防止幻读"}]},{"ID":"20240201213690-winjda8","Type":"NodeParagraph","Properties":{"id":"20240201213690-winjda8","updated":"20240201213690"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":"存储引擎在 RR 级别下通过 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MVCC"},{"Type":"NodeText","Data":"和 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Next-key Lock"},{"Type":"NodeText","Data":" 来解决幻读问题："}]},{"ID":"20240201213691-qdrf3eg","Type":"NodeParagraph","Properties":{"id":"20240201213691-qdrf3eg","updated":"20240201213691"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"1、执行普通 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"select"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"，此时会以 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong code","TextMarkTextContent":"MVCC"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":" 快照读的方式读取数据"}]},{"ID":"20240201213692-lkx423r","Type":"NodeParagraph","Properties":{"id":"20240201213692-lkx423r","updated":"20240201213692"},"Children":[{"Type":"NodeText","Data":"在快照读的情况下，RR 隔离级别只会在事务开启后的第一次查询生成 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" ，并使用至事务提交。所以在生成 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Read View"},{"Type":"NodeText","Data":" 之后其它事务所做的更新、插入记录版本对当前事务并不可见，实现了可重复读和防止快照读下的 “幻读”"}]},{"ID":"20240201213693-ysjel9y","Type":"NodeParagraph","Properties":{"id":"20240201213693-ysjel9y","updated":"20240201213693"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"2、执行 select...for update/lock in share mode、insert、update、delete 等当前读"}]},{"ID":"20240201213694-6q2ubig","Type":"NodeParagraph","Properties":{"id":"20240201213694-6q2ubig","updated":"20240201213694"},"Children":[{"Type":"NodeText","Data":"在当前读下，读取的都是最新的数据，如果其它事务有插入新的记录，并且刚好在当前事务查询范围内，就会产生幻读！"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InnoDB"},{"Type":"NodeText","Data":" 使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-next-key-locks","TextMarkTextContent":"Next-key Lock"},{"Type":"NodeText","Data":" 来防止这种情况。当执行当前读时，会锁定读取到的记录的同时，锁定它们的间隙，防止其它事务在查询范围内插入数据。只要我不让你插入，就不会发生幻读"}]},{"ID":"20240201213695-811miqv","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213695-811miqv","updated":"20240201213695"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"参考"}]},{"ID":"20240201213696-z2zysyh","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213696-z2zysyh","updated":"20240201213696"},"Children":[{"ID":"20240201213697-ai6qehq","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213697-ai6qehq","updated":"20240201213697"},"Children":[{"ID":"20240201213698-gpa3x00","Type":"NodeParagraph","Properties":{"id":"20240201213698-gpa3x00","updated":"20240201213698"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"《MySQL 技术内幕 InnoDB 存储引擎第 2 版》"}]}]},{"ID":"20240201213699-8ns7nrk","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213699-8ns7nrk","updated":"20240201213699"},"Children":[{"ID":"20240201213700-v7tei4p","Type":"NodeParagraph","Properties":{"id":"20240201213700-v7tei4p","updated":"20240201213700"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://tech.meituan.com/2014/08/20/innodb-lock.html","TextMarkTextContent":"Innodb 中的事务隔离级别和锁的关系"}]}]},{"ID":"20240201213701-csn99i2","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213701-csn99i2","updated":"20240201213701"},"Children":[{"ID":"20240201213702-jh09ct2","Type":"NodeParagraph","Properties":{"id":"20240201213702-jh09ct2","updated":"20240201213702"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://blog.csdn.net/qq_35190492/article/details/109044141","TextMarkTextContent":"MySQL 事务与 MVCC 如何实现的隔离级别"}]}]},{"ID":"20240201213703-y9a3klj","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213703-y9a3klj","updated":"20240201213703"},"Children":[{"ID":"20240201213704-17v7ori","Type":"NodeParagraph","Properties":{"id":"20240201213704-17v7ori","updated":"20240201213704"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://leviathan.vip/2019/03/20/InnoDB%E7%9A%84%E4%BA%8B%E5%8A%A1%E5%88%86%E6%9E%90-MVCC/","TextMarkTextContent":"InnoDB 事务分析-MVCC"}]}]}]},{"ID":"20240201213705-924pded","Type":"NodeHTMLBlock","Data":"\u003cdiv\u003e\n\u003c!-- @include: @article-footer.snippet.md --\u003e\n\u003c/div\u003e","HtmlBlockType":2,"Properties":{"id":"20240201213705-924pded","updated":"20240201213705"}}]}