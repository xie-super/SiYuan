{"ID":"20240201213544-ul8tat3","Spec":"1","Type":"NodeDocument","Properties":{"id":"20240201213544-ul8tat3","title":"mysql-auto-increment-primary-key-continuous","updated":"20240201213544"},"Children":[{"ID":"20240201213545-9ynk8i5","Type":"NodeThematicBreak","Properties":{"id":"20240201213545-9ynk8i5","updated":"20240201213545"}},{"ID":"20240201213546-0wf67ng","Type":"NodeParagraph","Properties":{"id":"20240201213546-0wf67ng","updated":"20240201213546"},"Children":[{"Type":"NodeText","Data":"title: MySQL自增主键一定是连续的吗"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"category: 数据库"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"tag:"}]},{"ID":"20240201213547-ddnlgov","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213547-ddnlgov","updated":"20240201213547"},"Children":[{"ID":"20240201213548-5ujr2qo","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213548-5ujr2qo","updated":"20240201213548"},"Children":[{"ID":"20240201213549-9ocej95","Type":"NodeParagraph","Properties":{"id":"20240201213549-9ocej95","updated":"20240201213549"},"Children":[{"Type":"NodeText","Data":"MySQL"}]}]},{"ID":"20240201213550-kqgp720","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213550-kqgp720","updated":"20240201213550"},"Children":[{"ID":"20240201213551-xyn1xg6","Type":"NodeParagraph","Properties":{"id":"20240201213551-xyn1xg6","updated":"20240201213551"},"Children":[{"Type":"NodeText","Data":"大厂面试"}]}]}]},{"ID":"20240201213552-t3bicc9","Type":"NodeThematicBreak","Properties":{"id":"20240201213552-t3bicc9","updated":"20240201213552"}},{"ID":"20240201213553-tkvrdgl","Type":"NodeBlockquote","Properties":{"id":"20240201213553-tkvrdgl","updated":"20240201213553"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e ","Properties":{"id":""}},{"ID":"20240201213554-mpi9lvl","Type":"NodeParagraph","Properties":{"id":"20240201213554-mpi9lvl","updated":"20240201213554"},"Children":[{"Type":"NodeText","Data":"作者：飞天小牛肉"}]},{"ID":"20240201213555-0mrn7qa","Type":"NodeParagraph","Properties":{"id":"20240201213555-0mrn7qa","updated":"20240201213555"},"Children":[{"Type":"NodeText","Data":"原文："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://mp.weixin.qq.com/s/qci10h9rJx_COZbHV3aygQ","TextMarkTextContent":"https://mp.weixin.qq.com/s/qci10h9rJx_COZbHV3aygQ"}]}]},{"ID":"20240201213556-nbzqhr2","Type":"NodeParagraph","Properties":{"id":"20240201213556-nbzqhr2","updated":"20240201213556"},"Children":[{"Type":"NodeText","Data":"众所周知，自增主键可以让聚集索引尽量地保持递增顺序插入，避免了随机查询，从而提高了查询效率。"}]},{"ID":"20240201213557-wfkswt9","Type":"NodeParagraph","Properties":{"id":"20240201213557-wfkswt9","updated":"20240201213557"},"Children":[{"Type":"NodeText","Data":"但实际上，MySQL 的自增主键并不能保证一定是连续递增的。"}]},{"ID":"20240201213558-lzlh878","Type":"NodeParagraph","Properties":{"id":"20240201213558-lzlh878","updated":"20240201213558"},"Children":[{"Type":"NodeText","Data":"下面举个例子来看下，如下所示创建一张表："}]},{"ID":"20240201213559-yiqg1nf","Type":"NodeParagraph","Properties":{"id":"20240201213559-yiqg1nf","updated":"20240201213559"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/3e6b80ba50cb425386b80924e3da0d23~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213560-bj3nf74","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213560-bj3nf74","updated":"20240201213560"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"自增值保存在哪里？"}]},{"ID":"20240201213561-la37ofc","Type":"NodeParagraph","Properties":{"id":"20240201213561-la37ofc","updated":"20240201213561"},"Children":[{"Type":"NodeText","Data":"使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert into test_pk values(null, 1, 1)"},{"Type":"NodeText","Data":" 插入一行数据，再执行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"show create table"},{"Type":"NodeText","Data":" 命令来看一下表的结构定义："}]},{"ID":"20240201213562-kssx5gs","Type":"NodeParagraph","Properties":{"id":"20240201213562-kssx5gs","updated":"20240201213562"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/c17e46230bd34150966f0d86b2ad5e91~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213563-libxarh","Type":"NodeParagraph","Properties":{"id":"20240201213563-libxarh","updated":"20240201213563"},"Children":[{"Type":"NodeText","Data":"上述表的结构定义存放在后缀名为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":".frm"},{"Type":"NodeText","Data":" 的本地文件中，在 MySQL 安装目录下的 data 文件夹下可以找到这个 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":".frm"},{"Type":"NodeText","Data":" 文件："}]},{"ID":"20240201213564-mm0edjo","Type":"NodeParagraph","Properties":{"id":"20240201213564-mm0edjo","updated":"20240201213564"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/3ec0514dd7be423d80b9e7f2d52f5902~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213565-4qa5e1w","Type":"NodeParagraph","Properties":{"id":"20240201213565-4qa5e1w","updated":"20240201213565"},"Children":[{"Type":"NodeText","Data":"从上述表结构可以看到，表定义里面出现了一个 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"AUTO_INCREMENT=2"},{"Type":"NodeText","Data":"，表示下一次插入数据时，如果需要自动生成自增值，会生成 id = 2。"}]},{"ID":"20240201213566-con6n5i","Type":"NodeParagraph","Properties":{"id":"20240201213566-con6n5i","updated":"20240201213566"},"Children":[{"Type":"NodeText","Data":"但需要注意的是，自增值并不会保存在这个表结构也就是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":".frm"},{"Type":"NodeText","Data":" 文件中，不同的引擎对于自增值的保存策略不同："}]},{"ID":"20240201213567-prxqisz","Type":"NodeParagraph","Properties":{"id":"20240201213567-prxqisz","updated":"20240201213567"},"Children":[{"Type":"NodeText","Data":"1）MyISAM 引擎的自增值保存在数据文件中"}]},{"ID":"20240201213568-7e7k3ei","Type":"NodeParagraph","Properties":{"id":"20240201213568-7e7k3ei","updated":"20240201213568"},"Children":[{"Type":"NodeText","Data":"2）InnoDB 引擎的自增值，其实是保存在了内存里，并没有持久化。第一次打开表的时候，都会去找自增值的最大值 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"max(id)"},{"Type":"NodeText","Data":"，然后将 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"max(id)+1"},{"Type":"NodeText","Data":" 作为这个表当前的自增值。"}]},{"ID":"20240201213569-b58a2lu","Type":"NodeParagraph","Properties":{"id":"20240201213569-b58a2lu","updated":"20240201213569"},"Children":[{"Type":"NodeText","Data":"举个例子：我们现在表里当前数据行里最大的 id 是 1，AUTO_INCREMENT=2，对吧。这时候，我们删除 id=1 的行，AUTO_INCREMENT 还是 2。"}]},{"ID":"20240201213570-9ks5rre","Type":"NodeParagraph","Properties":{"id":"20240201213570-9ks5rre","updated":"20240201213570"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/61b8dc9155624044a86d91c368b20059~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213571-61xj5sc","Type":"NodeParagraph","Properties":{"id":"20240201213571-61xj5sc","updated":"20240201213571"},"Children":[{"Type":"NodeText","Data":"但如果马上重启 MySQL 实例，重启后这个表的 AUTO_INCREMENT 就会变成 1。﻿ 也就是说，MySQL 重启可能会修改一个表的 AUTO_INCREMENT 的值。"}]},{"ID":"20240201213572-csrhwog","Type":"NodeParagraph","Properties":{"id":"20240201213572-csrhwog","updated":"20240201213572"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/27fdb15375664249a31f88b64e6e5e66~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213573-ovwmcyf","Type":"NodeParagraph","Properties":{"id":"20240201213573-ovwmcyf","updated":"20240201213573"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/dee15f93e65d44d384345a03404f3481~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213574-jr032f0","Type":"NodeParagraph","Properties":{"id":"20240201213574-jr032f0","updated":"20240201213574"},"Children":[{"Type":"NodeText","Data":"以上，是在我本地 MySQL 5.x 版本的实验，实际上，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"到了 MySQL 8.0 版本后，自增值的变更记录被放在了 redo log 中，提供了自增值持久化的能力"},{"Type":"NodeText","Data":" ，也就是实现了“如果发生重启，表的自增值可以根据 redo log 恢复为 MySQL 重启前的值”"}]},{"ID":"20240201213575-71e7pm4","Type":"NodeParagraph","Properties":{"id":"20240201213575-71e7pm4","updated":"20240201213575"},"Children":[{"Type":"NodeText","Data":"也就是说对于上面这个例子来说，重启实例后这个表的 AUTO_INCREMENT 仍然是 2。"}]},{"ID":"20240201213576-hwzjqyr","Type":"NodeParagraph","Properties":{"id":"20240201213576-hwzjqyr","updated":"20240201213576"},"Children":[{"Type":"NodeText","Data":"理解了 MySQL 自增值到底保存在哪里以后，我们再来看看自增值的修改机制，并以此引出第一种自增值不连续的场景。"}]},{"ID":"20240201213577-o5p2yxb","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213577-o5p2yxb","updated":"20240201213577"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"自增值不连续的场景"}]},{"ID":"20240201213578-19es60p","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213578-19es60p","updated":"20240201213578"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"自增值不连续场景 1"}]},{"ID":"20240201213579-ulr3qys","Type":"NodeParagraph","Properties":{"id":"20240201213579-ulr3qys","updated":"20240201213579"},"Children":[{"Type":"NodeText","Data":"在 MySQL 里面，如果字段 id 被定义为 AUTO_INCREMENT，在插入一行数据的时候，自增值的行为如下："}]},{"ID":"20240201213580-yn9h0d1","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213580-yn9h0d1","updated":"20240201213580"},"Children":[{"ID":"20240201213581-0vofuiw","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213581-0vofuiw","updated":"20240201213581"},"Children":[{"ID":"20240201213582-n18l2n2","Type":"NodeParagraph","Properties":{"id":"20240201213582-n18l2n2","updated":"20240201213582"},"Children":[{"Type":"NodeText","Data":"如果插入数据时 id 字段指定为 0、null 或未指定值，那么就把这个表当前的 AUTO_INCREMENT 值填到自增字段；"}]}]},{"ID":"20240201213583-fvgho3d","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213583-fvgho3d","updated":"20240201213583"},"Children":[{"ID":"20240201213584-wtptgzw","Type":"NodeParagraph","Properties":{"id":"20240201213584-wtptgzw","updated":"20240201213584"},"Children":[{"Type":"NodeText","Data":"如果插入数据时 id 字段指定了具体的值，就直接使用语句里指定的值。"}]}]}]},{"ID":"20240201213585-jntuw94","Type":"NodeParagraph","Properties":{"id":"20240201213585-jntuw94","updated":"20240201213585"},"Children":[{"Type":"NodeText","Data":"根据要插入的值和当前自增值的大小关系，自增值的变更结果也会有所不同。假设某次要插入的值是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert_num"},{"Type":"NodeText","Data":"，当前的自增值是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"autoIncrement_num"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213586-pn3ee57","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213586-pn3ee57","updated":"20240201213586"},"Children":[{"ID":"20240201213587-44colz1","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213587-44colz1","updated":"20240201213587"},"Children":[{"ID":"20240201213588-i69sjts","Type":"NodeParagraph","Properties":{"id":"20240201213588-i69sjts","updated":"20240201213588"},"Children":[{"Type":"NodeText","Data":"如果 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert_num \u0026lt; autoIncrement_num"},{"Type":"NodeText","Data":"，那么这个表的自增值不变"}]}]},{"ID":"20240201213589-m9xmrny","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213589-m9xmrny","updated":"20240201213589"},"Children":[{"ID":"20240201213590-zino2t7","Type":"NodeParagraph","Properties":{"id":"20240201213590-zino2t7","updated":"20240201213590"},"Children":[{"Type":"NodeText","Data":"如果 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert_num \u0026gt;= autoIncrement_num"},{"Type":"NodeText","Data":"，就需要把当前自增值修改为新的自增值"}]}]}]},{"ID":"20240201213591-7i0xsr7","Type":"NodeParagraph","Properties":{"id":"20240201213591-7i0xsr7","updated":"20240201213591"},"Children":[{"Type":"NodeText","Data":"也就是说，如果插入的 id 是 100，当前的自增值是 90，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert_num \u0026gt;= autoIncrement_num"},{"Type":"NodeText","Data":"，那么自增值就会被修改为新的自增值即 101"}]},{"ID":"20240201213592-o9ptq00","Type":"NodeParagraph","Properties":{"id":"20240201213592-o9ptq00","updated":"20240201213592"},"Children":[{"Type":"NodeText","Data":"一定是这样吗？"}]},{"ID":"20240201213593-m0xngjt","Type":"NodeParagraph","Properties":{"id":"20240201213593-m0xngjt","updated":"20240201213593"},"Children":[{"Type":"NodeText","Data":"非也~"}]},{"ID":"20240201213594-99k737e","Type":"NodeParagraph","Properties":{"id":"20240201213594-99k737e","updated":"20240201213594"},"Children":[{"Type":"NodeText","Data":"了解过分布式 id 的小伙伴一定知道，为了避免两个库生成的主键发生冲突，我们可以让一个库的自增 id 都是奇数，另一个库的自增 id 都是偶数"}]},{"ID":"20240201213595-aed6lbn","Type":"NodeParagraph","Properties":{"id":"20240201213595-aed6lbn","updated":"20240201213595"},"Children":[{"Type":"NodeText","Data":"这个奇数偶数其实是通过 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"auto_increment_offset"},{"Type":"NodeText","Data":" 和 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"auto_increment_increment"},{"Type":"NodeText","Data":" 这两个参数来决定的，这俩分别用来表示自增的初始值和步长，默认值都是 1。"}]},{"ID":"20240201213596-ekhjv3j","Type":"NodeParagraph","Properties":{"id":"20240201213596-ekhjv3j","updated":"20240201213596"},"Children":[{"Type":"NodeText","Data":"所以，上面的例子中生成新的自增值的步骤实际是这样的：从 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"auto_increment_offset"},{"Type":"NodeText","Data":" 开始，以 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"auto_increment_increment"},{"Type":"NodeText","Data":" 为步长，持续叠加，直到找到第一个大于 100 的值，作为新的自增值。"}]},{"ID":"20240201213597-85zwc7y","Type":"NodeParagraph","Properties":{"id":"20240201213597-85zwc7y","updated":"20240201213597"},"Children":[{"Type":"NodeText","Data":"所以，这种情况下，自增值可能会是 102，103 等等之类的，就会导致不连续的主键 id。"}]},{"ID":"20240201213598-n8qea23","Type":"NodeParagraph","Properties":{"id":"20240201213598-n8qea23","updated":"20240201213598"},"Children":[{"Type":"NodeText","Data":"更遗憾的是，即使在自增初始值和步长这两个参数都设置为 1 的时候，自增主键 id 也不一定能保证主键是连续的"}]},{"ID":"20240201213599-p14pmyr","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213599-p14pmyr","updated":"20240201213599"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"自增值不连续场景 2"}]},{"ID":"20240201213600-mfaksye","Type":"NodeParagraph","Properties":{"id":"20240201213600-mfaksye","updated":"20240201213600"},"Children":[{"Type":"NodeText","Data":"举个例子，我们现在往表里插入一条 (null,1,1) 的记录，生成的主键是 1，AUTO_INCREMENT= 2，对吧"}]},{"ID":"20240201213601-munpgxo","Type":"NodeParagraph","Properties":{"id":"20240201213601-munpgxo","updated":"20240201213601"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/c22c4f2cea234c7ea496025eb826c3bc~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213602-o3kwpyf","Type":"NodeParagraph","Properties":{"id":"20240201213602-o3kwpyf","updated":"20240201213602"},"Children":[{"Type":"NodeText","Data":"这时我再执行一条插入 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"(null,1,1)"},{"Type":"NodeText","Data":" 的命令，很显然会报错 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Duplicate entry"},{"Type":"NodeText","Data":"，因为我们设置了一个唯一索引字段 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"a"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213603-atfa3hp","Type":"NodeParagraph","Properties":{"id":"20240201213603-atfa3hp","updated":"20240201213603"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/c0325e31398d4fa6bb1cbe08ef797b7f~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213604-f40pg0u","Type":"NodeParagraph","Properties":{"id":"20240201213604-f40pg0u","updated":"20240201213604"},"Children":[{"Type":"NodeText","Data":"但是，你会惊奇的发现，虽然插入失败了，但自增值仍然从 2 增加到了 3！"}]},{"ID":"20240201213605-r7bbxjv","Type":"NodeParagraph","Properties":{"id":"20240201213605-r7bbxjv","updated":"20240201213605"},"Children":[{"Type":"NodeText","Data":"这是为啥？"}]},{"ID":"20240201213606-3zy5ksj","Type":"NodeParagraph","Properties":{"id":"20240201213606-3zy5ksj","updated":"20240201213606"},"Children":[{"Type":"NodeText","Data":"我们来分析下这个 insert 语句的执行流程："}]},{"ID":"20240201213607-4l37vpm","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213607-4l37vpm","updated":"20240201213607"},"Children":[{"ID":"20240201213608-jqfmcz1","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213608-jqfmcz1","updated":"20240201213608"},"Children":[{"ID":"20240201213609-4ujx9rg","Type":"NodeParagraph","Properties":{"id":"20240201213609-4ujx9rg","updated":"20240201213609"},"Children":[{"Type":"NodeText","Data":"执行器调用 InnoDB 引擎接口准备插入一行记录 (null,1,1);"}]}]},{"ID":"20240201213610-59m7bfu","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213610-59m7bfu","updated":"20240201213610"},"Children":[{"ID":"20240201213611-upco0n3","Type":"NodeParagraph","Properties":{"id":"20240201213611-upco0n3","updated":"20240201213611"},"Children":[{"Type":"NodeText","Data":"InnoDB 发现用户没有指定自增 id 的值，则获取表 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"test_pk"},{"Type":"NodeText","Data":" 当前的自增值 2；"}]}]},{"ID":"20240201213612-g1w6fea","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213612-g1w6fea","updated":"20240201213612"},"Children":[{"ID":"20240201213613-5ri0mob","Type":"NodeParagraph","Properties":{"id":"20240201213613-5ri0mob","updated":"20240201213613"},"Children":[{"Type":"NodeText","Data":"将传入的记录改成 (2,1,1);"}]}]},{"ID":"20240201213614-rhtmia1","Type":"NodeListItem","Data":"4","ListData":{"Typ":1,"Tight":true,"Start":4,"Delimiter":46,"Padding":3,"Marker":"NA==","Num":4},"Properties":{"id":"20240201213614-rhtmia1","updated":"20240201213614"},"Children":[{"ID":"20240201213615-sjng5kl","Type":"NodeParagraph","Properties":{"id":"20240201213615-sjng5kl","updated":"20240201213615"},"Children":[{"Type":"NodeText","Data":"将表的自增值改成 3；"}]}]},{"ID":"20240201213616-czhnihy","Type":"NodeListItem","Data":"5","ListData":{"Typ":1,"Tight":true,"Start":5,"Delimiter":46,"Padding":3,"Marker":"NQ==","Num":5},"Properties":{"id":"20240201213616-czhnihy","updated":"20240201213616"},"Children":[{"ID":"20240201213617-3ekm4rl","Type":"NodeParagraph","Properties":{"id":"20240201213617-3ekm4rl","updated":"20240201213617"},"Children":[{"Type":"NodeText","Data":"继续执行插入数据操作，由于已经存在 a=1 的记录，所以报 Duplicate key error，语句返回"}]}]}]},{"ID":"20240201213618-z7bjzoz","Type":"NodeParagraph","Properties":{"id":"20240201213618-z7bjzoz","updated":"20240201213618"},"Children":[{"Type":"NodeText","Data":"可以看到，自增值修改的这个操作，是在真正执行插入数据的操作之前。"}]},{"ID":"20240201213619-1rcfpg1","Type":"NodeParagraph","Properties":{"id":"20240201213619-1rcfpg1","updated":"20240201213619"},"Children":[{"Type":"NodeText","Data":"这个语句真正执行的时候，因为碰到唯一键 a 冲突，所以 id = 2 这一行并没有插入成功，但也没有将自增值再改回去。所以，在这之后，再插入新的数据行时，拿到的自增 id 就是 3。也就是说，出现了自增主键不连续的情况。"}]},{"ID":"20240201213620-elyb39s","Type":"NodeParagraph","Properties":{"id":"20240201213620-elyb39s","updated":"20240201213620"},"Children":[{"Type":"NodeText","Data":"至此，我们已经罗列了两种自增主键不连续的情况："}]},{"ID":"20240201213621-c2qhen9","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213621-c2qhen9","updated":"20240201213621"},"Children":[{"ID":"20240201213622-qbnofmm","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213622-qbnofmm","updated":"20240201213622"},"Children":[{"ID":"20240201213623-2aqla7j","Type":"NodeParagraph","Properties":{"id":"20240201213623-2aqla7j","updated":"20240201213623"},"Children":[{"Type":"NodeText","Data":"自增初始值和自增步长设置不为 1"}]}]},{"ID":"20240201213624-hc74gql","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213624-hc74gql","updated":"20240201213624"},"Children":[{"ID":"20240201213625-emp95nt","Type":"NodeParagraph","Properties":{"id":"20240201213625-emp95nt","updated":"20240201213625"},"Children":[{"Type":"NodeText","Data":"唯一键冲突"}]}]}]},{"ID":"20240201213626-2szxgr8","Type":"NodeParagraph","Properties":{"id":"20240201213626-2szxgr8","updated":"20240201213626"},"Children":[{"Type":"NodeText","Data":"除此之外，事务回滚也会导致这种情况"}]},{"ID":"20240201213627-9j8lele","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213627-9j8lele","updated":"20240201213627"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"自增值不连续场景 3"}]},{"ID":"20240201213628-ozust9c","Type":"NodeParagraph","Properties":{"id":"20240201213628-ozust9c","updated":"20240201213628"},"Children":[{"Type":"NodeText","Data":"我们现在表里有一行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"(1,1,1)"},{"Type":"NodeText","Data":" 的记录，AUTO_INCREMENT = 3："}]},{"ID":"20240201213629-h6q1uov","Type":"NodeParagraph","Properties":{"id":"20240201213629-h6q1uov","updated":"20240201213629"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/6220fcf7dac54299863e43b6fb97de3e~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213630-wj13wsj","Type":"NodeParagraph","Properties":{"id":"20240201213630-wj13wsj","updated":"20240201213630"},"Children":[{"Type":"NodeText","Data":"我们先插入一行数据 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"(null, 2, 2)"},{"Type":"NodeText","Data":"，也就是 (3, 2, 2) 嘛，并且 AUTO_INCREMENT 变为 4："}]},{"ID":"20240201213631-m8qd0f5","Type":"NodeParagraph","Properties":{"id":"20240201213631-m8qd0f5","updated":"20240201213631"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/3f02d46437d643c3b3d9f44a004ab269~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213632-zbvwbpw","Type":"NodeParagraph","Properties":{"id":"20240201213632-zbvwbpw","updated":"20240201213632"},"Children":[{"Type":"NodeText","Data":"再去执行这样一段 SQL："}]},{"ID":"20240201213633-v6ikaax","Type":"NodeParagraph","Properties":{"id":"20240201213633-v6ikaax","updated":"20240201213633"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/faf5ce4a2920469cae697f845be717f5~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213634-45zl6nn","Type":"NodeParagraph","Properties":{"id":"20240201213634-45zl6nn","updated":"20240201213634"},"Children":[{"Type":"NodeText","Data":"虽然我们插入了一条 (null, 3, 3) 记录，但是使用 rollback 进行回滚了，所以数据库中是没有这条记录的："}]},{"ID":"20240201213635-42qg93e","Type":"NodeParagraph","Properties":{"id":"20240201213635-42qg93e","updated":"20240201213635"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/6cb4c02722674dd399939d3d03a431c1~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213636-aqownif","Type":"NodeParagraph","Properties":{"id":"20240201213636-aqownif","updated":"20240201213636"},"Children":[{"Type":"NodeText","Data":"在这种事务回滚的情况下，自增值并没有同样发生回滚！如下图所示，自增值仍然固执地从 4 增加到了 5："}]},{"ID":"20240201213637-9nn7157","Type":"NodeParagraph","Properties":{"id":"20240201213637-9nn7157","updated":"20240201213637"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/e6eea1c927424ac7bda34a511ca521ae~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213638-3t7bjx0","Type":"NodeParagraph","Properties":{"id":"20240201213638-3t7bjx0","updated":"20240201213638"},"Children":[{"Type":"NodeText","Data":"所以这时候我们再去插入一条数据（null, 3, 3）的时候，主键 id 就会被自动赋为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"5"},{"Type":"NodeText","Data":" 了："}]},{"ID":"20240201213639-33dmry5","Type":"NodeParagraph","Properties":{"id":"20240201213639-33dmry5","updated":"20240201213639"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/80da69dd13b543c4a32d6ed832a3c568~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213640-nb6b7pk","Type":"NodeParagraph","Properties":{"id":"20240201213640-nb6b7pk","updated":"20240201213640"},"Children":[{"Type":"NodeText","Data":"那么，为什么在出现唯一键冲突或者回滚的时候，MySQL 没有把表的自增值改回去呢？回退回去的话不就不会发生自增 id 不连续了吗？"}]},{"ID":"20240201213641-xivh14r","Type":"NodeParagraph","Properties":{"id":"20240201213641-xivh14r","updated":"20240201213641"},"Children":[{"Type":"NodeText","Data":"事实上，这么做的主要原因是为了提高性能。"}]},{"ID":"20240201213642-smd6kbr","Type":"NodeParagraph","Properties":{"id":"20240201213642-smd6kbr","updated":"20240201213642"},"Children":[{"Type":"NodeText","Data":"我们直接用反证法来验证：假设 MySQL 在事务回滚的时候会把自增值改回去，会发生什么？"}]},{"ID":"20240201213643-5l8nonz","Type":"NodeParagraph","Properties":{"id":"20240201213643-5l8nonz","updated":"20240201213643"},"Children":[{"Type":"NodeText","Data":"现在有两个并行执行的事务 A 和 B，在申请自增值的时候，为了避免两个事务申请到相同的自增 id，肯定要加锁，然后顺序申请，对吧。"}]},{"ID":"20240201213644-25xbxu1","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213644-25xbxu1","updated":"20240201213644"},"Children":[{"ID":"20240201213645-fmx3ix7","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213645-fmx3ix7","updated":"20240201213645"},"Children":[{"ID":"20240201213646-18b107c","Type":"NodeParagraph","Properties":{"id":"20240201213646-18b107c","updated":"20240201213646"},"Children":[{"Type":"NodeText","Data":"假设事务 A 申请到了 id = 1， 事务 B 申请到 id=2，那么这时候表 t 的自增值是 3，之后继续执行。"}]}]},{"ID":"20240201213647-dk10mb2","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213647-dk10mb2","updated":"20240201213647"},"Children":[{"ID":"20240201213648-d8xjshf","Type":"NodeParagraph","Properties":{"id":"20240201213648-d8xjshf","updated":"20240201213648"},"Children":[{"Type":"NodeText","Data":"事务 B 正确提交了，但事务 A 出现了唯一键冲突，也就是 id = 1 的那行记录插入失败了，那如果允许事务 A 把自增 id 回退，也就是把表的当前自增值改回 1，那么就会出现这样的情况：表里面已经有 id = 2 的行，而当前的自增 id 值是 1。"}]}]},{"ID":"20240201213649-nxyua7j","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213649-nxyua7j","updated":"20240201213649"},"Children":[{"ID":"20240201213650-ccdl80v","Type":"NodeParagraph","Properties":{"id":"20240201213650-ccdl80v","updated":"20240201213650"},"Children":[{"Type":"NodeText","Data":"接下来，继续执行的其他事务就会申请到 id=2。这时，就会出现插入语句报错“主键冲突”。"}]}]}]},{"ID":"20240201213651-6mfft9q","Type":"NodeParagraph","Properties":{"id":"20240201213651-6mfft9q","updated":"20240201213651"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/5f26f02e60f643c9a7cab88a9f1bdce9~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213652-lm3s975","Type":"NodeParagraph","Properties":{"id":"20240201213652-lm3s975","updated":"20240201213652"},"Children":[{"Type":"NodeText","Data":"而为了解决这个主键冲突，有两种方法："}]},{"ID":"20240201213653-lumyq6y","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213653-lumyq6y","updated":"20240201213653"},"Children":[{"ID":"20240201213654-v0bebx5","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213654-v0bebx5","updated":"20240201213654"},"Children":[{"ID":"20240201213655-9aa77zt","Type":"NodeParagraph","Properties":{"id":"20240201213655-9aa77zt","updated":"20240201213655"},"Children":[{"Type":"NodeText","Data":"每次申请 id 之前，先判断表里面是否已经存在这个 id，如果存在，就跳过这个 id"}]}]},{"ID":"20240201213656-hedxo6b","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213656-hedxo6b","updated":"20240201213656"},"Children":[{"ID":"20240201213657-x3t14lq","Type":"NodeParagraph","Properties":{"id":"20240201213657-x3t14lq","updated":"20240201213657"},"Children":[{"Type":"NodeText","Data":"把自增 id 的锁范围扩大，必须等到一个事务执行完成并提交，下一个事务才能再申请自增 id"}]}]}]},{"ID":"20240201213658-51oy7yj","Type":"NodeParagraph","Properties":{"id":"20240201213658-51oy7yj","updated":"20240201213658"},"Children":[{"Type":"NodeText","Data":"很显然，上述两个方法的成本都比较高，会导致性能问题。而究其原因呢，是我们假设的这个 “允许自增 id 回退”。"}]},{"ID":"20240201213659-c90qp3u","Type":"NodeParagraph","Properties":{"id":"20240201213659-c90qp3u","updated":"20240201213659"},"Children":[{"Type":"NodeText","Data":"因此，InnoDB 放弃了这个设计，语句执行失败也不回退自增 id。也正是因为这样，所以才只保证了自增 id 是递增的，但不保证是连续的。"}]},{"ID":"20240201213660-ef9l0xq","Type":"NodeParagraph","Properties":{"id":"20240201213660-ef9l0xq","updated":"20240201213660"},"Children":[{"Type":"NodeText","Data":"综上，已经分析了三种自增值不连续的场景，还有第四种场景：批量插入数据。"}]},{"ID":"20240201213661-wlwa5jd","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213661-wlwa5jd","updated":"20240201213661"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"自增值不连续场景 4"}]},{"ID":"20240201213662-686d5e5","Type":"NodeParagraph","Properties":{"id":"20240201213662-686d5e5","updated":"20240201213662"},"Children":[{"Type":"NodeText","Data":"对于批量插入数据的语句，MySQL 有一个批量申请自增 id 的策略："}]},{"ID":"20240201213663-7248elg","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213663-7248elg","updated":"20240201213663"},"Children":[{"ID":"20240201213664-9vdx6u8","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213664-9vdx6u8","updated":"20240201213664"},"Children":[{"ID":"20240201213665-6rbncsj","Type":"NodeParagraph","Properties":{"id":"20240201213665-6rbncsj","updated":"20240201213665"},"Children":[{"Type":"NodeText","Data":"语句执行过程中，第一次申请自增 id，会分配 1 个；"}]}]},{"ID":"20240201213666-rcopca8","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213666-rcopca8","updated":"20240201213666"},"Children":[{"ID":"20240201213667-360w0zd","Type":"NodeParagraph","Properties":{"id":"20240201213667-360w0zd","updated":"20240201213667"},"Children":[{"Type":"NodeText","Data":"1 个用完以后，这个语句第二次申请自增 id，会分配 2 个；"}]}]},{"ID":"20240201213668-vcrahhm","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213668-vcrahhm","updated":"20240201213668"},"Children":[{"ID":"20240201213669-ub9w4xk","Type":"NodeParagraph","Properties":{"id":"20240201213669-ub9w4xk","updated":"20240201213669"},"Children":[{"Type":"NodeText","Data":"2 个用完以后，还是这个语句，第三次申请自增 id，会分配 4 个；"}]}]},{"ID":"20240201213670-tv47k24","Type":"NodeListItem","Data":"4","ListData":{"Typ":1,"Tight":true,"Start":4,"Delimiter":46,"Padding":3,"Marker":"NA==","Num":4},"Properties":{"id":"20240201213670-tv47k24","updated":"20240201213670"},"Children":[{"ID":"20240201213671-vailyza","Type":"NodeParagraph","Properties":{"id":"20240201213671-vailyza","updated":"20240201213671"},"Children":[{"Type":"NodeText","Data":"依此类推，同一个语句去申请自增 id，每次申请到的自增 id 个数都是上一次的两倍。"}]}]}]},{"ID":"20240201213672-e7kzk6a","Type":"NodeParagraph","Properties":{"id":"20240201213672-e7kzk6a","updated":"20240201213672"},"Children":[{"Type":"NodeText","Data":"注意，这里说的批量插入数据，不是在普通的 insert 语句里面包含多个 value 值！！！，因为这类语句在申请自增 id 的时候，是可以精确计算出需要多少个 id 的，然后一次性申请，申请完成后锁就可以释放了。"}]},{"ID":"20240201213673-y93g4yi","Type":"NodeParagraph","Properties":{"id":"20240201213673-y93g4yi","updated":"20240201213673"},"Children":[{"Type":"NodeText","Data":"而对于 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert … select"},{"Type":"NodeText","Data":"、replace …… select 和 load data 这种类型的语句来说，MySQL 并不知道到底需要申请多少 id，所以就采用了这种批量申请的策略，毕竟一个一个申请的话实在太慢了。"}]},{"ID":"20240201213674-6whlgrb","Type":"NodeParagraph","Properties":{"id":"20240201213674-6whlgrb","updated":"20240201213674"},"Children":[{"Type":"NodeText","Data":"举个例子，假设我们现在这个表有下面这些数据："}]},{"ID":"20240201213675-aoyvlvf","Type":"NodeParagraph","Properties":{"id":"20240201213675-aoyvlvf","updated":"20240201213675"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/6453cfc107f94e3bb86c95072d443472~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213676-xglkpvg","Type":"NodeParagraph","Properties":{"id":"20240201213676-xglkpvg","updated":"20240201213676"},"Children":[{"Type":"NodeText","Data":"我们创建一个和当前表 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"test_pk"},{"Type":"NodeText","Data":" 有相同结构定义的表 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"test_pk2"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213677-wozuwvp","Type":"NodeParagraph","Properties":{"id":"20240201213677-wozuwvp","updated":"20240201213677"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/45248a6dc34f431bba14d434bee2c79e~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213678-uqvkpck","Type":"NodeParagraph","Properties":{"id":"20240201213678-uqvkpck","updated":"20240201213678"},"Children":[{"Type":"NodeText","Data":"然后使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert...select"},{"Type":"NodeText","Data":" 往 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"teset_pk2"},{"Type":"NodeText","Data":" 表中批量插入数据："}]},{"ID":"20240201213679-2a3iy1a","Type":"NodeParagraph","Properties":{"id":"20240201213679-2a3iy1a","updated":"20240201213679"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/c1b061e86bae484694d15ceb703b10ca~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213680-0w2r1k7","Type":"NodeParagraph","Properties":{"id":"20240201213680-0w2r1k7","updated":"20240201213680"},"Children":[{"Type":"NodeText","Data":"可以看到，成功导入了数据。"}]},{"ID":"20240201213681-jzmkocc","Type":"NodeParagraph","Properties":{"id":"20240201213681-jzmkocc","updated":"20240201213681"},"Children":[{"Type":"NodeText","Data":"再来看下 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"test_pk2"},{"Type":"NodeText","Data":" 的自增值是多少："}]},{"ID":"20240201213682-oy052rq","Type":"NodeParagraph","Properties":{"id":"20240201213682-oy052rq","updated":"20240201213682"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/0ff9039366154c738331d64ebaf88d3b~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213683-puy479w","Type":"NodeParagraph","Properties":{"id":"20240201213683-puy479w","updated":"20240201213683"},"Children":[{"Type":"NodeText","Data":"如上分析，是 8 而不是 6"}]},{"ID":"20240201213684-k9f07r5","Type":"NodeParagraph","Properties":{"id":"20240201213684-k9f07r5","updated":"20240201213684"},"Children":[{"Type":"NodeText","Data":"具体来说，insert……select 实际上往表中插入了 5 行数据 （1 1）（2 2）（3 3）（4 4）（5 5）。但是，这五行数据是分三次申请的自增 id，结合批量申请策略，每次申请到的自增 id 个数都是上一次的两倍，所以："}]},{"ID":"20240201213685-htbt9n4","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213685-htbt9n4","updated":"20240201213685"},"Children":[{"ID":"20240201213686-8fu5j4n","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213686-8fu5j4n","updated":"20240201213686"},"Children":[{"ID":"20240201213687-eig7dtz","Type":"NodeParagraph","Properties":{"id":"20240201213687-eig7dtz","updated":"20240201213687"},"Children":[{"Type":"NodeText","Data":"第一次申请到了一个 id：id=1"}]}]},{"ID":"20240201213688-1tkh42s","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213688-1tkh42s","updated":"20240201213688"},"Children":[{"ID":"20240201213689-my8qt1e","Type":"NodeParagraph","Properties":{"id":"20240201213689-my8qt1e","updated":"20240201213689"},"Children":[{"Type":"NodeText","Data":"第二次被分配了两个 id：id=2 和 id=3"}]}]},{"ID":"20240201213690-s2p3pel","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213690-s2p3pel","updated":"20240201213690"},"Children":[{"ID":"20240201213691-sipj9pj","Type":"NodeParagraph","Properties":{"id":"20240201213691-sipj9pj","updated":"20240201213691"},"Children":[{"Type":"NodeText","Data":"第三次被分配到了 4 个 id：id=4、id = 5、id = 6、id=7"}]}]}]},{"ID":"20240201213692-mwancfn","Type":"NodeParagraph","Properties":{"id":"20240201213692-mwancfn","updated":"20240201213692"},"Children":[{"Type":"NodeText","Data":"由于这条语句实际只用上了 5 个 id，所以 id=6 和 id=7 就被浪费掉了。之后，再执行 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert into test_pk2 values(null,6,6)"},{"Type":"NodeText","Data":"，实际上插入的数据就是（8,6,6)："}]},{"ID":"20240201213693-kbldksx","Type":"NodeParagraph","Properties":{"id":"20240201213693-kbldksx","updated":"20240201213693"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/p3-juejin/51612fbac3804cff8c5157df21d6e355~tplv-k3u1fbpfcp-zoom-1.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213694-j7v3k8q","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240201213694-j7v3k8q","updated":"20240201213694"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"小结"}]},{"ID":"20240201213695-37vnw1w","Type":"NodeParagraph","Properties":{"id":"20240201213695-37vnw1w","updated":"20240201213695"},"Children":[{"Type":"NodeText","Data":"本文总结下自增值不连续的 4 个场景："}]},{"ID":"20240201213696-779yqx6","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213696-779yqx6","updated":"20240201213696"},"Children":[{"ID":"20240201213697-he5jsjf","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213697-he5jsjf","updated":"20240201213697"},"Children":[{"ID":"20240201213698-e374ia2","Type":"NodeParagraph","Properties":{"id":"20240201213698-e374ia2","updated":"20240201213698"},"Children":[{"Type":"NodeText","Data":"自增初始值和自增步长设置不为 1"}]}]},{"ID":"20240201213699-1sfq088","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213699-1sfq088","updated":"20240201213699"},"Children":[{"ID":"20240201213700-5c9pnh1","Type":"NodeParagraph","Properties":{"id":"20240201213700-5c9pnh1","updated":"20240201213700"},"Children":[{"Type":"NodeText","Data":"唯一键冲突"}]}]},{"ID":"20240201213701-60eucwe","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213701-60eucwe","updated":"20240201213701"},"Children":[{"ID":"20240201213702-080ipo5","Type":"NodeParagraph","Properties":{"id":"20240201213702-080ipo5","updated":"20240201213702"},"Children":[{"Type":"NodeText","Data":"事务回滚"}]}]},{"ID":"20240201213703-h82ka4d","Type":"NodeListItem","Data":"4","ListData":{"Typ":1,"Tight":true,"Start":4,"Delimiter":46,"Padding":3,"Marker":"NA==","Num":4},"Properties":{"id":"20240201213703-h82ka4d","updated":"20240201213703"},"Children":[{"ID":"20240201213704-x3l5nyg","Type":"NodeParagraph","Properties":{"id":"20240201213704-x3l5nyg","updated":"20240201213704"},"Children":[{"Type":"NodeText","Data":"批量插入（如 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"insert...select"},{"Type":"NodeText","Data":" 语句）"}]}]}]},{"ID":"20240201213705-82e42hp","Type":"NodeHTMLBlock","Data":"\u003cdiv\u003e\n\u003c!-- @include: @article-footer.snippet.md --\u003e\n\u003c/div\u003e","HtmlBlockType":2,"Properties":{"id":"20240201213705-82e42hp","updated":"20240201213705"}}]}