{"ID":"20240201213405-vsp1fc0","Spec":"1","Type":"NodeDocument","Properties":{"id":"20240201213405-vsp1fc0","title":"threadlocal","updated":"20240201213405"},"Children":[{"ID":"20240201213406-t0isk31","Type":"NodeThematicBreak","Properties":{"id":"20240201213406-t0isk31","updated":"20240201213406"}},{"ID":"20240201213407-0m41tnb","Type":"NodeParagraph","Properties":{"id":"20240201213407-0m41tnb","updated":"20240201213407"},"Children":[{"Type":"NodeText","Data":"title: ThreadLocal 详解"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"category: Java"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"tag:"}]},{"ID":"20240201213408-1yio5b8","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213408-1yio5b8","updated":"20240201213408"},"Children":[{"ID":"20240201213409-7wyxs6h","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"MarkerOffset":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213409-7wyxs6h","updated":"20240201213409"},"Children":[{"ID":"20240201213410-mlroopo","Type":"NodeParagraph","Properties":{"id":"20240201213410-mlroopo","updated":"20240201213410"},"Children":[{"Type":"NodeText","Data":"Java并发"}]}]}]},{"ID":"20240201213411-uvug4nh","Type":"NodeThematicBreak","Properties":{"id":"20240201213411-uvug4nh","updated":"20240201213411"}},{"ID":"20240201213412-8np119u","Type":"NodeBlockquote","Properties":{"id":"20240201213412-8np119u","updated":"20240201213412"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e ","Properties":{"id":""}},{"ID":"20240201213413-ychu6sk","Type":"NodeParagraph","Properties":{"id":"20240201213413-ychu6sk","updated":"20240201213413"},"Children":[{"Type":"NodeText","Data":"本文来自一枝花算不算浪漫投稿， 原文地址："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://juejin.cn/post/6844904151567040519","TextMarkTextContent":"https://juejin.cn/post/6844904151567040519"},{"Type":"NodeText","Data":"。"}]}]},{"ID":"20240201213414-agczrp2","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213414-agczrp2","updated":"20240201213414"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"前言"}]},{"ID":"20240201213415-z4dj3iw","Type":"NodeParagraph","Properties":{"id":"20240201213415-z4dj3iw","updated":"20240201213415"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/1-20240201213826-6rkqz8o.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213416-90hplib","Type":"NodeParagraph","Properties":{"id":"20240201213416-90hplib","updated":"20240201213416"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"全文共 10000+字，31 张图，这篇文章同样耗费了不少的时间和精力才创作完成，原创不易，请大家点点关注+在看，感谢。"}]},{"ID":"20240201213417-8fo66fk","Type":"NodeParagraph","Properties":{"id":"20240201213417-8fo66fk","updated":"20240201213417"},"Children":[{"Type":"NodeText","Data":"对于"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"，大家的第一反应可能是很简单呀，线程的变量副本，每个线程隔离。那这里有几个问题大家可以思考一下："}]},{"ID":"20240201213418-9cfer97","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213418-9cfer97","updated":"20240201213418"},"Children":[{"ID":"20240201213419-2jxh92l","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213419-2jxh92l","updated":"20240201213419"},"Children":[{"ID":"20240201213420-nl0aqub","Type":"NodeParagraph","Properties":{"id":"20240201213420-nl0aqub","updated":"20240201213420"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"的 key 是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"弱引用"},{"Type":"NodeText","Data":"，那么在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal.get()"},{"Type":"NodeText","Data":"的时候，发生"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"GC"},{"Type":"NodeText","Data":"之后，key 是否为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"？"}]}]},{"ID":"20240201213421-rjb7qzc","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213421-rjb7qzc","updated":"20240201213421"},"Children":[{"ID":"20240201213422-0wdph4d","Type":"NodeParagraph","Properties":{"id":"20240201213422-0wdph4d","updated":"20240201213422"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"数据结构"},{"Type":"NodeText","Data":"？"}]}]},{"ID":"20240201213423-d7anffe","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213423-d7anffe","updated":"20240201213423"},"Children":[{"ID":"20240201213424-0i793dg","Type":"NodeParagraph","Properties":{"id":"20240201213424-0i793dg","updated":"20240201213424"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Hash 算法"},{"Type":"NodeText","Data":"？"}]}]},{"ID":"20240201213425-2whzw0u","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213425-2whzw0u","updated":"20240201213425"},"Children":[{"ID":"20240201213426-98j8iiu","Type":"NodeParagraph","Properties":{"id":"20240201213426-98j8iiu","updated":"20240201213426"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Hash 冲突"},{"Type":"NodeText","Data":"如何解决？"}]}]},{"ID":"20240201213427-6gax34e","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213427-6gax34e","updated":"20240201213427"},"Children":[{"ID":"20240201213428-xqioqzd","Type":"NodeParagraph","Properties":{"id":"20240201213428-xqioqzd","updated":"20240201213428"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"扩容机制"},{"Type":"NodeText","Data":"？"}]}]},{"ID":"20240201213429-xzoao06","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213429-xzoao06","updated":"20240201213429"},"Children":[{"ID":"20240201213430-cbnok60","Type":"NodeParagraph","Properties":{"id":"20240201213430-cbnok60","updated":"20240201213430"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"过期 key 的清理机制"},{"Type":"NodeText","Data":"？"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"探测式清理"},{"Type":"NodeText","Data":"和"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"启发式清理"},{"Type":"NodeText","Data":"流程？"}]}]},{"ID":"20240201213431-f1cdedt","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213431-f1cdedt","updated":"20240201213431"},"Children":[{"ID":"20240201213432-xq0cjbc","Type":"NodeParagraph","Properties":{"id":"20240201213432-xq0cjbc","updated":"20240201213432"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.set()"},{"Type":"NodeText","Data":"方法实现原理？"}]}]},{"ID":"20240201213433-f56f73t","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213433-f56f73t","updated":"20240201213433"},"Children":[{"ID":"20240201213434-o1yz0x9","Type":"NodeParagraph","Properties":{"id":"20240201213434-o1yz0x9","updated":"20240201213434"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.get()"},{"Type":"NodeText","Data":"方法实现原理？"}]}]},{"ID":"20240201213435-rttmw72","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213435-rttmw72","updated":"20240201213435"},"Children":[{"ID":"20240201213436-hjd9p1m","Type":"NodeParagraph","Properties":{"id":"20240201213436-hjd9p1m","updated":"20240201213436"},"Children":[{"Type":"NodeText","Data":"项目中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"使用情况？遇到的坑？"}]}]},{"ID":"20240201213437-vbd2896","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213437-vbd2896","updated":"20240201213437"},"Children":[{"ID":"20240201213438-8aby6i0","Type":"NodeParagraph","Properties":{"id":"20240201213438-8aby6i0","updated":"20240201213438"},"Children":[{"Type":"NodeText","Data":"……"}]}]}]},{"ID":"20240201213439-za2pea6","Type":"NodeParagraph","Properties":{"id":"20240201213439-za2pea6","updated":"20240201213439"},"Children":[{"Type":"NodeText","Data":"上述的一些问题你是否都已经掌握的很清楚了呢？本文将围绕这些问题使用图文方式来剖析"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"点点滴滴"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213440-140v7ya","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213440-140v7ya","updated":"20240201213440"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"目录"}]},{"ID":"20240201213441-slknil3","Type":"NodeParagraph","Properties":{"id":"20240201213441-slknil3","updated":"20240201213441"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"注明："},{"Type":"NodeText","Data":" 本文源码基于"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"JDK 1.8"}]},{"ID":"20240201213442-aa4p2eg","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213442-aa4p2eg","updated":"20240201213442"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"代码演示"}]},{"ID":"20240201213443-dnlfz8s","Type":"NodeParagraph","Properties":{"id":"20240201213443-dnlfz8s","updated":"20240201213443"},"Children":[{"Type":"NodeText","Data":"我们先看下"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"使用示例："}]},{"ID":"20240201213444-jq1uru8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213444-jq1uru8","updated":"20240201213444"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"public class ThreadLocalTest {\n    private List\u003cString\u003e messages = Lists.newArrayList();\n\n    public static final ThreadLocal\u003cThreadLocalTest\u003e holder = ThreadLocal.withInitial(ThreadLocalTest::new);\n\n    public static void add(String message) {\n        holder.get().messages.add(message);\n    }\n\n    public static List\u003cString\u003e clear() {\n        List\u003cString\u003e messages = holder.get().messages;\n        holder.remove();\n\n        System.out.println(\"size: \" + holder.get().messages.size());\n        return messages;\n    }\n\n    public static void main(String[] args) {\n        ThreadLocalTest.add(\"一枝花算不算浪漫\");\n        System.out.println(holder.get().messages);\n        ThreadLocalTest.clear();\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213445-qa91ltd","Type":"NodeParagraph","Properties":{"id":"20240201213445-qa91ltd","updated":"20240201213445"},"Children":[{"Type":"NodeText","Data":"打印结果："}]},{"ID":"20240201213446-tkonf6e","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213446-tkonf6e","updated":"20240201213446"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"[一枝花算不算浪漫]\nsize: 0\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213447-cx5bu1f","Type":"NodeParagraph","Properties":{"id":"20240201213447-cx5bu1f","updated":"20240201213447"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"对象可以提供线程局部变量，每个线程"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Thread"},{"Type":"NodeText","Data":"拥有一份自己的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"副本变量"},{"Type":"NodeText","Data":"，多个线程互不干扰。"}]},{"ID":"20240201213448-mclbc1h","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213448-mclbc1h","updated":"20240201213448"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"的数据结构"}]},{"ID":"20240201213449-7kpedpc","Type":"NodeParagraph","Properties":{"id":"20240201213449-7kpedpc","updated":"20240201213449"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/2-20240201213826-ni0to2e.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213450-wxpa1yc","Type":"NodeParagraph","Properties":{"id":"20240201213450-wxpa1yc","updated":"20240201213450"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Thread"},{"Type":"NodeText","Data":"类有一个类型为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal.ThreadLocalMap"},{"Type":"NodeText","Data":"的实例变量"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"threadLocals"},{"Type":"NodeText","Data":"，也就是说每个线程有一个自己的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213451-82cccpr","Type":"NodeParagraph","Properties":{"id":"20240201213451-82cccpr","updated":"20240201213451"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"有自己的独立实现，可以简单地将它的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"视作"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"value"},{"Type":"NodeText","Data":"为代码中放入的值（实际上"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"并不是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"本身，而是它的一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"弱引用"},{"Type":"NodeText","Data":"）。"}]},{"ID":"20240201213452-owh768e","Type":"NodeParagraph","Properties":{"id":"20240201213452-owh768e","updated":"20240201213452"},"Children":[{"Type":"NodeText","Data":"每个线程在往"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"里放值的时候，都会往自己的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"里存，读也是以"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"作为引用，在自己的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"map"},{"Type":"NodeText","Data":"里找对应的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"，从而实现了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"线程隔离"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213453-i56oq8t","Type":"NodeParagraph","Properties":{"id":"20240201213453-i56oq8t","updated":"20240201213453"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"有点类似"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"HashMap"},{"Type":"NodeText","Data":"的结构，只是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"HashMap"},{"Type":"NodeText","Data":"是由"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"数组+链表"},{"Type":"NodeText","Data":"实现的，而"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"中并没有"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"链表"},{"Type":"NodeText","Data":"结构。"}]},{"ID":"20240201213454-vjp8hhg","Type":"NodeParagraph","Properties":{"id":"20240201213454-vjp8hhg","updated":"20240201213454"},"Children":[{"Type":"NodeText","Data":"我们还要注意"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"， 它的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal\u0026lt;?\u0026gt; k"},{"Type":"NodeText","Data":" ，继承自"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"WeakReference"},{"Type":"NodeText","Data":"， 也就是我们常说的弱引用类型。"}]},{"ID":"20240201213455-8gqxu7x","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213455-8gqxu7x","updated":"20240201213455"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"GC 之后 key 是否为 null？"}]},{"ID":"20240201213456-3aqp5gm","Type":"NodeParagraph","Properties":{"id":"20240201213456-3aqp5gm","updated":"20240201213456"},"Children":[{"Type":"NodeText","Data":"回应开头的那个问题， "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":" 的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"是弱引用，那么在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal.get()"},{"Type":"NodeText","Data":"的时候，发生"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"GC"},{"Type":"NodeText","Data":"之后，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"是否是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"？"}]},{"ID":"20240201213457-xb9m0a4","Type":"NodeParagraph","Properties":{"id":"20240201213457-xb9m0a4","updated":"20240201213457"},"Children":[{"Type":"NodeText","Data":"为了搞清楚这个问题，我们需要搞清楚"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Java"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"四种引用类型"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213458-ws3mzut","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213458-ws3mzut","updated":"20240201213458"},"Children":[{"ID":"20240201213459-a8seno4","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213459-a8seno4","updated":"20240201213459"},"Children":[{"ID":"20240201213460-jq7jfca","Type":"NodeParagraph","Properties":{"id":"20240201213460-jq7jfca","updated":"20240201213460"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"强引用"},{"Type":"NodeText","Data":"：我们常常 new 出来的对象就是强引用类型，只要强引用存在，垃圾回收器将永远不会回收被引用的对象，哪怕内存不足的时候"}]}]},{"ID":"20240201213461-asinci2","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213461-asinci2","updated":"20240201213461"},"Children":[{"ID":"20240201213462-j65v024","Type":"NodeParagraph","Properties":{"id":"20240201213462-j65v024","updated":"20240201213462"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"软引用"},{"Type":"NodeText","Data":"：使用 SoftReference 修饰的对象被称为软引用，软引用指向的对象在内存要溢出的时候被回收"}]}]},{"ID":"20240201213463-55ict2j","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213463-55ict2j","updated":"20240201213463"},"Children":[{"ID":"20240201213464-qul68fk","Type":"NodeParagraph","Properties":{"id":"20240201213464-qul68fk","updated":"20240201213464"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"弱引用"},{"Type":"NodeText","Data":"：使用 WeakReference 修饰的对象被称为弱引用，只要发生垃圾回收，若这个对象只被弱引用指向，那么就会被回收"}]}]},{"ID":"20240201213465-303vv0x","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20240201213465-303vv0x","updated":"20240201213465"},"Children":[{"ID":"20240201213466-wcaz6f2","Type":"NodeParagraph","Properties":{"id":"20240201213466-wcaz6f2","updated":"20240201213466"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"虚引用"},{"Type":"NodeText","Data":"：虚引用是最弱的引用，在 Java 中使用 PhantomReference 进行定义。虚引用中唯一的作用就是用队列接收对象即将死亡的通知"}]}]}]},{"ID":"20240201213467-xrnyuod","Type":"NodeParagraph","Properties":{"id":"20240201213467-xrnyuod","updated":"20240201213467"},"Children":[{"Type":"NodeText","Data":"接着再来看下代码，我们使用反射的方式来看看"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"GC"},{"Type":"NodeText","Data":"后"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"中的数据情况：(下面代码来源自："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"a","TextMarkAHref":"https://blog.csdn.net/thewindkee/article/details/103726942","TextMarkTextContent":"https://blog.csdn.net/thewindkee/article/details/103726942"},{"Type":"NodeText","Data":" 本地运行演示 GC 回收场景)"}]},{"ID":"20240201213468-v7uq86z","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213468-v7uq86z","updated":"20240201213468"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"public class ThreadLocalDemo {\n\n    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, InterruptedException {\n        Thread t = new Thread(()-\u003etest(\"abc\",false));\n        t.start();\n        t.join();\n        System.out.println(\"--gc后--\");\n        Thread t2 = new Thread(() -\u003e test(\"def\", true));\n        t2.start();\n        t2.join();\n    }\n\n    private static void test(String s,boolean isGC)  {\n        try {\n            new ThreadLocal\u003c\u003e().set(s);\n            if (isGC) {\n                System.gc();\n            }\n            Thread t = Thread.currentThread();\n            Class\u003c? extends Thread\u003e clz = t.getClass();\n            Field field = clz.getDeclaredField(\"threadLocals\");\n            field.setAccessible(true);\n            Object ThreadLocalMap = field.get(t);\n            Class\u003c?\u003e tlmClass = ThreadLocalMap.getClass();\n            Field tableField = tlmClass.getDeclaredField(\"table\");\n            tableField.setAccessible(true);\n            Object[] arr = (Object[]) tableField.get(ThreadLocalMap);\n            for (Object o : arr) {\n                if (o != null) {\n                    Class\u003c?\u003e entryClass = o.getClass();\n                    Field valueField = entryClass.getDeclaredField(\"value\");\n                    Field referenceField = entryClass.getSuperclass().getSuperclass().getDeclaredField(\"referent\");\n                    valueField.setAccessible(true);\n                    referenceField.setAccessible(true);\n                    System.out.println(String.format(\"弱引用key:%s,值:%s\", referenceField.get(o), valueField.get(o)));\n                }\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213469-zhjfrtt","Type":"NodeParagraph","Properties":{"id":"20240201213469-zhjfrtt","updated":"20240201213469"},"Children":[{"Type":"NodeText","Data":"结果如下："}]},{"ID":"20240201213470-4naefis","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213470-4naefis","updated":"20240201213470"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"弱引用key:java.lang.ThreadLocal@433619b6,值:abc\n弱引用key:java.lang.ThreadLocal@418a15e3,值:java.lang.ref.SoftReference@bf97a12\n--gc后--\n弱引用key:null,值:def\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213471-k7zoitr","Type":"NodeParagraph","Properties":{"id":"20240201213471-k7zoitr","updated":"20240201213471"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/3-20240201213826-wjzwlx0.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213472-w3mubil","Type":"NodeParagraph","Properties":{"id":"20240201213472-w3mubil","updated":"20240201213472"},"Children":[{"Type":"NodeText","Data":"如图所示，因为这里创建的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"并没有指向任何值，也就是没有任何引用："}]},{"ID":"20240201213473-x2re8m4","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213473-x2re8m4","updated":"20240201213473"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"new ThreadLocal\u003c\u003e().set(s);\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213474-oghhxys","Type":"NodeParagraph","Properties":{"id":"20240201213474-oghhxys","updated":"20240201213474"},"Children":[{"Type":"NodeText","Data":"所以这里在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"GC"},{"Type":"NodeText","Data":"之后，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"就会被回收，我们看到上面"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"debug"},{"Type":"NodeText","Data":"中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"referent=null"},{"Type":"NodeText","Data":", 如果"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"改动一下代码："}]},{"ID":"20240201213475-6t0wwyv","Type":"NodeParagraph","Properties":{"id":"20240201213475-6t0wwyv","updated":"20240201213475"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/4-20240201213826-yxisyg6.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213476-bdv9dpo","Type":"NodeParagraph","Properties":{"id":"20240201213476-bdv9dpo","updated":"20240201213476"},"Children":[{"Type":"NodeText","Data":"这个问题刚开始看，如果没有过多思考，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"弱引用"},{"Type":"NodeText","Data":"，还有"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"垃圾回收"},{"Type":"NodeText","Data":"，那么肯定会觉得是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213477-3zwg1i8","Type":"NodeParagraph","Properties":{"id":"20240201213477-3zwg1i8","updated":"20240201213477"},"Children":[{"Type":"NodeText","Data":"其实是不对的，因为题目说的是在做 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal.get()"},{"Type":"NodeText","Data":" 操作，证明其实还是有"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"强引用"},{"Type":"NodeText","Data":"存在的，所以 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":" 并不为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"，如下图所示，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"强引用"},{"Type":"NodeText","Data":"仍然是存在的。"}]},{"ID":"20240201213478-prr7nkq","Type":"NodeParagraph","Properties":{"id":"20240201213478-prr7nkq","updated":"20240201213478"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/5-20240201213826-8j42tg7.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213479-eq0q6or","Type":"NodeParagraph","Properties":{"id":"20240201213479-eq0q6or","updated":"20240201213479"},"Children":[{"Type":"NodeText","Data":"如果我们的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"强引用"},{"Type":"NodeText","Data":"不存在的话，那么 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":" 就会被回收，也就是会出现我们 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"value"},{"Type":"NodeText","Data":" 没被回收，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":" 被回收，导致 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"value"},{"Type":"NodeText","Data":" 永远存在，出现内存泄漏。"}]},{"ID":"20240201213480-o5r0tr0","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213480-o5r0tr0","updated":"20240201213480"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal.set()"},{"Type":"NodeText","Data":"方法源码详解"}]},{"ID":"20240201213481-eibnr1l","Type":"NodeParagraph","Properties":{"id":"20240201213481-eibnr1l","updated":"20240201213481"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/6-20240201213826-bdkqtbd.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213482-6kwcsj2","Type":"NodeParagraph","Properties":{"id":"20240201213482-6kwcsj2","updated":"20240201213482"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"方法原理如上图所示，很简单，主要是判断"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"是否存在，然后使用"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"方法进行数据处理。"}]},{"ID":"20240201213483-bddb6fw","Type":"NodeParagraph","Properties":{"id":"20240201213483-bddb6fw","updated":"20240201213483"},"Children":[{"Type":"NodeText","Data":"代码如下："}]},{"ID":"20240201213484-4h54ey8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213484-4h54ey8","updated":"20240201213484"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"public void set(T value) {\n    Thread t = Thread.currentThread();\n    ThreadLocalMap map = getMap(t);\n    if (map != null)\n        map.set(this, value);\n    else\n        createMap(t, value);\n}\n\nvoid createMap(Thread t, T firstValue) {\n    t.threadLocals = new ThreadLocalMap(this, firstValue);\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213485-yw71p4n","Type":"NodeParagraph","Properties":{"id":"20240201213485-yw71p4n","updated":"20240201213485"},"Children":[{"Type":"NodeText","Data":"主要的核心逻辑还是在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"中的，一步步往下看，后面还有更详细的剖析。"}]},{"ID":"20240201213486-i3el1xg","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213486-i3el1xg","updated":"20240201213486"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":" Hash 算法"}]},{"ID":"20240201213487-hgqonfi","Type":"NodeParagraph","Properties":{"id":"20240201213487-hgqonfi","updated":"20240201213487"},"Children":[{"Type":"NodeText","Data":"既然是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Map"},{"Type":"NodeText","Data":"结构，那么"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"当然也要实现自己的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"算法来解决散列表数组冲突问题。"}]},{"ID":"20240201213488-3sgd2rp","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213488-3sgd2rp","updated":"20240201213488"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"int i = key.threadLocalHashCode \u0026 (len-1);\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213489-63915ds","Type":"NodeParagraph","Properties":{"id":"20240201213489-63915ds","updated":"20240201213489"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"算法很简单，这里"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"i"},{"Type":"NodeText","Data":"就是当前 key 在散列表中对应的数组下标位置。"}]},{"ID":"20240201213490-kgkptqs","Type":"NodeParagraph","Properties":{"id":"20240201213490-kgkptqs","updated":"20240201213490"},"Children":[{"Type":"NodeText","Data":"这里最关键的就是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"threadLocalHashCode"},{"Type":"NodeText","Data":"值的计算，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"中有一个属性为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"HASH_INCREMENT = 0x61c88647"}]},{"ID":"20240201213491-tu4j5ax","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213491-tu4j5ax","updated":"20240201213491"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"public class ThreadLocal\u003cT\u003e {\n    private final int threadLocalHashCode = nextHashCode();\n\n    private static AtomicInteger nextHashCode = new AtomicInteger();\n\n    private static final int HASH_INCREMENT = 0x61c88647;\n\n    private static int nextHashCode() {\n        return nextHashCode.getAndAdd(HASH_INCREMENT);\n    }\n\n    static class ThreadLocalMap {\n        ThreadLocalMap(ThreadLocal\u003c?\u003e firstKey, Object firstValue) {\n            table = new Entry[INITIAL_CAPACITY];\n            int i = firstKey.threadLocalHashCode \u0026 (INITIAL_CAPACITY - 1);\n\n            table[i] = new Entry(firstKey, firstValue);\n            size = 1;\n            setThreshold(INITIAL_CAPACITY);\n        }\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213492-ecbrh7k","Type":"NodeParagraph","Properties":{"id":"20240201213492-ecbrh7k","updated":"20240201213492"},"Children":[{"Type":"NodeText","Data":"每当创建一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"对象，这个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal.nextHashCode"},{"Type":"NodeText","Data":" 这个值就会增长 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"0x61c88647"},{"Type":"NodeText","Data":" 。"}]},{"ID":"20240201213493-j2zhp7t","Type":"NodeParagraph","Properties":{"id":"20240201213493-j2zhp7t","updated":"20240201213493"},"Children":[{"Type":"NodeText","Data":"这个值很特殊，它是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"斐波那契数"},{"Type":"NodeText","Data":" 也叫 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"黄金分割数"},{"Type":"NodeText","Data":"。"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"增量为 这个数字，带来的好处就是 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":" "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"分布非常均匀"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213494-279rcfl","Type":"NodeParagraph","Properties":{"id":"20240201213494-279rcfl","updated":"20240201213494"},"Children":[{"Type":"NodeText","Data":"我们自己可以尝试下："}]},{"ID":"20240201213495-cpmrkt8","Type":"NodeParagraph","Properties":{"id":"20240201213495-cpmrkt8","updated":"20240201213495"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/8-20240201213826-5htae4d.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213496-1y8z73v","Type":"NodeParagraph","Properties":{"id":"20240201213496-1y8z73v","updated":"20240201213496"},"Children":[{"Type":"NodeText","Data":"可以看到产生的哈希码分布很均匀，这里不去细纠"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"斐波那契"},{"Type":"NodeText","Data":"具体算法，感兴趣的可以自行查阅相关资料。"}]},{"ID":"20240201213497-unxhuvv","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213497-unxhuvv","updated":"20240201213497"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":" Hash 冲突"}]},{"ID":"20240201213498-avmrami","Type":"NodeBlockquote","Properties":{"id":"20240201213498-avmrami","updated":"20240201213498"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e ","Properties":{"id":""}},{"ID":"20240201213499-yhfjf1d","Type":"NodeParagraph","Properties":{"id":"20240201213499-yhfjf1d","updated":"20240201213499"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"注明："},{"Type":"NodeText","Data":" 下面所有示例图中，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"绿色块"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"代表"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"正常数据"},{"Type":"NodeText","Data":"，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"灰色块"},{"Type":"NodeText","Data":"代表"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"已被垃圾回收"},{"Type":"NodeText","Data":"。"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"白色块"},{"Type":"NodeText","Data":"表示"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"。"}]}]},{"ID":"20240201213500-idvmmz9","Type":"NodeParagraph","Properties":{"id":"20240201213500-idvmmz9","updated":"20240201213500"},"Children":[{"Type":"NodeText","Data":"虽然"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"中使用了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"黄金分割数"},{"Type":"NodeText","Data":"来作为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"计算因子，大大减少了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Hash"},{"Type":"NodeText","Data":"冲突的概率，但是仍然会存在冲突。"}]},{"ID":"20240201213501-mcmr97z","Type":"NodeParagraph","Properties":{"id":"20240201213501-mcmr97z","updated":"20240201213501"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"HashMap"},{"Type":"NodeText","Data":"中解决冲突的方法是在数组上构造一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"链表"},{"Type":"NodeText","Data":"结构，冲突的数据挂载到链表上，如果链表长度超过一定数量则会转化成"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"红黑树"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213502-9uslviq","Type":"NodeParagraph","Properties":{"id":"20240201213502-9uslviq","updated":"20240201213502"},"Children":[{"Type":"NodeText","Data":"而 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":" 中并没有链表结构，所以这里不能使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"HashMap"},{"Type":"NodeText","Data":" 解决冲突的方式了。"}]},{"ID":"20240201213503-yaxe9u5","Type":"NodeParagraph","Properties":{"id":"20240201213503-yaxe9u5","updated":"20240201213503"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/7-20240201213826-zu72zqd.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213504-ywfg6fg","Type":"NodeParagraph","Properties":{"id":"20240201213504-ywfg6fg","updated":"20240201213504"},"Children":[{"Type":"NodeText","Data":"如上图所示，如果我们插入一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"value=27"},{"Type":"NodeText","Data":"的数据，通过 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":" 计算后应该落入槽位 4 中，而槽位 4 已经有了 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":" 数据。"}]},{"ID":"20240201213505-2xrfkob","Type":"NodeParagraph","Properties":{"id":"20240201213505-2xrfkob","updated":"20240201213505"},"Children":[{"Type":"NodeText","Data":"此时就会线性向后查找，一直找到 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":" 为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":" 的槽位才会停止查找，将当前元素放入此槽位中。当然迭代过程中还有其他的情况，比如遇到了 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":" 不为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":" 且 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":" 值相等的情况，还有 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":" 中的 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":" 值为 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":" 的情况等等都会有不同的处理，后面会一一详细讲解。"}]},{"ID":"20240201213506-ke2q6ip","Type":"NodeParagraph","Properties":{"id":"20240201213506-ke2q6ip","updated":"20240201213506"},"Children":[{"Type":"NodeText","Data":"这里还画了一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的数据（"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Entry=2 的灰色块数据"},{"Type":"NodeText","Data":"），因为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"弱引用"},{"Type":"NodeText","Data":"类型，所以会有这种数据存在。在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"过程中，如果遇到了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"过期的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据，实际上是会进行一轮"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"探测式清理"},{"Type":"NodeText","Data":"操作的，具体操作方式后面会讲到。"}]},{"ID":"20240201213507-l7arpno","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213507-l7arpno","updated":"20240201213507"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.set()"},{"Type":"NodeText","Data":"详解"}]},{"ID":"20240201213508-0uz5uzg","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213508-0uz5uzg","updated":"20240201213508"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.set()"},{"Type":"NodeText","Data":"原理图解"}]},{"ID":"20240201213509-8ii9z25","Type":"NodeParagraph","Properties":{"id":"20240201213509-8ii9z25","updated":"20240201213509"},"Children":[{"Type":"NodeText","Data":"看完了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":" "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"hash 算法"},{"Type":"NodeText","Data":"后，我们再来看"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"是如何实现的。"}]},{"ID":"20240201213510-10la3zz","Type":"NodeParagraph","Properties":{"id":"20240201213510-10la3zz","updated":"20240201213510"},"Children":[{"Type":"NodeText","Data":"往"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"数据（"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"新增"},{"Type":"NodeText","Data":"或者"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"更新"},{"Type":"NodeText","Data":"数据）分为好几种情况，针对不同的情况我们画图来说明。"}]},{"ID":"20240201213511-tiwxxqn","Type":"NodeParagraph","Properties":{"id":"20240201213511-tiwxxqn","updated":"20240201213511"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"第一种情况："},{"Type":"NodeText","Data":" 通过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"计算后的槽位对应的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据为空："}]},{"ID":"20240201213512-5stk8l2","Type":"NodeParagraph","Properties":{"id":"20240201213512-5stk8l2","updated":"20240201213512"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/9-20240201213826-gnhfpl0.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213513-yfp6huf","Type":"NodeParagraph","Properties":{"id":"20240201213513-yfp6huf","updated":"20240201213513"},"Children":[{"Type":"NodeText","Data":"这里直接将数据放到该槽位即可。"}]},{"ID":"20240201213514-6gu7g2b","Type":"NodeParagraph","Properties":{"id":"20240201213514-6gu7g2b","updated":"20240201213514"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"第二种情况："},{"Type":"NodeText","Data":" 槽位数据不为空，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值与当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"通过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"计算获取的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值一致："}]},{"ID":"20240201213515-07bzhde","Type":"NodeParagraph","Properties":{"id":"20240201213515-07bzhde","updated":"20240201213515"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/10-20240201213826-xnjwsbv.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213516-y0r6d0a","Type":"NodeParagraph","Properties":{"id":"20240201213516-y0r6d0a","updated":"20240201213516"},"Children":[{"Type":"NodeText","Data":"这里直接更新该槽位的数据。"}]},{"ID":"20240201213517-2mi3upy","Type":"NodeParagraph","Properties":{"id":"20240201213517-2mi3upy","updated":"20240201213517"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"第三种情况："},{"Type":"NodeText","Data":" 槽位数据不为空，往后遍历过程中，在找到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的槽位之前，没有遇到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"过期的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213518-hu4tprn","Type":"NodeParagraph","Properties":{"id":"20240201213518-hu4tprn","updated":"20240201213518"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/11-20240201213826-f9hr9ms.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213519-fnhibcv","Type":"NodeParagraph","Properties":{"id":"20240201213519-fnhibcv","updated":"20240201213519"},"Children":[{"Type":"NodeText","Data":"遍历散列数组，线性往后查找，如果找到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的槽位，则将数据放入该槽位中，或者往后遍历过程中，遇到了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"key 值相等"},{"Type":"NodeText","Data":"的数据，直接更新即可。"}]},{"ID":"20240201213520-qnpwawd","Type":"NodeParagraph","Properties":{"id":"20240201213520-qnpwawd","updated":"20240201213520"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"第四种情况："},{"Type":"NodeText","Data":" 槽位数据不为空，往后遍历过程中，在找到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的槽位之前，遇到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"过期的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"，如下图，往后遍历过程中，遇到了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=7"},{"Type":"NodeText","Data":"的槽位数据"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key=null"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213521-va3gs11","Type":"NodeParagraph","Properties":{"id":"20240201213521-va3gs11","updated":"20240201213521"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/12-20240201213826-b9b8qod.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213522-vqfozn6","Type":"NodeParagraph","Properties":{"id":"20240201213522-vqfozn6","updated":"20240201213522"},"Children":[{"Type":"NodeText","Data":"散列数组下标为 7 位置对应的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"，表明此数据"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值已经被垃圾回收掉了，此时就会执行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"replaceStaleEntry()"},{"Type":"NodeText","Data":"方法，该方法含义是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"替换过期数据的逻辑"},{"Type":"NodeText","Data":"，以"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"index=7"},{"Type":"NodeText","Data":"位起点开始遍历，进行探测式数据清理工作。"}]},{"ID":"20240201213523-nhlw6k9","Type":"NodeParagraph","Properties":{"id":"20240201213523-nhlw6k9","updated":"20240201213523"},"Children":[{"Type":"NodeText","Data":"初始化探测式清理过期数据扫描的开始位置："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge = staleSlot = 7"}]},{"ID":"20240201213524-2o5hm24","Type":"NodeParagraph","Properties":{"id":"20240201213524-2o5hm24","updated":"20240201213524"},"Children":[{"Type":"NodeText","Data":"以当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"开始 向前迭代查找，找其他过期的数据，然后更新过期数据起始扫描下标"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge"},{"Type":"NodeText","Data":"。"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"for"},{"Type":"NodeText","Data":"循环迭代，直到碰到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"结束。"}]},{"ID":"20240201213525-07barnh","Type":"NodeParagraph","Properties":{"id":"20240201213525-07barnh","updated":"20240201213525"},"Children":[{"Type":"NodeText","Data":"如果找到了过期的数据，继续向前迭代，直到遇到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry=null"},{"Type":"NodeText","Data":"的槽位才停止迭代，如下图所示，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"slotToExpunge 被更新为 0"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213526-awu4j6d","Type":"NodeParagraph","Properties":{"id":"20240201213526-awu4j6d","updated":"20240201213526"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/13-20240201213826-ol3u2oh.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213527-tdthjqg","Type":"NodeParagraph","Properties":{"id":"20240201213527-tdthjqg","updated":"20240201213527"},"Children":[{"Type":"NodeText","Data":"以当前节点("},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=7"},{"Type":"NodeText","Data":")向前迭代，检测是否有过期的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据，如果有则更新"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge"},{"Type":"NodeText","Data":"值。碰到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"则结束探测。以上图为例"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge"},{"Type":"NodeText","Data":"被更新为 0。"}]},{"ID":"20240201213528-whitees","Type":"NodeParagraph","Properties":{"id":"20240201213528-whitees","updated":"20240201213528"},"Children":[{"Type":"NodeText","Data":"上面向前迭代的操作是为了更新探测清理过期数据的起始下标"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge"},{"Type":"NodeText","Data":"的值，这个值在后面会讲解，它是用来判断当前过期槽位"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"之前是否还有过期元素。"}]},{"ID":"20240201213529-vbctzal","Type":"NodeParagraph","Properties":{"id":"20240201213529-vbctzal","updated":"20240201213529"},"Children":[{"Type":"NodeText","Data":"接着开始以"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"位置("},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=7"},{"Type":"NodeText","Data":")向后迭代，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"如果找到了相同 key 值的 Entry 数据："}]},{"ID":"20240201213530-4fax4kt","Type":"NodeParagraph","Properties":{"id":"20240201213530-4fax4kt","updated":"20240201213530"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/14-20240201213826-i4rhh4v.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213531-mxtbwol","Type":"NodeParagraph","Properties":{"id":"20240201213531-mxtbwol","updated":"20240201213531"},"Children":[{"Type":"NodeText","Data":"从当前节点"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"向后查找"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值相等的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"元素，找到后更新"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"的值并交换"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"元素的位置("},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"位置为过期元素)，更新"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据，然后开始进行过期"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"的清理工作，如下图所示："}]},{"ID":"20240201213532-jtb1t7k","Type":"NodeParagraph","Properties":{"id":"20240201213532-jtb1t7k","updated":"20240201213532"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"https://oss.javaguide.cn/java-guide-blog/view.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]},{"Type":"NodeText","Data":"向后遍历过程中，如果没有找到相同 key 值的 Entry 数据："}]},{"ID":"20240201213533-xkfogio","Type":"NodeParagraph","Properties":{"id":"20240201213533-xkfogio","updated":"20240201213533"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/15-20240201213826-l0y3gxg.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213534-77mjp6q","Type":"NodeParagraph","Properties":{"id":"20240201213534-77mjp6q","updated":"20240201213534"},"Children":[{"Type":"NodeText","Data":"从当前节点"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"向后查找"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值相等的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"元素，直到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"则停止寻找。通过上图可知，此时"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"table"},{"Type":"NodeText","Data":"中没有"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值相同的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213535-tfqrv05","Type":"NodeParagraph","Properties":{"id":"20240201213535-tfqrv05","updated":"20240201213535"},"Children":[{"Type":"NodeText","Data":"创建新的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"，替换"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"table[stableSlot]"},{"Type":"NodeText","Data":"位置："}]},{"ID":"20240201213536-a7hxwyi","Type":"NodeParagraph","Properties":{"id":"20240201213536-a7hxwyi","updated":"20240201213536"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/16-20240201213827-7j9cbhz.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213537-6buvclr","Type":"NodeParagraph","Properties":{"id":"20240201213537-6buvclr","updated":"20240201213537"},"Children":[{"Type":"NodeText","Data":"替换完成后也是进行过期元素清理工作，清理工作主要是有两个方法："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"expungeStaleEntry()"},{"Type":"NodeText","Data":"和"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"cleanSomeSlots()"},{"Type":"NodeText","Data":"，具体细节后面会讲到，请继续往后看。"}]},{"ID":"20240201213538-10iywvf","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213538-10iywvf","updated":"20240201213538"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.set()"},{"Type":"NodeText","Data":"源码详解"}]},{"ID":"20240201213539-5arlrnk","Type":"NodeParagraph","Properties":{"id":"20240201213539-5arlrnk","updated":"20240201213539"},"Children":[{"Type":"NodeText","Data":"上面已经用图的方式解析了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set()"},{"Type":"NodeText","Data":"实现的原理，其实已经很清晰了，我们接着再看下源码："}]},{"ID":"20240201213540-jrjptt9","Type":"NodeParagraph","Properties":{"id":"20240201213540-jrjptt9","updated":"20240201213540"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"java.lang.ThreadLocal"},{"Type":"NodeText","Data":"."},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.set()"},{"Type":"NodeText","Data":":"}]},{"ID":"20240201213541-58z8ihw","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213541-58z8ihw","updated":"20240201213541"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private void set(ThreadLocal\u003c?\u003e key, Object value) {\n    Entry[] tab = table;\n    int len = tab.length;\n    int i = key.threadLocalHashCode \u0026 (len-1);\n\n    for (Entry e = tab[i];\n         e != null;\n         e = tab[i = nextIndex(i, len)]) {\n        ThreadLocal\u003c?\u003e k = e.get();\n\n        if (k == key) {\n            e.value = value;\n            return;\n        }\n\n        if (k == null) {\n            replaceStaleEntry(key, value, i);\n            return;\n        }\n    }\n\n    tab[i] = new Entry(key, value);\n    int sz = ++size;\n    if (!cleanSomeSlots(i, sz) \u0026\u0026 sz \u003e= threshold)\n        rehash();\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213542-uyyswn6","Type":"NodeParagraph","Properties":{"id":"20240201213542-uyyswn6","updated":"20240201213542"},"Children":[{"Type":"NodeText","Data":"这里会通过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"来计算在散列表中的对应位置，然后以当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"对应的桶的位置向后查找，找到可以使用的桶。"}]},{"ID":"20240201213543-esrni2h","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213543-esrni2h","updated":"20240201213543"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"Entry[] tab = table;\nint len = tab.length;\nint i = key.threadLocalHashCode \u0026 (len-1);\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213544-2qxgeba","Type":"NodeParagraph","Properties":{"id":"20240201213544-2qxgeba","updated":"20240201213544"},"Children":[{"Type":"NodeText","Data":"什么情况下桶才是可以使用的呢？"}]},{"ID":"20240201213545-tr7r6y3","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213545-tr7r6y3","updated":"20240201213545"},"Children":[{"ID":"20240201213546-4b45jc4","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213546-4b45jc4","updated":"20240201213546"},"Children":[{"ID":"20240201213547-y457b0z","Type":"NodeParagraph","Properties":{"id":"20240201213547-y457b0z","updated":"20240201213547"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"k = key"},{"Type":"NodeText","Data":" 说明是替换操作，可以使用"}]}]},{"ID":"20240201213548-xckysc2","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213548-xckysc2","updated":"20240201213548"},"Children":[{"ID":"20240201213549-dmsixvb","Type":"NodeParagraph","Properties":{"id":"20240201213549-dmsixvb","updated":"20240201213549"},"Children":[{"Type":"NodeText","Data":"碰到一个过期的桶，执行替换逻辑，占用过期桶"}]}]},{"ID":"20240201213550-ilv6m78","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213550-ilv6m78","updated":"20240201213550"},"Children":[{"ID":"20240201213551-gor5zu8","Type":"NodeParagraph","Properties":{"id":"20240201213551-gor5zu8","updated":"20240201213551"},"Children":[{"Type":"NodeText","Data":"查找过程中，碰到桶中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry=null"},{"Type":"NodeText","Data":"的情况，直接使用"}]}]}]},{"ID":"20240201213552-7gbwlhy","Type":"NodeParagraph","Properties":{"id":"20240201213552-7gbwlhy","updated":"20240201213552"},"Children":[{"Type":"NodeText","Data":"接着就是执行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"for"},{"Type":"NodeText","Data":"循环遍历，向后查找，我们先看下"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"nextIndex()"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"prevIndex()"},{"Type":"NodeText","Data":"方法实现："}]},{"ID":"20240201213553-mmrt8p8","Type":"NodeParagraph","Properties":{"id":"20240201213553-mmrt8p8","updated":"20240201213553"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/17-20240201213827-as5jfso.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213554-tvwtlzb","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213554-tvwtlzb","updated":"20240201213554"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private static int nextIndex(int i, int len) {\n    return ((i + 1 \u003c len) ? i + 1 : 0);\n}\n\nprivate static int prevIndex(int i, int len) {\n    return ((i - 1 \u003e= 0) ? i - 1 : len - 1);\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213555-jwpi2qx","Type":"NodeParagraph","Properties":{"id":"20240201213555-jwpi2qx","updated":"20240201213555"},"Children":[{"Type":"NodeText","Data":"接着看剩下"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"for"},{"Type":"NodeText","Data":"循环中的逻辑："}]},{"ID":"20240201213556-brf3e0s","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213556-brf3e0s","updated":"20240201213556"},"Children":[{"ID":"20240201213557-heq2o2l","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20240201213557-heq2o2l","updated":"20240201213557"},"Children":[{"ID":"20240201213558-l2pitz5","Type":"NodeParagraph","Properties":{"id":"20240201213558-l2pitz5","updated":"20240201213558"},"Children":[{"Type":"NodeText","Data":"遍历当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值对应的桶中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据为空，这说明散列数组这里没有数据冲突，跳出"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"for"},{"Type":"NodeText","Data":"循环，直接"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"数据到对应的桶中"}]}]},{"ID":"20240201213559-37q5ljm","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20240201213559-37q5ljm","updated":"20240201213559"},"Children":[{"ID":"20240201213560-suhs2f8","Type":"NodeParagraph","Properties":{"id":"20240201213560-suhs2f8","updated":"20240201213560"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值对应的桶中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据不为空"},{"Type":"NodeHardBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"2.1 如果"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"k = key"},{"Type":"NodeText","Data":"，说明当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"操作是一个替换操作，做替换逻辑，直接返回"},{"Type":"NodeHardBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"2.2 如果"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key = null"},{"Type":"NodeText","Data":"，说明当前桶位置的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"是过期数据，执行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"replaceStaleEntry()"},{"Type":"NodeText","Data":"方法(核心方法)，然后返回"}]}]},{"ID":"20240201213561-jd2dxj5","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20240201213561-jd2dxj5","updated":"20240201213561"},"Children":[{"ID":"20240201213562-e4okr2t","Type":"NodeParagraph","Properties":{"id":"20240201213562-e4okr2t","updated":"20240201213562"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"for"},{"Type":"NodeText","Data":"循环执行完毕，继续往下执行说明向后迭代的过程中遇到了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的情况"},{"Type":"NodeHardBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"3.1 在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的桶中创建一个新的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"对象"},{"Type":"NodeHardBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"3.2 执行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"++size"},{"Type":"NodeText","Data":"操作"}]}]},{"ID":"20240201213563-n49x1cu","Type":"NodeListItem","Data":"4","ListData":{"Typ":1,"Tight":true,"Start":4,"Delimiter":46,"Padding":3,"Marker":"NA==","Num":4},"Properties":{"id":"20240201213563-n49x1cu","updated":"20240201213563"},"Children":[{"ID":"20240201213564-mejy62f","Type":"NodeParagraph","Properties":{"id":"20240201213564-mejy62f","updated":"20240201213564"},"Children":[{"Type":"NodeText","Data":"调用"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"cleanSomeSlots()"},{"Type":"NodeText","Data":"做一次启发式清理工作，清理散列数组中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"过期的数据"},{"Type":"NodeHardBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"4.1 如果清理工作完成后，未清理到任何数据，且"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"size"},{"Type":"NodeText","Data":"超过了阈值(数组长度的 2/3)，进行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash()"},{"Type":"NodeText","Data":"操作"},{"Type":"NodeHardBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"4.2 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash()"},{"Type":"NodeText","Data":"中会先进行一轮探测式清理，清理过期"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"，清理完成后如果"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"size \u0026gt;= threshold - threshold / 4"},{"Type":"NodeText","Data":"，就会执行真正的扩容逻辑(扩容逻辑往后看)"}]}]}]},{"ID":"20240201213565-7uoegru","Type":"NodeParagraph","Properties":{"id":"20240201213565-7uoegru","updated":"20240201213565"},"Children":[{"Type":"NodeText","Data":"接着重点看下"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"replaceStaleEntry()"},{"Type":"NodeText","Data":"方法，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"replaceStaleEntry()"},{"Type":"NodeText","Data":"方法提供替换过期数据的功能，我们可以对应上面"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"第四种情况"},{"Type":"NodeText","Data":"的原理图来再回顾下，具体代码如下："}]},{"ID":"20240201213566-kuqcg5b","Type":"NodeParagraph","Properties":{"id":"20240201213566-kuqcg5b","updated":"20240201213566"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"java.lang.ThreadLocal.ThreadLocalMap.replaceStaleEntry()"},{"Type":"NodeText","Data":":"}]},{"ID":"20240201213567-unha4y0","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213567-unha4y0","updated":"20240201213567"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private void replaceStaleEntry(ThreadLocal\u003c?\u003e key, Object value,\n                                       int staleSlot) {\n    Entry[] tab = table;\n    int len = tab.length;\n    Entry e;\n\n    int slotToExpunge = staleSlot;\n    for (int i = prevIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = prevIndex(i, len))\n\n        if (e.get() == null)\n            slotToExpunge = i;\n\n    for (int i = nextIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = nextIndex(i, len)) {\n\n        ThreadLocal\u003c?\u003e k = e.get();\n\n        if (k == key) {\n            e.value = value;\n\n            tab[i] = tab[staleSlot];\n            tab[staleSlot] = e;\n\n            if (slotToExpunge == staleSlot)\n                slotToExpunge = i;\n            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n            return;\n        }\n\n        if (k == null \u0026\u0026 slotToExpunge == staleSlot)\n            slotToExpunge = i;\n    }\n\n    tab[staleSlot].value = null;\n    tab[staleSlot] = new Entry(key, value);\n\n    if (slotToExpunge != staleSlot)\n        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213568-w4t1b7w","Type":"NodeParagraph","Properties":{"id":"20240201213568-w4t1b7w","updated":"20240201213568"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge"},{"Type":"NodeText","Data":"表示开始探测式清理过期数据的开始下标，默认从当前的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"开始。以当前的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"开始，向前迭代查找，找到没有过期的数据，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"for"},{"Type":"NodeText","Data":"循环一直碰到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"才会结束。如果向前找到了过期数据，更新探测清理过期数据的开始下标为 i，即"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge=i"}]},{"ID":"20240201213569-7i87x1c","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213569-7i87x1c","updated":"20240201213569"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"for (int i = prevIndex(staleSlot, len);\n     (e = tab[i]) != null;\n     i = prevIndex(i, len)){\n\n    if (e.get() == null){\n        slotToExpunge = i;\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213570-pe5xiy9","Type":"NodeParagraph","Properties":{"id":"20240201213570-pe5xiy9","updated":"20240201213570"},"Children":[{"Type":"NodeText","Data":"接着开始从"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"向后查找，也是碰到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的桶结束。"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"如果迭代过程中，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"碰到 k == key"},{"Type":"NodeText","Data":"，这说明这里是替换逻辑，替换新数据并且交换当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"位置。如果"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge == staleSlot"},{"Type":"NodeText","Data":"，这说明"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"replaceStaleEntry()"},{"Type":"NodeText","Data":"一开始向前查找过期数据时并未找到过期的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据，接着向后查找过程中也未发现过期数据，修改开始探测式清理过期数据的下标为当前循环的 index，即"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge = i"},{"Type":"NodeText","Data":"。最后调用"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);"},{"Type":"NodeText","Data":"进行启发式过期数据清理。"}]},{"ID":"20240201213571-v4vprvm","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213571-v4vprvm","updated":"20240201213571"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"if (k == key) {\n    e.value = value;\n\n    tab[i] = tab[staleSlot];\n    tab[staleSlot] = e;\n\n    if (slotToExpunge == staleSlot)\n        slotToExpunge = i;\n\n    cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n    return;\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213572-ucaya7y","Type":"NodeParagraph","Properties":{"id":"20240201213572-ucaya7y","updated":"20240201213572"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"cleanSomeSlots()"},{"Type":"NodeText","Data":"和"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"expungeStaleEntry()"},{"Type":"NodeText","Data":"方法后面都会细讲，这两个是和清理相关的方法，一个是过期"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"相关"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"的启发式清理("},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Heuristically scan"},{"Type":"NodeText","Data":")，另一个是过期"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"相关"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"的探测式清理。"}]},{"ID":"20240201213573-cidnwux","Type":"NodeParagraph","Properties":{"id":"20240201213573-cidnwux","updated":"20240201213573"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"如果 k != key"},{"Type":"NodeText","Data":"则会接着往下走，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"k == null"},{"Type":"NodeText","Data":"说明当前遍历的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"是一个过期数据，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge == staleSlot"},{"Type":"NodeText","Data":"说明，一开始的向前查找数据并未找到过期的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"。如果条件成立，则更新"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slotToExpunge"},{"Type":"NodeText","Data":" 为当前位置，这个前提是前驱节点扫描时未发现过期数据。"}]},{"ID":"20240201213574-9t3w4uo","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213574-9t3w4uo","updated":"20240201213574"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"if (k == null \u0026\u0026 slotToExpunge == staleSlot)\n    slotToExpunge = i;\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213575-wa9vcar","Type":"NodeParagraph","Properties":{"id":"20240201213575-wa9vcar","updated":"20240201213575"},"Children":[{"Type":"NodeText","Data":"往后迭代的过程中如果没有找到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"k == key"},{"Type":"NodeText","Data":"的数据，且碰到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的数据，则结束当前的迭代操作。此时说明这里是一个添加的逻辑，将新的数据添加到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"table[staleSlot]"},{"Type":"NodeText","Data":" 对应的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slot"},{"Type":"NodeText","Data":"中。"}]},{"ID":"20240201213576-5j5zucx","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213576-5j5zucx","updated":"20240201213576"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"tab[staleSlot].value = null;\ntab[staleSlot] = new Entry(key, value);\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213577-rf1vuuz","Type":"NodeParagraph","Properties":{"id":"20240201213577-rf1vuuz","updated":"20240201213577"},"Children":[{"Type":"NodeText","Data":"最后判断除了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"以外，还发现了其他过期的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slot"},{"Type":"NodeText","Data":"数据，就要开启清理数据的逻辑："}]},{"ID":"20240201213578-z0nlusn","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213578-z0nlusn","updated":"20240201213578"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"if (slotToExpunge != staleSlot)\n    cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213579-lor243h","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213579-lor243h","updated":"20240201213579"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"过期 key 的探测式清理流程"}]},{"ID":"20240201213580-bfvmh9t","Type":"NodeParagraph","Properties":{"id":"20240201213580-bfvmh9t","updated":"20240201213580"},"Children":[{"Type":"NodeText","Data":"上面我们有提及"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"的两种过期"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"数据清理方式："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"探测式清理"},{"Type":"NodeText","Data":"和"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"启发式清理"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213581-tv0yo62","Type":"NodeParagraph","Properties":{"id":"20240201213581-tv0yo62","updated":"20240201213581"},"Children":[{"Type":"NodeText","Data":"我们先讲下探测式清理，也就是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"expungeStaleEntry"},{"Type":"NodeText","Data":"方法，遍历散列数组，从开始位置向后探测清理过期数据，将过期数据的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"设置为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"，沿途中碰到未过期的数据则将此数据"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash"},{"Type":"NodeText","Data":"后重新在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"table"},{"Type":"NodeText","Data":"数组中定位，如果定位的位置已经有了数据，则会将未过期的数据放到最靠近此位置的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry=null"},{"Type":"NodeText","Data":"的桶中，使"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash"},{"Type":"NodeText","Data":"后的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据距离正确的桶的位置更近一些。操作逻辑如下："}]},{"ID":"20240201213582-7a17xal","Type":"NodeParagraph","Properties":{"id":"20240201213582-7a17xal","updated":"20240201213582"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/18-20240201213827-a2zryb3.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213583-gfv9gcn","Type":"NodeParagraph","Properties":{"id":"20240201213583-gfv9gcn","updated":"20240201213583"},"Children":[{"Type":"NodeText","Data":"如上图，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set(27)"},{"Type":"NodeText","Data":" 经过 hash 计算后应该落到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=4"},{"Type":"NodeText","Data":"的桶中，由于"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=4"},{"Type":"NodeText","Data":"桶已经有了数据，所以往后迭代最终数据放入到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=7"},{"Type":"NodeText","Data":"的桶中，放入后一段时间后"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=5"},{"Type":"NodeText","Data":"中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"变为了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"}]},{"ID":"20240201213584-hyscryo","Type":"NodeParagraph","Properties":{"id":"20240201213584-hyscryo","updated":"20240201213584"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/19-20240201213827-3unvu48.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213585-w94i81r","Type":"NodeParagraph","Properties":{"id":"20240201213585-w94i81r","updated":"20240201213585"},"Children":[{"Type":"NodeText","Data":"如果再有其他数据"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"map"},{"Type":"NodeText","Data":"中，就会触发"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"探测式清理"},{"Type":"NodeText","Data":"操作。"}]},{"ID":"20240201213586-3ebeeoi","Type":"NodeParagraph","Properties":{"id":"20240201213586-3ebeeoi","updated":"20240201213586"},"Children":[{"Type":"NodeText","Data":"如上图，执行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"探测式清理"},{"Type":"NodeText","Data":"后，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=5"},{"Type":"NodeText","Data":"的数据被清理掉，继续往后迭代，到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=7"},{"Type":"NodeText","Data":"的元素时，经过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash"},{"Type":"NodeText","Data":"后发现该元素正确的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=4"},{"Type":"NodeText","Data":"，而此位置已经有了数据，往后查找离"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=4"},{"Type":"NodeText","Data":"最近的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry=null"},{"Type":"NodeText","Data":"的节点(刚被探测式清理掉的数据："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=5"},{"Type":"NodeText","Data":")，找到后移动"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index= 7"},{"Type":"NodeText","Data":"的数据到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=5"},{"Type":"NodeText","Data":"中，此时桶的位置离正确的位置"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=4"},{"Type":"NodeText","Data":"更近了。"}]},{"ID":"20240201213587-iod37o4","Type":"NodeParagraph","Properties":{"id":"20240201213587-iod37o4","updated":"20240201213587"},"Children":[{"Type":"NodeText","Data":"经过一轮探测式清理后，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"过期的数据会被清理掉，没过期的数据经过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash"},{"Type":"NodeText","Data":"重定位后所处的桶位置理论上更接近"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"i= key.hashCode \u0026amp; (tab.len - 1)"},{"Type":"NodeText","Data":"的位置。这种优化会提高整个散列表查询性能。"}]},{"ID":"20240201213588-63rgnvb","Type":"NodeParagraph","Properties":{"id":"20240201213588-63rgnvb","updated":"20240201213588"},"Children":[{"Type":"NodeText","Data":"接着看下"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"expungeStaleEntry()"},{"Type":"NodeText","Data":"具体流程，我们还是以先原理图后源码讲解的方式来一步步梳理："}]},{"ID":"20240201213589-0chf3bp","Type":"NodeParagraph","Properties":{"id":"20240201213589-0chf3bp","updated":"20240201213589"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/20-20240201213827-jqqt1ml.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213590-k975aiu","Type":"NodeParagraph","Properties":{"id":"20240201213590-k975aiu","updated":"20240201213590"},"Children":[{"Type":"NodeText","Data":"我们假设"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"expungeStaleEntry(3)"},{"Type":"NodeText","Data":" 来调用此方法，如上图所示，我们可以看到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"table"},{"Type":"NodeText","Data":"的数据情况，接着执行清理操作："}]},{"ID":"20240201213591-cm82rpl","Type":"NodeParagraph","Properties":{"id":"20240201213591-cm82rpl","updated":"20240201213591"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/21-20240201213827-z6x1gsi.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213592-4rh8q0t","Type":"NodeParagraph","Properties":{"id":"20240201213592-4rh8q0t","updated":"20240201213592"},"Children":[{"Type":"NodeText","Data":"第一步是清空当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"位置的数据，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=3"},{"Type":"NodeText","Data":"位置的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"变成了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"。然后接着往后探测："}]},{"ID":"20240201213593-ls8hgro","Type":"NodeParagraph","Properties":{"id":"20240201213593-ls8hgro","updated":"20240201213593"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/22-20240201213827-xfm6lrm.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213594-ke4vxxy","Type":"NodeParagraph","Properties":{"id":"20240201213594-ke4vxxy","updated":"20240201213594"},"Children":[{"Type":"NodeText","Data":"执行完第二步后，index=4 的元素挪到 index=3 的槽位中。"}]},{"ID":"20240201213595-h3gske0","Type":"NodeParagraph","Properties":{"id":"20240201213595-h3gske0","updated":"20240201213595"},"Children":[{"Type":"NodeText","Data":"继续往后迭代检查，碰到正常数据，计算该数据位置是否偏移，如果被偏移，则重新计算"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slot"},{"Type":"NodeText","Data":"位置，目的是让正常数据尽可能存放在正确位置或离正确位置更近的位置"}]},{"ID":"20240201213596-6ugvzab","Type":"NodeParagraph","Properties":{"id":"20240201213596-6ugvzab","updated":"20240201213596"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/23-20240201213827-53lh5rp.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213597-diy7ziu","Type":"NodeParagraph","Properties":{"id":"20240201213597-diy7ziu","updated":"20240201213597"},"Children":[{"Type":"NodeText","Data":"在往后迭代的过程中碰到空的槽位，终止探测，这样一轮探测式清理工作就完成了，接着我们继续看看具体"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"实现源代码"},{"Type":"NodeText","Data":"："}]},{"ID":"20240201213598-5bu2fu4","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213598-5bu2fu4","updated":"20240201213598"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private int expungeStaleEntry(int staleSlot) {\n    Entry[] tab = table;\n    int len = tab.length;\n\n    tab[staleSlot].value = null;\n    tab[staleSlot] = null;\n    size--;\n\n    Entry e;\n    int i;\n    for (i = nextIndex(staleSlot, len);\n         (e = tab[i]) != null;\n         i = nextIndex(i, len)) {\n        ThreadLocal\u003c?\u003e k = e.get();\n        if (k == null) {\n            e.value = null;\n            tab[i] = null;\n            size--;\n        } else {\n            int h = k.threadLocalHashCode \u0026 (len - 1);\n            if (h != i) {\n                tab[i] = null;\n\n                while (tab[h] != null)\n                    h = nextIndex(h, len);\n                tab[h] = e;\n            }\n        }\n    }\n    return i;\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213599-bkg3ujt","Type":"NodeParagraph","Properties":{"id":"20240201213599-bkg3ujt","updated":"20240201213599"},"Children":[{"Type":"NodeText","Data":"这里我们还是以"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot=3"},{"Type":"NodeText","Data":" 来做示例说明，首先是将"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"tab[staleSlot]"},{"Type":"NodeText","Data":"槽位的数据清空，然后设置"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"size--"},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeText","Data":"接着以"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"staleSlot"},{"Type":"NodeText","Data":"位置往后迭代，如果遇到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"k==null"},{"Type":"NodeText","Data":"的过期数据，也是清空该槽位数据，然后"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"size--"}]},{"ID":"20240201213600-zqqe3vb","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213600-zqqe3vb","updated":"20240201213600"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"ThreadLocal\u003c?\u003e k = e.get();\n\nif (k == null) {\n    e.value = null;\n    tab[i] = null;\n    size--;\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213601-yhuc9sr","Type":"NodeParagraph","Properties":{"id":"20240201213601-yhuc9sr","updated":"20240201213601"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"没有过期，重新计算当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"的下标位置是不是当前槽位下标位置，如果不是，那么说明产生了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"冲突，此时以新计算出来正确的槽位位置往后迭代，找到最近一个可以存放"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"entry"},{"Type":"NodeText","Data":"的位置。"}]},{"ID":"20240201213602-o9xhl0k","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213602-o9xhl0k","updated":"20240201213602"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"int h = k.threadLocalHashCode \u0026 (len - 1);\nif (h != i) {\n    tab[i] = null;\n\n    while (tab[h] != null)\n        h = nextIndex(h, len);\n\n    tab[h] = e;\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213603-4q2pnar","Type":"NodeParagraph","Properties":{"id":"20240201213603-4q2pnar","updated":"20240201213603"},"Children":[{"Type":"NodeText","Data":"这里是处理正常的产生"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Hash"},{"Type":"NodeText","Data":"冲突的数据，经过迭代后，有过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Hash"},{"Type":"NodeText","Data":"冲突数据的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"位置会更靠近正确位置，这样的话，查询的时候 效率才会更高。"}]},{"ID":"20240201213604-v4895eu","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213604-v4895eu","updated":"20240201213604"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"扩容机制"}]},{"ID":"20240201213605-velturp","Type":"NodeParagraph","Properties":{"id":"20240201213605-velturp","updated":"20240201213605"},"Children":[{"Type":"NodeText","Data":"在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.set()"},{"Type":"NodeText","Data":"方法的最后，如果执行完启发式清理工作后，未清理到任何数据，且当前散列数组中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"的数量已经达到了列表的扩容阈值"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"(len*2/3)"},{"Type":"NodeText","Data":"，就开始执行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash()"},{"Type":"NodeText","Data":"逻辑："}]},{"ID":"20240201213606-1bzs6fu","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213606-1bzs6fu","updated":"20240201213606"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"if (!cleanSomeSlots(i, sz) \u0026\u0026 sz \u003e= threshold)\n    rehash();\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213607-cra3u8c","Type":"NodeParagraph","Properties":{"id":"20240201213607-cra3u8c","updated":"20240201213607"},"Children":[{"Type":"NodeText","Data":"接着看下"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash()"},{"Type":"NodeText","Data":"具体实现："}]},{"ID":"20240201213608-1oqeon8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213608-1oqeon8","updated":"20240201213608"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private void rehash() {\n    expungeStaleEntries();\n\n    if (size \u003e= threshold - threshold / 4)\n        resize();\n}\n\nprivate void expungeStaleEntries() {\n    Entry[] tab = table;\n    int len = tab.length;\n    for (int j = 0; j \u003c len; j++) {\n        Entry e = tab[j];\n        if (e != null \u0026\u0026 e.get() == null)\n            expungeStaleEntry(j);\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213609-btuavsg","Type":"NodeParagraph","Properties":{"id":"20240201213609-btuavsg","updated":"20240201213609"},"Children":[{"Type":"NodeText","Data":"这里首先是会进行探测式清理工作，从"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"table"},{"Type":"NodeText","Data":"的起始位置往后清理，上面有分析清理的详细流程。清理完成之后，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"table"},{"Type":"NodeText","Data":"中可能有一些"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据被清理掉，所以此时通过判断"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"size \u0026gt;= threshold - threshold / 4"},{"Type":"NodeText","Data":" 也就是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"size \u0026gt;= threshold * 3/4"},{"Type":"NodeText","Data":" 来决定是否扩容。"}]},{"ID":"20240201213610-6qsf730","Type":"NodeParagraph","Properties":{"id":"20240201213610-6qsf730","updated":"20240201213610"},"Children":[{"Type":"NodeText","Data":"我们还记得上面进行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"rehash()"},{"Type":"NodeText","Data":"的阈值是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"size \u0026gt;= threshold"},{"Type":"NodeText","Data":"，所以当面试官套路我们"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"扩容机制的时候 我们一定要说清楚这两个步骤："}]},{"ID":"20240201213611-pznq4xv","Type":"NodeParagraph","Properties":{"id":"20240201213611-pznq4xv","updated":"20240201213611"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/24-20240201213827-finhqd2.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213612-uyb0ja0","Type":"NodeParagraph","Properties":{"id":"20240201213612-uyb0ja0","updated":"20240201213612"},"Children":[{"Type":"NodeText","Data":"接着看看具体的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"resize()"},{"Type":"NodeText","Data":"方法，为了方便演示，我们以"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"oldTab.len=8"},{"Type":"NodeText","Data":"来举例："}]},{"ID":"20240201213613-9ot97us","Type":"NodeParagraph","Properties":{"id":"20240201213613-9ot97us","updated":"20240201213613"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/25-20240201213827-e4ylc83.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213614-wyyrywe","Type":"NodeParagraph","Properties":{"id":"20240201213614-wyyrywe","updated":"20240201213614"},"Children":[{"Type":"NodeText","Data":"扩容后的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"tab"},{"Type":"NodeText","Data":"的大小为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"oldLen * 2"},{"Type":"NodeText","Data":"，然后遍历老的散列表，重新计算"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"位置，然后放到新的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"tab"},{"Type":"NodeText","Data":"数组中，如果出现"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"冲突则往后寻找最近的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"entry"},{"Type":"NodeText","Data":"为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"的槽位，遍历完成之后，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"oldTab"},{"Type":"NodeText","Data":"中所有的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"entry"},{"Type":"NodeText","Data":"数据都已经放入到新的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"tab"},{"Type":"NodeText","Data":"中了。重新计算"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"tab"},{"Type":"NodeText","Data":"下次扩容的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"阈值"},{"Type":"NodeText","Data":"，具体代码如下："}]},{"ID":"20240201213615-u29ktxf","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213615-u29ktxf","updated":"20240201213615"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private void resize() {\n    Entry[] oldTab = table;\n    int oldLen = oldTab.length;\n    int newLen = oldLen * 2;\n    Entry[] newTab = new Entry[newLen];\n    int count = 0;\n\n    for (int j = 0; j \u003c oldLen; ++j) {\n        Entry e = oldTab[j];\n        if (e != null) {\n            ThreadLocal\u003c?\u003e k = e.get();\n            if (k == null) {\n                e.value = null;\n            } else {\n                int h = k.threadLocalHashCode \u0026 (newLen - 1);\n                while (newTab[h] != null)\n                    h = nextIndex(h, newLen);\n                newTab[h] = e;\n                count++;\n            }\n        }\n    }\n\n    setThreshold(newLen);\n    size = count;\n    table = newTab;\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213616-tzrw6p5","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213616-tzrw6p5","updated":"20240201213616"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.get()"},{"Type":"NodeText","Data":"详解"}]},{"ID":"20240201213617-foxbt4a","Type":"NodeParagraph","Properties":{"id":"20240201213617-foxbt4a","updated":"20240201213617"},"Children":[{"Type":"NodeText","Data":"上面已经看完了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set()"},{"Type":"NodeText","Data":"方法的源码，其中包括"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"set"},{"Type":"NodeText","Data":"数据、清理数据、优化数据桶的位置等操作，接着看看"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"get()"},{"Type":"NodeText","Data":"操作的原理。"}]},{"ID":"20240201213618-k6twvsg","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213618-k6twvsg","updated":"20240201213618"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.get()"},{"Type":"NodeText","Data":"图解"}]},{"ID":"20240201213619-dnekrc4","Type":"NodeParagraph","Properties":{"id":"20240201213619-dnekrc4","updated":"20240201213619"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"第一种情况："},{"Type":"NodeText","Data":" 通过查找"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值计算出散列表中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slot"},{"Type":"NodeText","Data":"位置，然后该"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slot"},{"Type":"NodeText","Data":"位置中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry.key"},{"Type":"NodeText","Data":"和查找的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"一致，则直接返回："}]},{"ID":"20240201213620-f9nmi4z","Type":"NodeParagraph","Properties":{"id":"20240201213620-f9nmi4z","updated":"20240201213620"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/26-20240201213827-rjz03j0.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213621-jzgke9r","Type":"NodeParagraph","Properties":{"id":"20240201213621-jzgke9r","updated":"20240201213621"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"第二种情况："},{"Type":"NodeText","Data":" "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slot"},{"Type":"NodeText","Data":"位置中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry.key"},{"Type":"NodeText","Data":"和要查找的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"不一致："}]},{"ID":"20240201213622-xxwgcc1","Type":"NodeParagraph","Properties":{"id":"20240201213622-xxwgcc1","updated":"20240201213622"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/27-20240201213827-5b5yym5.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213623-o2fgfuq","Type":"NodeParagraph","Properties":{"id":"20240201213623-o2fgfuq","updated":"20240201213623"},"Children":[{"Type":"NodeText","Data":"我们以"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"get(ThreadLocal1)"},{"Type":"NodeText","Data":"为例，通过"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"hash"},{"Type":"NodeText","Data":"计算后，正确的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"slot"},{"Type":"NodeText","Data":"位置应该是 4，而"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=4"},{"Type":"NodeText","Data":"的槽位已经有了数据，且"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值不等于"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal1"},{"Type":"NodeText","Data":"，所以需要继续往后迭代查找。"}]},{"ID":"20240201213624-wvnap8h","Type":"NodeParagraph","Properties":{"id":"20240201213624-wvnap8h","updated":"20240201213624"},"Children":[{"Type":"NodeText","Data":"迭代到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=5"},{"Type":"NodeText","Data":"的数据时，此时"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry.key=null"},{"Type":"NodeText","Data":"，触发一次探测式数据回收操作，执行"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"expungeStaleEntry()"},{"Type":"NodeText","Data":"方法，执行完后，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index 5,8"},{"Type":"NodeText","Data":"的数据都会被回收，而"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index 6,7"},{"Type":"NodeText","Data":"的数据都会前移。"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index 6,7"},{"Type":"NodeText","Data":"前移之后，继续从 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=5"},{"Type":"NodeText","Data":" 往后迭代，于是就在 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"index=6"},{"Type":"NodeText","Data":" 找到了"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"key"},{"Type":"NodeText","Data":"值相等的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":"数据，如下图所示："}]},{"ID":"20240201213625-rjdfzkz","Type":"NodeParagraph","Properties":{"id":"20240201213625-rjdfzkz","updated":"20240201213625"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/28-20240201213827-nvqi09i.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213626-0fahid2","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213626-0fahid2","updated":"20240201213626"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap.get()"},{"Type":"NodeText","Data":"源码详解"}]},{"ID":"20240201213627-fyazmrp","Type":"NodeParagraph","Properties":{"id":"20240201213627-fyazmrp","updated":"20240201213627"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"java.lang.ThreadLocal.ThreadLocalMap.getEntry()"},{"Type":"NodeText","Data":":"}]},{"ID":"20240201213628-6r6m5wd","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213628-6r6m5wd","updated":"20240201213628"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private Entry getEntry(ThreadLocal\u003c?\u003e key) {\n    int i = key.threadLocalHashCode \u0026 (table.length - 1);\n    Entry e = table[i];\n    if (e != null \u0026\u0026 e.get() == key)\n        return e;\n    else\n        return getEntryAfterMiss(key, i, e);\n}\n\nprivate Entry getEntryAfterMiss(ThreadLocal\u003c?\u003e key, int i, Entry e) {\n    Entry[] tab = table;\n    int len = tab.length;\n\n    while (e != null) {\n        ThreadLocal\u003c?\u003e k = e.get();\n        if (k == key)\n            return e;\n        if (k == null)\n            expungeStaleEntry(i);\n        else\n            i = nextIndex(i, len);\n        e = tab[i];\n    }\n    return null;\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213629-8ruj73d","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213629-8ruj73d","updated":"20240201213629"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"过期 key 的启发式清理流程"}]},{"ID":"20240201213630-t0xaeh2","Type":"NodeParagraph","Properties":{"id":"20240201213630-t0xaeh2","updated":"20240201213630"},"Children":[{"Type":"NodeText","Data":"上面多次提及到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocalMap"},{"Type":"NodeText","Data":"过期 key 的两种清理方式："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"探测式清理(expungeStaleEntry())"},{"Type":"NodeText","Data":"、"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"启发式清理(cleanSomeSlots())"}]},{"ID":"20240201213631-se2prka","Type":"NodeParagraph","Properties":{"id":"20240201213631-se2prka","updated":"20240201213631"},"Children":[{"Type":"NodeText","Data":"探测式清理是以当前"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Entry"},{"Type":"NodeText","Data":" 往后清理，遇到值为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"null"},{"Type":"NodeText","Data":"则结束清理，属于"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"线性探测清理"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240201213632-jqk691q","Type":"NodeParagraph","Properties":{"id":"20240201213632-jqk691q","updated":"20240201213632"},"Children":[{"Type":"NodeText","Data":"而启发式清理被作者定义为："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Heuristically scan some cells looking for stale entries"},{"Type":"NodeText","Data":"."}]},{"ID":"20240201213633-e9ue71t","Type":"NodeParagraph","Properties":{"id":"20240201213633-e9ue71t","updated":"20240201213633"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/29-20240201213827-wm3ze0d.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213634-c0hyp23","Type":"NodeParagraph","Properties":{"id":"20240201213634-c0hyp23","updated":"20240201213634"},"Children":[{"Type":"NodeText","Data":"具体代码如下："}]},{"ID":"20240201213635-xyexsd4","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213635-xyexsd4","updated":"20240201213635"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private boolean cleanSomeSlots(int i, int n) {\n    boolean removed = false;\n    Entry[] tab = table;\n    int len = tab.length;\n    do {\n        i = nextIndex(i, len);\n        Entry e = tab[i];\n        if (e != null \u0026\u0026 e.get() == null) {\n            n = len;\n            removed = true;\n            i = expungeStaleEntry(i);\n        }\n    } while ( (n \u003e\u003e\u003e= 1) != 0);\n    return removed;\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213636-vrmtg7l","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213636-vrmtg7l","updated":"20240201213636"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InheritableThreadLocal"}]},{"ID":"20240201213637-r8nfehz","Type":"NodeParagraph","Properties":{"id":"20240201213637-r8nfehz","updated":"20240201213637"},"Children":[{"Type":"NodeText","Data":"我们使用"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"的时候，在异步场景下是无法给子线程共享父线程中创建的线程副本数据的。"}]},{"ID":"20240201213638-9wloshz","Type":"NodeParagraph","Properties":{"id":"20240201213638-9wloshz","updated":"20240201213638"},"Children":[{"Type":"NodeText","Data":"为了解决这个问题，JDK 中还有一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InheritableThreadLocal"},{"Type":"NodeText","Data":"类，我们来看一个例子："}]},{"ID":"20240201213639-hc1lr84","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213639-hc1lr84","updated":"20240201213639"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"public class InheritableThreadLocalDemo {\n    public static void main(String[] args) {\n        ThreadLocal\u003cString\u003e ThreadLocal = new ThreadLocal\u003c\u003e();\n        ThreadLocal\u003cString\u003e inheritableThreadLocal = new InheritableThreadLocal\u003c\u003e();\n        ThreadLocal.set(\"父类数据:threadLocal\");\n        inheritableThreadLocal.set(\"父类数据:inheritableThreadLocal\");\n\n        new Thread(new Runnable() {\n            @Override\n            public void run() {\n                System.out.println(\"子线程获取父类ThreadLocal数据：\" + ThreadLocal.get());\n                System.out.println(\"子线程获取父类inheritableThreadLocal数据：\" + inheritableThreadLocal.get());\n            }\n        }).start();\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213640-v0988ct","Type":"NodeParagraph","Properties":{"id":"20240201213640-v0988ct","updated":"20240201213640"},"Children":[{"Type":"NodeText","Data":"打印结果："}]},{"ID":"20240201213641-rtom2p7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213641-rtom2p7","updated":"20240201213641"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"子线程获取父类ThreadLocal数据：null\n子线程获取父类inheritableThreadLocal数据：父类数据:inheritableThreadLocal\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213642-0zvmbs9","Type":"NodeParagraph","Properties":{"id":"20240201213642-0zvmbs9","updated":"20240201213642"},"Children":[{"Type":"NodeText","Data":"实现原理是子线程是通过在父线程中通过调用"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"new Thread()"},{"Type":"NodeText","Data":"方法来创建子线程，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Thread#init"},{"Type":"NodeText","Data":"方法在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Thread"},{"Type":"NodeText","Data":"的构造方法中被调用。在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"init"},{"Type":"NodeText","Data":"方法中拷贝父线程数据到子线程中："}]},{"ID":"20240201213643-1ddfnmz","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213643-1ddfnmz","updated":"20240201213643"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"private void init(ThreadGroup g, Runnable target, String name,\n                      long stackSize, AccessControlContext acc,\n                      boolean inheritThreadLocals) {\n    if (name == null) {\n        throw new NullPointerException(\"name cannot be null\");\n    }\n\n    if (inheritThreadLocals \u0026\u0026 parent.inheritableThreadLocals != null)\n        this.inheritableThreadLocals =\n            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);\n    this.stackSize = stackSize;\n    tid = nextThreadID();\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213644-b7f2l3x","Type":"NodeParagraph","Properties":{"id":"20240201213644-b7f2l3x","updated":"20240201213644"},"Children":[{"Type":"NodeText","Data":"但"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InheritableThreadLocal"},{"Type":"NodeText","Data":"仍然有缺陷，一般我们做异步化处理都是使用的线程池，而"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"InheritableThreadLocal"},{"Type":"NodeText","Data":"是在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"new Thread"},{"Type":"NodeText","Data":"中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"init()"},{"Type":"NodeText","Data":"方法给赋值的，而线程池是线程复用的逻辑，所以这里会存在问题。"}]},{"ID":"20240201213645-wjihhor","Type":"NodeParagraph","Properties":{"id":"20240201213645-wjihhor","updated":"20240201213645"},"Children":[{"Type":"NodeText","Data":"当然，有问题出现就会有解决问题的方案，阿里巴巴开源了一个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"TransmittableThreadLocal"},{"Type":"NodeText","Data":"组件就可以解决这个问题，这里就不再延伸，感兴趣的可自行查阅资料。"}]},{"ID":"20240201213646-932t7rc","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240201213646-932t7rc","updated":"20240201213646"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"项目中使用实战"}]},{"ID":"20240201213647-87i0mws","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213647-87i0mws","updated":"20240201213647"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"使用场景"}]},{"ID":"20240201213648-4cikqwq","Type":"NodeParagraph","Properties":{"id":"20240201213648-4cikqwq","updated":"20240201213648"},"Children":[{"Type":"NodeText","Data":"我们现在项目中日志记录用的是"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ELK+Logstash"},{"Type":"NodeText","Data":"，最后在"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Kibana"},{"Type":"NodeText","Data":"中进行展示和检索。"}]},{"ID":"20240201213649-khp87hb","Type":"NodeParagraph","Properties":{"id":"20240201213649-khp87hb","updated":"20240201213649"},"Children":[{"Type":"NodeText","Data":"现在都是分布式系统统一对外提供服务，项目间调用的关系可以通过 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"traceId"},{"Type":"NodeText","Data":" 来关联，但是不同项目之间如何传递 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"traceId"},{"Type":"NodeText","Data":" 呢？"}]},{"ID":"20240201213650-53utoqg","Type":"NodeParagraph","Properties":{"id":"20240201213650-53utoqg","updated":"20240201213650"},"Children":[{"Type":"NodeText","Data":"这里我们使用 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"org.slf4j.MDC"},{"Type":"NodeText","Data":" 来实现此功能，内部就是通过 "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":" 来实现的，具体实现如下："}]},{"ID":"20240201213651-jn88p81","Type":"NodeParagraph","Properties":{"id":"20240201213651-jn88p81","updated":"20240201213651"},"Children":[{"Type":"NodeText","Data":"当前端发送请求到"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"服务 A"},{"Type":"NodeText","Data":"时，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"服务 A"},{"Type":"NodeText","Data":"会生成一个类似"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"UUID"},{"Type":"NodeText","Data":"的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"traceId"},{"Type":"NodeText","Data":"字符串，将此字符串放入当前线程的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"中，在调用"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"服务 B"},{"Type":"NodeText","Data":"的时候，将"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"traceId"},{"Type":"NodeText","Data":"写入到请求的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Header"},{"Type":"NodeText","Data":"中，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"服务 B"},{"Type":"NodeText","Data":"在接收请求时会先判断请求的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"Header"},{"Type":"NodeText","Data":"中是否有"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"traceId"},{"Type":"NodeText","Data":"，如果存在则写入自己线程的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"中。"}]},{"ID":"20240201213652-o80r84c","Type":"NodeParagraph","Properties":{"id":"20240201213652-o80r84c","updated":"20240201213652"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/30-20240201213827-99ln16a.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213653-c05n0xs","Type":"NodeParagraph","Properties":{"id":"20240201213653-c05n0xs","updated":"20240201213653"},"Children":[{"Type":"NodeText","Data":"图中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"requestId"},{"Type":"NodeText","Data":"即为我们各个系统链路关联的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"traceId"},{"Type":"NodeText","Data":"，系统间互相调用，通过这个"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"requestId"},{"Type":"NodeText","Data":"即可找到对应链路，这里还有会有一些其他场景："}]},{"ID":"20240201213654-hik80zq","Type":"NodeParagraph","Properties":{"id":"20240201213654-hik80zq","updated":"20240201213654"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"assets/31-20240201213827-bazsxmt.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240201213655-t6s98mt","Type":"NodeParagraph","Properties":{"id":"20240201213655-t6s98mt","updated":"20240201213655"},"Children":[{"Type":"NodeText","Data":"针对于这些场景，我们都可以有相应的解决方案，如下所示"}]},{"ID":"20240201213656-e1k3w0f","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213656-e1k3w0f","updated":"20240201213656"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"Feign 远程调用解决方案"}]},{"ID":"20240201213657-gu20udb","Type":"NodeParagraph","Properties":{"id":"20240201213657-gu20udb","updated":"20240201213657"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"服务发送请求："}]},{"ID":"20240201213658-f2cm3wm","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213658-f2cm3wm","updated":"20240201213658"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"@Component\n@Slf4j\npublic class FeignInvokeInterceptor implements RequestInterceptor {\n\n    @Override\n    public void apply(RequestTemplate template) {\n        String requestId = MDC.get(\"requestId\");\n        if (StringUtils.isNotBlank(requestId)) {\n            template.header(\"requestId\", requestId);\n        }\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213659-fynj7n7","Type":"NodeParagraph","Properties":{"id":"20240201213659-fynj7n7","updated":"20240201213659"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"服务接收请求："}]},{"ID":"20240201213660-3dj4i8q","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213660-3dj4i8q","updated":"20240201213660"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"@Slf4j\n@Component\npublic class LogInterceptor extends HandlerInterceptorAdapter {\n\n    @Override\n    public void afterCompletion(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, Exception arg3) {\n        MDC.remove(\"requestId\");\n    }\n\n    @Override\n    public void postHandle(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, ModelAndView arg3) {\n    }\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n\n        String requestId = request.getHeader(BaseConstant.REQUEST_ID_KEY);\n        if (StringUtils.isBlank(requestId)) {\n            requestId = UUID.randomUUID().toString().replace(\"-\", \"\");\n        }\n        MDC.put(\"requestId\", requestId);\n        return true;\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213661-qjqgqe1","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213661-qjqgqe1","updated":"20240201213661"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"线程池异步调用，requestId 传递"}]},{"ID":"20240201213662-33xhx6z","Type":"NodeParagraph","Properties":{"id":"20240201213662-33xhx6z","updated":"20240201213662"},"Children":[{"Type":"NodeText","Data":"因为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"MDC"},{"Type":"NodeText","Data":"是基于"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"去实现的，异步过程中，子线程并没有办法获取到父线程"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"ThreadLocal"},{"Type":"NodeText","Data":"存储的数据，所以这里可以自定义线程池执行器，修改其中的"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"run()"},{"Type":"NodeText","Data":"方法："}]},{"ID":"20240201213663-rkostp3","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"amF2YQ==","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240201213663-rkostp3","updated":"20240201213663"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ==","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"public class MyThreadPoolTaskExecutor extends ThreadPoolTaskExecutor {\n\n    @Override\n    public void execute(Runnable runnable) {\n        Map\u003cString, String\u003e context = MDC.getCopyOfContextMap();\n        super.execute(() -\u003e run(runnable, context));\n    }\n\n    @Override\n    private void run(Runnable runnable, Map\u003cString, String\u003e context) {\n        if (context != null) {\n            MDC.setContextMap(context);\n        }\n        try {\n            runnable.run();\n        } finally {\n            MDC.remove();\n        }\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240201213664-j4y0pqp","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240201213664-j4y0pqp","updated":"20240201213664"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"使用 MQ 发送消息给第三方系统"}]},{"ID":"20240201213665-urbfvoh","Type":"NodeParagraph","Properties":{"id":"20240201213665-urbfvoh","updated":"20240201213665"},"Children":[{"Type":"NodeText","Data":"在 MQ 发送的消息体中自定义属性"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"requestId"},{"Type":"NodeText","Data":"，接收方消费消息后，自己解析"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"requestId"},{"Type":"NodeText","Data":"使用即可。"}]},{"ID":"20240201213666-dr4898v","Type":"NodeHTMLBlock","Data":"\u003cdiv\u003e\n\u003c!-- @include: @article-footer.snippet.md --\u003e\n\u003c/div\u003e","HtmlBlockType":2,"Properties":{"id":"20240201213666-dr4898v","updated":"20240201213666"}}]}